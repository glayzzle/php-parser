// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_stmt_execute_stored_proc.phpt
  it("mysqli_stmt_execute() - Stored Procedures", function () {
    expect(parser.parseCode("<?php\n    require_once('connect.inc');\n    require_once('table.inc');\n    if (!mysqli_query($link, 'DROP PROCEDURE IF EXISTS p'))\n        printf(\"[009] [%d] %s.\\n\", mysqli_errno($link), mysqli_error($link));\n    if (mysqli_real_query($link, 'CREATE PROCEDURE p(OUT ver_param VARCHAR(25)) BEGIN SELECT VERSION() INTO ver_param; END;')) {\n        /* no result set, one output parameter */\n        if (!$stmt = mysqli_prepare($link, 'CALL p(@version)'))\n            printf(\"[011] Cannot prepare CALL, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        if (!mysqli_stmt_execute($stmt))\n            printf(\"[012] Cannot execute CALL, [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        /* yes, I really want to call it twice! */\n        if (!mysqli_stmt_execute($stmt))\n            printf(\"[013] Cannot execute CALL, [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        if (!mysqli_stmt_close($stmt))\n            printf(\"[014] Cannot close statement, [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        if (!$stmt = mysqli_prepare($link, 'SELECT @version AS _version'))\n            printf(\"[015] Cannot prepare SELECT, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        if (!mysqli_stmt_execute($stmt))\n            printf(\"[016] Cannot execute SELECT, [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        $version = 'unknown';\n        if (!mysqli_stmt_bind_result($stmt, $version) ||\n                !mysqli_stmt_fetch($stmt))\n            printf(\"[017] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        if (($version == \"unknown\") || ($version == \"\"))\n            printf(\"[018] Results seem wrong, got %s, [%d] %s\\n\",\n                $version,\n                mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        mysqli_stmt_free_result($stmt);\n        mysqli_stmt_close($stmt);\n    } else {\n        printf(\"[010] Cannot create SP, [%d] %s.\\n\", mysqli_errno($link), mysqli_error($link));\n    }\n    if (function_exists('mysqli_stmt_get_result')) {\n        if (!mysqli_query($link, 'DROP PROCEDURE IF EXISTS p'))\n            printf(\"[019] [%d] %s.\\n\", mysqli_errno($link), mysqli_error($link));\n        if (mysqli_real_query($link, 'CREATE PROCEDURE p(OUT ver_param VARCHAR(25)) BEGIN SELECT VERSION() INTO ver_param; END;')) {\n            // no result set, one output parameter\n            if (!$stmt = mysqli_prepare($link, 'CALL p(@version)'))\n                printf(\"[020] Cannot prepare CALL, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n            if (!mysqli_stmt_execute($stmt))\n                printf(\"[021] Cannot execute CALL, [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n            if (!mysqli_stmt_close($stmt))\n                printf(\"[022] Cannot close statement, [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n            if (!$stmt = mysqli_prepare($link, 'SELECT @version AS _version'))\n                printf(\"[023] Cannot prepare SELECT, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n            if (!mysqli_stmt_execute($stmt))\n                printf(\"[024] Cannot execute SELECT, [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n            if (!$res = mysqli_stmt_get_result($stmt))\n                printf(\"[025] Cannot get result set, [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n            if ((!($row = mysqli_fetch_assoc($res))) || ($row['_version'] == \"\"))\n                printf(\"[026] Results seem wrong, got %s, [%d] %s\\n\",\n                    $row['_version'],\n                    mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n            mysqli_free_result($res);\n            mysqli_stmt_close($stmt);\n        } else {\n            printf(\"[027] Cannot create SP, [%d] %s.\\n\", mysqli_errno($link), mysqli_error($link));\n        }\n    }\n    if (!mysqli_query($link, 'DROP PROCEDURE IF EXISTS p'))\n        printf(\"[028] [%d] %s.\\n\", mysqli_errno($link), mysqli_error($link));\n    if (mysqli_real_query($link, 'CREATE PROCEDURE p(IN ver_in VARCHAR(25), OUT ver_out VARCHAR(25)) BEGIN SELECT ver_in INTO ver_out; END;')) {\n        // no result set, one input parameter, output parameter\n        // yes, I really do not want to bind input values...\n        if (!$stmt = mysqli_prepare($link, \"CALL p('myversion', @version)\"))\n            printf(\"[029] Cannot prepare CALL, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        if (!mysqli_stmt_execute($stmt))\n            printf(\"[030] Cannot execute CALL, [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        if (!mysqli_stmt_close($stmt))\n            printf(\"[031] Cannot close statement, [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        if (!$stmt = mysqli_prepare($link, 'SELECT @version AS _version'))\n            printf(\"[032] Cannot prepare SELECT, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        if (!mysqli_stmt_execute($stmt))\n            printf(\"[033] Cannot execute SELECT, [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        $version = 'unknown';\n        if (!mysqli_stmt_bind_result($stmt, $version) ||\n                !mysqli_stmt_fetch($stmt))\n            printf(\"[034] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        if ($version != \"myversion\")\n            printf(\"[035] Results seem wrong, got %s, [%d] %s\\n\",\n                $version,\n                mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        mysqli_stmt_free_result($stmt);\n        mysqli_stmt_close($stmt);\n    } else {\n        printf(\"[036] Cannot create SP, [%d] %s.\\n\", mysqli_errno($link), mysqli_error($link));\n    }\n    if (!mysqli_query($link, 'DROP PROCEDURE IF EXISTS p'))\n        printf(\"[037] [%d] %s.\\n\", mysqli_errno($link), mysqli_error($link));\n    if (mysqli_real_query($link, 'CREATE PROCEDURE p(IN ver_in VARCHAR(25), OUT ver_out VARCHAR(25)) BEGIN SELECT ver_in INTO ver_out; END;')) {\n        // no result set, one input parameter, output parameter\n        // yes, I really do not want to bind input values...\n        if (!$stmt = mysqli_prepare($link, 'CALL p(?, @version)'))\n            printf(\"[038] Cannot prepare CALL, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        $version = 'myversion';\n        if (!mysqli_stmt_bind_param($stmt, 's', $version))\n            printf(\"[039] Cannot bind input parameter, [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        if (!mysqli_stmt_execute($stmt))\n            printf(\"[040] Cannot execute CALL, [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        if (!mysqli_stmt_close($stmt))\n            printf(\"[041] Cannot close statement, [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        if (!$stmt = mysqli_prepare($link, 'SELECT @version AS _version'))\n            printf(\"[042] Cannot prepare SELECT, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        if (!mysqli_stmt_execute($stmt))\n            printf(\"[043] Cannot execute SELECT, [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        $version = 'unknown';\n        if (!mysqli_stmt_bind_result($stmt, $version) ||\n                !mysqli_stmt_fetch($stmt))\n            printf(\"[044] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        if ($version !== \"myversion\")\n            printf(\"[045] Results seem wrong, got %s, [%d] %s\\n\",\n                $version,\n                mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        mysqli_stmt_free_result($stmt);\n        mysqli_stmt_close($stmt);\n    } else {\n        printf(\"[046] Cannot create SP, [%d] %s.\\n\", mysqli_errno($link), mysqli_error($link));\n    }\n    mysqli_close($link);\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
