// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/pdo_mysql/tests/pdo_mysql_prepare_emulated.phpt
  it("MySQL PDO->prepare(), emulated PS", function () {
    expect(parser.parseCode("<?php\n    require_once(__DIR__ . DIRECTORY_SEPARATOR . 'mysql_pdo_test.inc');\n    $db = MySQLPDOTest::factory();\n    $db->setAttribute(PDO::ATTR_STRINGIFY_FETCHES, true);\n    function prepex($offset, &$db, $query, $input_params = null, $error_info = null) {\n        try {\n            if (is_array($error_info) && isset($error_info['prepare']))\n                $stmt = @$db->prepare($query);\n            else\n                $stmt = $db->prepare($query);\n            if (is_array($error_info) && isset($error_info['prepare'])) {\n                $tmp = $db->errorInfo();\n                if (isset($error_info['prepare']['sqlstate']) &&\n                    ($error_info['prepare']['sqlstate'] !== $tmp[0])) {\n                    printf(\"[%03d] prepare() - expecting SQLSTATE '%s' got '%s'\\n\",\n                        $offset, $error_info['prepare']['sqlstate'], $tmp[0]);\n                    return false;\n                }\n                if (isset($error_info['prepare']['mysql']) &&\n                    ($error_info['prepare']['mysql'] !== $tmp[1])) {\n                    printf(\"[%03d] prepare() - expecting MySQL Code '%s' got '%s'\\n\",\n                        $offset, $error_info['prepare']['mysql'], $tmp[0]);\n                    return false;\n                }\n                return false;\n            }\n            if (is_null($input_params))\n                $input_params = array();\n            if (is_array($error_info) && isset($error_info['execute']))\n                $ret = @$stmt->execute($input_params);\n            else\n                $ret = $stmt->execute($input_params);\n            if (!is_bool($ret))\n                printf(\"[%03d] PDO::execute() should return a boolean value, got %s/%s\\n\",\n                    var_export($ret, true), $ret);\n            if (is_array($error_info) && isset($error_info['execute'])) {\n                $tmp = $stmt->errorInfo();\n                if (isset($error_info['execute']['sqlstate']) &&\n                    ($error_info['execute']['sqlstate'] !== $tmp[0])) {\n                    printf(\"[%03d] execute() - expecting SQLSTATE '%s' got '%s'\\n\",\n                        $offset, $error_info['execute']['sqlstate'], $tmp[0]);\n                    return false;\n                }\n                if (isset($error_info['execute']['mysql']) &&\n                    ($error_info['execute']['mysql'] !== $tmp[1])) {\n                    printf(\"[%03d] execute() - expecting MySQL Code '%s' got '%s'\\n\",\n                        $offset, $error_info['execute']['mysql'], $tmp[0]);\n                    return false;\n                }\n                return false;\n            }\n        } catch (PDOException $e) {\n            printf(\"[%03d] %s, [%s} %s\\n\",\n                $offset, $e->getMessage(),\n                $db->errorCode(), implode(' ', $db->errorInfo()));\n            return false;\n        }\n        return $stmt;\n    }\n    try {\n        $db->setAttribute(PDO::MYSQL_ATTR_DIRECT_QUERY, 1);\n        if (1 != $db->getAttribute(PDO::MYSQL_ATTR_DIRECT_QUERY))\n            printf(\"[002] Unable to switch to emulated prepared statements, test will fail\\n\");\n        try {\n            prepex(3, $db, '', [], ['execute' => ['sqlstate' => '42000']]);\n        } catch (\\ValueError $e) {\n            echo $e->getMessage(), \\PHP_EOL;\n        }\n        // lets be fair and do the most simple SELECT first\n        $stmt = prepex(4, $db, 'SELECT 1 as \"one\"');\n        var_dump($stmt->fetch(PDO::FETCH_ASSOC));\n        prepex(5, $db, 'DROP TABLE IF EXISTS test');\n        prepex(6, $db, sprintf('CREATE TABLE test(id INT, label CHAR(255)) ENGINE=%s', PDO_MYSQL_TEST_ENGINE));\n        prepex(7, $db, \"INSERT INTO test(id, label) VALUES(1, ':placeholder')\");\n        $stmt = prepex(8, $db, 'SELECT label FROM test');\n        var_dump($stmt->fetchAll(PDO::FETCH_ASSOC));\n        prepex(9, $db, 'DELETE FROM test');\n        prepex(10, $db, \"INSERT INTO test(id, label) VALUES(1, ':placeholder')\",\n            array(':placeholder' => 'first row'));\n        $stmt = prepex(11, $db, 'SELECT label FROM test');\n        var_dump($stmt->fetchAll(PDO::FETCH_ASSOC));\n        prepex(12, $db, 'DELETE FROM test');\n        prepex(13, $db, 'INSERT INTO test(id, label) VALUES(1, :placeholder)',\n            array(':placeholder' => 'first row'));\n        prepex(14, $db, 'INSERT INTO test(id, label) VALUES(2, :placeholder)',\n            array(':placeholder' => 'second row'));\n        $stmt = prepex(15, $db, 'SELECT label FROM test');\n        var_dump($stmt->fetchAll(PDO::FETCH_ASSOC));\n        // Is PDO fun?\n        prepex(16, $db, 'SELECT label FROM test WHERE :placeholder > 1',\n            array(':placeholder' => 'id'));\n        prepex(17, $db, 'SELECT :placeholder FROM test WHERE id > 1',\n            array(':placeholder' => 'id'));\n        prepex(18, $db, 'SELECT :placeholder FROM test WHERE :placeholder > :placeholder',\n            array(':placeholder' => 'test'));\n        for ($num_params = 2; $num_params < 100; $num_params++) {\n            $params = array(':placeholder' => 'a');\n            for ($i = 1; $i < $num_params; $i++) {\n                $params[str_repeat('a', $i)] = 'some data';\n            }\n            prepex(19, $db, 'SELECT id, label FROM test WHERE label > :placeholder',\n                $params, array('execute' => array('sqlstate' => 'HY093')));\n        }\n        prepex(20, $db, 'DELETE FROM test');\n        prepex(21, $db, 'INSERT INTO test(id, label) VALUES (1, :placeholder), (2, :placeholder)',\n            array(':placeholder' => 'row'));\n        $stmt = prepex(22, $db, 'SELECT id, label FROM test');\n        var_dump($stmt->fetchAll(PDO::FETCH_ASSOC));\n        $stmt = prepex(23, $db, 'SELECT id, label FROM test WHERE :placeholder IS NOT NULL',\n            array(':placeholder' => 1));\n        if (count(($tmp = $stmt->fetchAll(PDO::FETCH_ASSOC))) != 2)\n            printf(\"[024] '1' IS NOT NULL evaluates to true, expecting two rows, got %d rows\\n\", $tmp);\n        $stmt = prepex(25, $db, 'SELECT id, label FROM test WHERE :placeholder IS NULL',\n            array(':placeholder' => 1));\n        if (count(($tmp = $stmt->fetchAll(PDO::FETCH_ASSOC))) != 0)\n            printf(\"[026] '1' IS NOT NULL evaluates to true, expecting zero rows, got %d rows\\n\", $tmp);\n        prepex(27, $db, 'DROP TABLE IF EXISTS test');\n        prepex(28, $db, 'CREATE TABLE test(id INT, label CHAR(255)) ENGINE=MyISAM');\n        if (is_object(prepex(29, $db, 'CREATE FULLTEXT INDEX idx1 ON test(label)'))) {\n            prepex(30, $db, 'INSERT INTO test(id, label) VALUES (1, :placeholder)',\n                array(':placeholder' => 'MySQL is the best database in the world!'));\n            prepex(31, $db, 'INSERT INTO test(id, label) VALUES (1, :placeholder)',\n                array(':placeholder' => 'If I have the freedom to choose, I would always go again for the MySQL Server'));\n            $stmt = prepex(32, $db, 'SELECT id, label FROM test WHERE MATCH label AGAINST (:placeholder)',\n                array(':placeholder' => 'mysql'));\n            /*\n            Lets ignore this\n            if (count(($tmp = $stmt->fetchAll(PDO::FETCH_ASSOC))) != 2)\n                printf(\"[033] Expecting two rows, got %d rows\\n\", $tmp);\n            */\n        }\n        prepex(34, $db, 'DELETE FROM test');\n        prepex(35, $db, 'INSERT INTO test(id, label) VALUES (1, :placeholder), (2, :placeholder)',\n            array(':placeholder' => 'row'));\n/*\n        $stmt = prepex(36, $db, 'SELECT id, label FROM \"test WHERE MATCH label AGAINST (:placeholder)',\n            array(':placeholder' => 'row'),\n            array('execute' => array('sqlstate' => '42000', 'mysql' => 1064)));\n*/\n        $stmt = prepex(37, $db, 'SELECT id, label FROM \\'test WHERE MATCH label AGAINST (:placeholder)',\n            array(':placeholder' => 'row'),\n            array('execute' => array('sqlstate' => '42000', 'mysql' => 1064)));\n        $stmt = prepex(38, $db, 'SELECT id, label AS \"label\" FROM test WHERE label = :placeholder',\n            array(':placeholder' => 'row'));\n        $sql = sprintf(\"SELECT id, label FROM test WHERE (label LIKE %s) AND (id = :placeholder)\",\n            $db->quote('%ro%'));\n        $stmt = prepex(39, $db, $sql,\tarray('placeholder' => -1));\n        if (count(($tmp = $stmt->fetchAll(PDO::FETCH_ASSOC))) != 0)\n                printf(\"[040] Expecting zero rows, got %d rows\\n\", $tmp);\n        $sql = sprintf(\"SELECT id, label FROM test WHERE  (id = :placeholder) OR (label LIKE %s)\",\n            $db->quote('%ro%'));\n        $stmt = prepex(41, $db, $sql,\tarray('placeholder' => 1));\n        if (count(($tmp = $stmt->fetchAll(PDO::FETCH_ASSOC))) != 2)\n                printf(\"[042] Expecting two rows, got %d rows\\n\", $tmp);\n        $sql = \"SELECT id, label FROM test WHERE id = :placeholder AND label = (SELECT label AS 'SELECT' FROM test WHERE id = :placeholder)\";\n        $stmt = prepex(43, $db, $sql,\tarray('placeholder' => 1));\n        if (count(($tmp = $stmt->fetchAll(PDO::FETCH_ASSOC))) != 1)\n                printf(\"[044] Expecting onw row, got %d rows\\n\", $tmp);\n        // and now, the same with anonymous placeholders...\n        prepex(45, $db, 'DROP TABLE IF EXISTS test');\n        prepex(46, $db, sprintf('CREATE TABLE test(id INT, label CHAR(255)) ENGINE=%s', PDO_MYSQL_TEST_ENGINE));\n        prepex(47, $db, \"INSERT INTO test(id, label) VALUES(1, '?')\");\n        $stmt = prepex(48, $db, 'SELECT label FROM test');\n        var_dump($stmt->fetchAll(PDO::FETCH_ASSOC));\n        prepex(49, $db, 'DELETE FROM test');\n        prepex(50, $db, \"INSERT INTO test(id, label) VALUES(1, '?')\",\n            array('first row'));\n        $stmt = prepex(51, $db, 'SELECT label FROM test');\n        var_dump($stmt->fetchAll(PDO::FETCH_ASSOC));\n        prepex(52, $db, 'DELETE FROM test');\n        prepex(53, $db, 'INSERT INTO test(id, label) VALUES(1, ?)',\n            array('first row'));\n        prepex(54, $db, 'INSERT INTO test(id, label) VALUES(2, ?)',\n            array('second row'));\n        $stmt = prepex(55, $db, 'SELECT label FROM test');\n        var_dump($stmt->fetchAll(PDO::FETCH_ASSOC));\n        // Is PDO fun?\n        prepex(56, $db, 'SELECT label FROM test WHERE ? > 1',\n            array('id'));\n        prepex(57, $db, 'SELECT ? FROM test WHERE id > 1',\n            array('id'));\n        prepex(58, $db, 'SELECT ? FROM test WHERE ? > ?',\n            array('test'), array('execute' => array('sqlstate' => 'HY093')));\n        prepex(59, $db, 'SELECT ? FROM test WHERE ? > ?',\n            array('id', 'label', 'value'));\n        for ($num_params = 2; $num_params < 100; $num_params++) {\n            $params = array('a');\n            for ($i = 1; $i < $num_params; $i++) {\n                $params[] = 'some data';\n            }\n            prepex(60, $db, 'SELECT id, label FROM test WHERE label > ?',\n                $params, array('execute' => array('sqlstate' => 'HY093')));\n        }\n        prepex(61, $db, 'DELETE FROM test');\n        prepex(62, $db, 'INSERT INTO test(id, label) VALUES (1, ?), (2, ?)',\n            array('row', 'row'));\n        $stmt = prepex(63, $db, 'SELECT id, label FROM test');\n        var_dump($stmt->fetchAll(PDO::FETCH_ASSOC));\n        $stmt = prepex(64, $db, 'SELECT id, label FROM test WHERE ? IS NOT NULL',\n            array(1));\n        if (count(($tmp = $stmt->fetchAll(PDO::FETCH_ASSOC))) != 2)\n            printf(\"[065] '1' IS NOT NULL evaluates to true, expecting two rows, got %d rows\\n\", $tmp);\n        $stmt = prepex(66, $db, 'SELECT id, label FROM test WHERE ? IS NULL',\n            array(1));\n        if (count(($tmp = $stmt->fetchAll(PDO::FETCH_ASSOC))) != 0)\n            printf(\"[067] '1' IS NOT NULL evaluates to true, expecting zero rows, got %d rows\\n\", $tmp);\n        prepex(68, $db, 'DROP TABLE IF EXISTS test');\n        prepex(69, $db, 'CREATE TABLE test(id INT, label CHAR(255)) ENGINE=MyISAM');\n        if (is_object(prepex(70, $db, 'CREATE FULLTEXT INDEX idx1 ON test(label)'))) {\n            prepex(71, $db, 'INSERT INTO test(id, label) VALUES (1, ?)',\n                array('MySQL is the best database in the world!'));\n            prepex(72, $db, 'INSERT INTO test(id, label) VALUES (1, ?)',\n                array('If I have the freedom to choose, I would always go again for the MySQL Server'));\n            $stmt = prepex(73, $db, 'SELECT id, label FROM test WHERE MATCH label AGAINST (?)',\n                array('mysql'));\n            /*\n            Lets ignore that\n            if (count(($tmp = $stmt->fetchAll(PDO::FETCH_ASSOC))) != 2)\n                printf(\"[074] Expecting two rows, got %d rows\\n\", $tmp);\n            */\n        }\n        prepex(74, $db, 'DELETE FROM test');\n        prepex(75, $db, 'INSERT INTO test(id, label) VALUES (1, ?), (2, ?)',\n            array('row', 'row'));\n        $stmt = prepex(76, $db, 'SELECT id, label FROM \"test WHERE MATCH label AGAINST (?)',\n            array('row'),\n            array('execute' => array('sqlstate' => '42000', 'mysql' => 1064)));\n        /*\n        TODO enable after fix\n        $stmt = prepex(37, $db, 'SELECT id, label FROM \\'test WHERE MATCH label AGAINST (:placeholder)',\n            array(':placeholder' => 'row'),\n            array('execute' => array('sqlstate' => '42000', 'mysql' => 1064)));\n        */\n        $stmt = prepex(78, $db, 'SELECT id, label AS \"label\" FROM test WHERE label = ?',\n            array('row'));\n        $sql = sprintf(\"SELECT id, label FROM test WHERE (label LIKE %s) AND (id = ?)\",\n            $db->quote('%ro%'));\n        $stmt = prepex(79, $db, $sql,\tarray(-1));\n        if (count(($tmp = $stmt->fetchAll(PDO::FETCH_ASSOC))) != 0)\n                printf(\"[080] Expecting zero rows, got %d rows\\n\", $tmp);\n        $sql = sprintf(\"SELECT id, label FROM test WHERE  (id = ?) OR (label LIKE %s)\",\n            $db->quote('%ro%'));\n        $stmt = prepex(81, $db, $sql,\tarray(1));\n        if (count(($tmp = $stmt->fetchAll(PDO::FETCH_ASSOC))) != 2)\n                printf(\"[082] Expecting two rows, got %d rows\\n\", $tmp);\n        $sql = \"SELECT id, label FROM test WHERE id = ? AND label = (SELECT label AS 'SELECT' FROM test WHERE id = ?)\";\n        $stmt = prepex(83, $db, $sql,\tarray(1, 1));\n        if (count(($tmp = $stmt->fetchAll(PDO::FETCH_ASSOC))) != 1)\n                printf(\"[084] Expecting one row, got %d rows\\n\", $tmp);\n        $sql = \"SELECT id, label FROM test WHERE id = :placeholder AND label = (SELECT label AS 'SELECT' FROM test WHERE id = ?)\";\n        $stmt = prepex(85, $db, $sql,\tarray(1, 1), array('execute' => array('sqlstate' => 'HY093')));\n        if (is_object($stmt) && count(($tmp = $stmt->fetchAll(PDO::FETCH_ASSOC))) != 0)\n                printf(\"[086] Expecting no rows, got %d rows\\n\", $tmp);\n    } catch (PDOException $e) {\n        printf(\"[001] %s [%s] %s\\n\",\n            $e->getMessage(), $db->errorCode(), implode(' ', $db->errorInfo()));\n    }\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
