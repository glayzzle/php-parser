// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_stmt_bind_param_references.phpt
  it("mysqli_stmt_bind_param() - playing with references", function () {
    expect(parser.parseCode("<?php\n    require('table.inc');\n    function findRow($offset, $link, $id, $label) {\n        $sql = sprintf(\"SELECT id, label FROM test WHERE id = '%d' AND label = '%s'\",\n                $id, $label);\n        if (!$res = mysqli_query($link, $sql)) {\n            printf(\"[%03d + 1] %s failed, [%d] %s\\n\",\n                $offset, $sql, mysqli_errno($link), mysqli_error($link));\n            return false;\n        }\n        if (!$row = mysqli_fetch_assoc($res)) {\n            printf(\"[%03d + 2] fetch for %s failed, [%d] %s\\n\",\n                $offset, $sql, mysqli_errno($link), mysqli_error($link));\n            return false;\n        }\n        mysqli_free_result($res);\n        if ($row['id'] != $id) {\n            printf(\"[%03d + 3] Expecting %s/%s got %s/%s\\n\",\n                $offset, gettype($id), $id,\n                gettype($row['id']), $row['id']\n                );\n            return false;\n        }\n        if ($row['label'] != $label) {\n            printf(\"[%03d + 4] Expecting %s/%s got %s/%s\\n\",\n                $offset, gettype($label), $label,\n                gettype($row['label']), $row['label']\n                );\n            return false;\n        }\n        $sql = sprintf(\"DELETE FROM test WHERE id = '%d' AND label = '%s'\",\n                $id, $label);\n        if (!mysqli_query($link, $sql)) {\n            printf(\"[%03d + 5] %s failed, [%d] %s\\n\",\n                $offset, $sql, mysqli_errno($link), mysqli_error($link));\n            return false;\n        }\n        return true;\n    }\n    // or we will get dups around [28]\n    mysqli_query($link, \"ALTER TABLE test DROP PRIMARY KEY\");\n    $stmt = mysqli_stmt_init($link);\n    if (!mysqli_stmt_prepare($stmt, \"INSERT INTO test(id, label) VALUES (?, ?)\"))\n        printf(\"[001] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $id = 100;\n    $label = 'v';\n    if (true !== ($tmp = mysqli_stmt_bind_param($stmt, \"is\", $id, $label)))\n        printf(\"[002] Expecting boolean/false, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (true !== mysqli_stmt_execute($stmt))\n        printf(\"[003] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    // no need to check the return value, will bail and make EXPECTF fail if need be\n    findRow(4, $link, $id, $label);\n    $id++;\n    $label_ref = &$label;\n    $label = 'w';\n    if (true !== ($tmp = mysqli_stmt_bind_param($stmt, \"is\", $id, $label_ref)))\n        printf(\"[005] Expecting boolean/false, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (true !== mysqli_stmt_execute($stmt))\n        printf(\"[006] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    findRow(7, $link, $id, $label_ref);\n    $id++;\n    $label_ref_ref = &$label_ref;\n    $label = 'x';\n    if (true !== ($tmp = mysqli_stmt_bind_param($stmt, \"is\", $id, $label_ref_ref)))\n        printf(\"[007] Expecting boolean/false, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (true !== mysqli_stmt_execute($stmt))\n        printf(\"[008] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    findRow(9, $link, $id, $label_ref_ref);\n    $id = 9;\n    $label = $id;\n    $label_num = &$label;\n    if (true !== ($tmp = mysqli_stmt_bind_param($stmt, \"is\", $id, $label_num)))\n        printf(\"[010] Expecting boolean/false, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (true !== mysqli_stmt_execute($stmt))\n        printf(\"[011] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    findRow(12, $link, $id, $label_num);\n    $label_num = &$id;\n    if (true !== ($tmp = mysqli_stmt_bind_param($stmt, \"is\", $id, $label_num)))\n        printf(\"[013] Expecting boolean/false, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (true !== mysqli_stmt_execute($stmt))\n        printf(\"[014] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    findRow(15, $link, $id, $label_num);\n    $label = 9;\n    $id = &$label;\n    if (true !== ($tmp = mysqli_stmt_bind_param($stmt, \"is\", $id, $label)))\n        printf(\"[015] Expecting boolean/false, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (true !== mysqli_stmt_execute($stmt))\n        printf(\"[016] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    findRow(17, $link, $id, $label);\n    $base = 9;\n    $id = &$base;\n    $label = &$id;\n    if (true !== ($tmp = mysqli_stmt_bind_param($stmt, \"is\", $id, $label)))\n        printf(\"[018] Expecting boolean/false, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (true !== mysqli_stmt_execute($stmt))\n        printf(\"[019] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    findRow(20, $link, $id, $label);\n    $id_ref = &$id;\n    $label_ref = &$label;\n    if (true !== ($tmp = mysqli_stmt_bind_param($stmt, \"is\", $id_ref, $label_ref)))\n        printf(\"[021] Expecting boolean/false, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (true !== mysqli_stmt_execute($stmt))\n        printf(\"[022] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    findRow(23, $link, $id_ref, $label_ref);\n    $id_ref_ref = &$GLOBALS['id_ref'];\n    $label_ref_ref = &$GLOBALS['label_ref_ref'];\n    if (true !== ($tmp = mysqli_stmt_bind_param($stmt, \"is\", $id_ref_ref, $label_ref_ref)))\n        printf(\"[024] Expecting boolean/false, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (true !== mysqli_stmt_execute($stmt))\n        printf(\"[025] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    findRow(26, $link, $id_ref_ref, $label_ref_ref);\n    unset($id);\n    unset($label);\n    $id = 102;\n    $label = new stdClass();\n    $label->label = 'y';\n    $id_ref = &$GLOBALS['id'];\n    $label_ref = &$label->label;\n    if (true !== ($tmp = mysqli_stmt_bind_param($stmt, \"is\", $id_ref, $label_ref)))\n        printf(\"[027] Expecting boolean/false, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (true !== @mysqli_stmt_execute($stmt))\n        printf(\"[028] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    findRow(29, $link, $id_ref, $label_ref);\n    $id = 103;\n    $label_a = &$label_b;\n    $label_b = &$label_a;\n    $label_a = 'z';\n    if (true !== ($tmp = mysqli_stmt_bind_param($stmt, \"is\", $id, $label_b)))\n        printf(\"[030] Expecting boolean/false, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (true !== mysqli_stmt_execute($stmt))\n        printf(\"[031] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    findRow(32, $link, $id, $label_b);\n    class foo {\n        public $foo;\n        function __construct() {\n            $this->foo = &$this->bar;\n        }\n    }\n    class bar extends foo {\n        public $bar = 'v';\n    }\n    $bar = new bar();\n    $id++;\n    $label = &$GLOBALS['bar']->foo;\n    if (true !== ($tmp = mysqli_stmt_bind_param($stmt, \"is\", $id, $label)))\n        printf(\"[033] Expecting boolean/false, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (true !== mysqli_stmt_execute($stmt))\n        printf(\"[034] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    findRow(35, $link, $id, $label);\n    mysqli_stmt_close($stmt);\n    mysqli_close($link);\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
