// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/pdo_pgsql/tests/bug75402.phpt
  it("PDO PgSQL Bug #75402 Possible Memory Leak using PDO::CURSOR_SCROLL option", function () {
    expect(parser.parseCode("<?php\nrequire __DIR__ . '/../../../ext/pdo/tests/pdo_test.inc';\n$db = PDOTest::test_factory(__DIR__ . '/common.phpt');\n$resp = new \\stdClass();\n$resp->entries = [];\n$db->query('DROP TABLE IF EXISTS bug75402 CASCADE');\n$db->query('CREATE TABLE bug75402 (\n    \"id\" character varying(64) NOT NULL,\n    \"group_id\" character varying(64) NOT NULL,\n    \"submitter\" character varying(320) NOT NULL,\n    \"operation\" character varying(32) NOT NULL,\n    \"description\" character varying(320) NOT NULL,\n    \"stage\" character varying(16) NOT NULL,\n    \"status\" character varying(64) NOT NULL,\n    \"progress\" integer NOT NULL,\n    \"insert_datetime\" timestamp(3) NOT NULL,\n    \"begin_datetime\" timestamp(3),\n    \"end_datetime\" timestamp(3),\n    \"life_hours\" integer NOT NULL,\n    \"family\" character varying(32) NOT NULL,\n    \"parallelism_group\" character varying(32) NOT NULL,\n    \"max_parallelism\" integer NOT NULL,\n    \"hidden\" boolean NOT NULL,\n    \"abort\" boolean NOT NULL,\n    \"order_folder_pathname\" character varying(320),\n    \"worker\" character varying(32) NOT NULL,\n    CONSTRAINT \"pk_bug75402\" PRIMARY KEY (\"id\")\n) WITH (oids = false);');\n$db->query(\"INSERT INTO bug75402 (\\\"id\\\", \\\"group_id\\\", \\\"submitter\\\", \\\"operation\\\", \\\"description\\\", \\\"stage\\\", \\\"status\\\", \\\"progress\\\", \\\"insert_datetime\\\", \\\"begin_datetime\\\", \\\"end_datetime\\\", \\\"life_hours\\\", \\\"family\\\", \\\"parallelism_group\\\", \\\"max_parallelism\\\", \\\"hidden\\\", \\\"abort\\\", \\\"order_folder_pathname\\\", \\\"worker\\\") VALUES\n('20171016083645_5337',\t'G_20171016083645_5337',\t'TESTPetunia',\t'IMPORT',\t'',\t'DON',\t'Completed',\t100,\t'2017-10-16 08:36:45',\t'2017-10-16 08:36:46',\t'2017-10-16 08:36:46',\t96,\t'IMPORT',\t'',\t-1,\t'f',\t'f',\t'C:\\ProgramData\\TestPath\\TestApp\\Jobs\\Jobs\\\\20171016083645_5337',\t'MainService')\");\n$sql = \"SELECT\n            ID as \\\"sID\\\",\n            GROUP_ID as \\\"sGroupID\\\",\n            SUBMITTER as \\\"sOwner\\\",\n            OPERATION as \\\"sOperation\\\",\n            DESCRIPTION as \\\"sInfo\\\",\n            STAGE as \\\"sShortStatus\\\",\n            STATUS as \\\"sStatus\\\",\n            PROGRESS as \\\"sProgress\\\",\n            HIDDEN as \\\"bHidden\\\",\n            to_char(INSERT_DATETIME, 'IYYY.MM.DD HH24:MI:SS')  as \\\"sDatetime\\\"\n          FROM bug75402\n          ORDER BY INSERT_DATETIME DESC\";\nif ($db) {\n    $stmt = $db->prepare($sql,\n        array(\n            // With the following options memory is not being\n            // deallocated\n              \\PDO::ATTR_CURSOR => \\PDO::CURSOR_SCROLL\n            // With the following option memory is de-allocated\n            // \\PDO::ATTR_CURSOR => \\PDO::CURSOR_FWDONLY\n        )\n    );\n    $stmt->execute();\n    while ($entry = $stmt->fetchObject()) {\n      $resp->entries [] = $entry;\n    }\n    $stmt->closeCursor();\n    $stmt = null;\n    $db = null;\n}\nvar_dump($resp);\n?>")).toMatchSnapshot();
  });
});
