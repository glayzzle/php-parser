// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/bug45019.phpt
  it("Bug #45019 (Segmentation fault with SELECT ? and UNION)", function () {
    expect(parser.parseCode("<?php\n    require_once(\"connect.inc\");\n    require_once(\"table.inc\");\n    // Regular (non-prepared) queries\n    print \"Using CAST('somestring' AS CHAR)...\\n\";\n    if (!($res = $link->query(\"SELECT CAST('one' AS CHAR) AS column1 UNION SELECT CAST('three' AS CHAR) UNION SELECT CAST('two' AS CHAR)\")))\n        printf(\"[001] [%d] %s\\n\", $link->errno, $link->error);\n    $data = array();\n    while ($row = $res->fetch_assoc()) {\n        $data[] = $row['column1'];\n        var_dump($row['column1']);\n    }\n    $res->free();\n    // Prepared Statements\n    if (!($stmt = $link->prepare(\"SELECT CAST('one' AS CHAR) AS column1 UNION SELECT CAST('three' AS CHAR) UNION SELECT CAST('two' AS CHAR)\")))\n        printf(\"[002] [%d] %s\\n\", $link->errno, $link->error);\n    $column1 = null;\n    if (!$stmt->bind_result($column1) || !$stmt->execute())\n        printf(\"[003] [%d] %s\\n\", $stmt->errno, $stmt->error);\n    $index = 0;\n    while ($stmt->fetch()) {\n        /* NOTE: libmysql - http://bugs.mysql.com/bug.php?id=47483 */\n        if ($data[$index] != $column1) {\n            if ($IS_MYSQLND || $index != 1) {\n                printf(\"[004] Row %d, expecting %s/%s got %s/%s\\n\",\n                    $index + 1, gettype($data[$index]), $data[$index], gettype($column1), $column1);\n            } else {\n                if ($column1 != \"thre\")\n                    printf(\"[005] Got '%s'. Please check if http://bugs.mysql.com/bug.php?id=47483 has been fixed and adapt tests bug45019.phpt/mysqli_ps_select_union.phpt\", $column1);\n            }\n        }\n        $index++;\n    }\n    $stmt->close();\n    $link->close();\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
