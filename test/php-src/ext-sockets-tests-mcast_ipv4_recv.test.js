// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/sockets/tests/mcast_ipv4_recv.phpt
  it("Multicast support: IPv4 receive options", function () {
    expect(parser.parseCode("<?php\ninclude __DIR__.\"/mcast_helpers.php.inc\";\n$domain = AF_INET;\n$level = IPPROTO_IP;\n$interface = \"lo\";\n$mcastaddr = '224.0.0.23';\n$sblock = \"127.0.0.1\";\necho \"creating send socket bound to 127.0.0.1\\n\";\n$sends1 = socket_create($domain, SOCK_DGRAM, SOL_UDP);\n$br = socket_bind($sends1, '127.0.0.1');\nvar_dump($br);\necho \"creating unbound socket and hoping the routing table causes an interface other than lo to be used for sending messages to $mcastaddr\\n\";\n$sends2 = socket_create($domain, SOCK_DGRAM, SOL_UDP);\nvar_dump($br);\necho \"creating receive socket\\n\";\n$s = socket_create($domain, SOCK_DGRAM, SOL_UDP);\nvar_dump($s);\n$br = socket_bind($s, '0.0.0.0', 0);\nsocket_getsockname($s, $unused, $port);\nvar_dump($br);\n$so = socket_set_option($s, $level, MCAST_JOIN_GROUP, array(\n    \"group\"\t=> $mcastaddr,\n    \"interface\" => $interface,\n));\nvar_dump($so);\n$r = socket_sendto($sends1, $m = \"initial packet\", strlen($m), 0, $mcastaddr, $port);\nvar_dump($r);\n$i = 0;\nchecktimeout($s, 500);\nwhile (($str = socket_read($s, 3000)) !== FALSE) {\n    $i++;\n    echo \"$i> \", $str, \"\\n\";\nif ($i == 1) {\n    echo \"leaving group\\n\";\n    $so = socket_set_option($s, $level, MCAST_LEAVE_GROUP, array(\n        \"group\"\t=> $mcastaddr,\n        \"interface\" => $interface,\n    ));\n    var_dump($so);\n    $r = socket_sendto($sends1, $m = \"ignored mcast packet\", strlen($m), 0, $mcastaddr, $port);\n    var_dump($r);\n    $r = socket_sendto($sends1, $m = \"unicast packet\", strlen($m), 0, \"127.0.0.1\", $port);\n    var_dump($r);\n}\nif ($i == 2) {\n    echo \"re-joining group\\n\";\n    $so = socket_set_option($s, $level, MCAST_JOIN_GROUP, array(\n        \"group\"\t=> $mcastaddr,\n        \"interface\" => $interface,\n    ));\n    var_dump($so);\n    $r = socket_sendto($sends2, $m = \"ignored mcast packet (different interface)\", strlen($m), 0, $mcastaddr, $port);\n    var_dump($r);\n    $r = socket_sendto($sends1, $m = \"mcast packet\", strlen($m), 0, $mcastaddr, $port);\n    var_dump($r);\n}\nif ($i == 3) {\n    echo \"blocking source\\n\";\n    $so = socket_set_option($s, $level, MCAST_BLOCK_SOURCE, array(\n        \"group\"\t=> $mcastaddr,\n        \"interface\" => $interface,\n        \"source\" => $sblock,\n    ));\n    var_dump($so);\n    $r = socket_sendto($sends1, $m = \"ignored packet (blocked source)\", strlen($m), 0, $mcastaddr, $port);\n    var_dump($r);\n    $r = socket_sendto($sends1, $m = \"unicast packet\", strlen($m), 0, \"127.0.0.1\", $port);\n    var_dump($r);\n}\nif ($i == 4) {\n    echo \"unblocking source\\n\";\n    $so = socket_set_option($s, $level, MCAST_UNBLOCK_SOURCE, array(\n        \"group\"\t=> $mcastaddr,\n        \"interface\" => $interface,\n        \"source\" => $sblock,\n    ));\n    var_dump($so);\n    $r = socket_sendto($sends1, $m = \"mcast packet from 127.0.0.1\", strlen($m), 0, $mcastaddr, $port);\n    var_dump($r);\n}\nif ($i == 5) {\n    echo \"leaving group\\n\";\n    $so = socket_set_option($s, $level, MCAST_LEAVE_GROUP, array(\n        \"group\"\t=> $mcastaddr,\n        \"interface\" => $interface,\n    ));\n    var_dump($so);\n    $r = socket_sendto($sends1, $m = \"ignored mcast packet\", strlen($m), 0, $mcastaddr, $port);\n    var_dump($r);\n    $r = socket_sendto($sends1, $m = \"unicast packet\", strlen($m), 0, \"127.0.0.1\", $port);\n    var_dump($r);\n}\nif ($i == 6) {\n    echo \"joining source group\\n\";\n    $so = socket_set_option($s, $level, MCAST_JOIN_SOURCE_GROUP, array(\n        \"group\"\t=> $mcastaddr,\n        \"interface\" => $interface,\n        \"source\" => $sblock,\n    ));\n    var_dump($so);\n    $r = socket_sendto($sends1, $m = \"mcast packet from 127.0.0.1\", strlen($m), 0, $mcastaddr, $port);\n    var_dump($r);\n}\nif ($i == 7) {\n    echo \"leaving source group\\n\";\n    $so = socket_set_option($s, $level, MCAST_LEAVE_SOURCE_GROUP, array(\n        \"group\"\t=> $mcastaddr,\n        \"interface\" => $interface,\n        \"source\" => $sblock,\n    ));\n    var_dump($so);\n    $r = socket_sendto($sends1, $m = \"ignored mcast packet\", strlen($m), 0, $mcastaddr, $port);\n    var_dump($r);\n    $r = socket_sendto($sends1, $m = \"unicast packet\", strlen($m), 0, \"127.0.0.1\", $port);\n    var_dump($r);\n}\nif ($i == 8) {\n/*\techo \"rjsg\\n\";\n    $so = socket_set_option($s, $level, MCAST_JOIN_GROUP, array(\n        \"group\"\t=> $mcastaddr,\n        \"interface\" => $interface,\n    ));\n    var_dump($so);*/\n    break;\n}\n}\n?>")).toMatchSnapshot();
  });
});
