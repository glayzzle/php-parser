// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_constants.phpt
  it("Constants exported by ext/mysqli", function () {
    expect(parser.parseCode("<?php\n$IS_MYSQLND = stristr(mysqli_get_client_info(), \"mysqlnd\");\n$constants = get_defined_constants(true);\nsort($constants);\n$expected_constants = array(\n    'MYSQLI_READ_DEFAULT_GROUP'\t\t\t=> true,\n    'MYSQLI_READ_DEFAULT_FILE'\t\t\t=> true,\n    'MYSQLI_OPT_CONNECT_TIMEOUT'\t\t=> true,\n    'MYSQLI_OPT_LOCAL_INFILE'\t\t\t=> true,\n    'MYSQLI_OPT_READ_TIMEOUT'\t\t\t=> true,\n    'MYSQLI_INIT_COMMAND'\t\t\t\t=> true,\n    'MYSQLI_CLIENT_SSL'\t\t\t\t\t=> true,\n    \"MYSQLI_CLIENT_COMPRESS\"\t\t\t=> true,\n    \"MYSQLI_CLIENT_INTERACTIVE\"\t\t\t=> true,\n    \"MYSQLI_CLIENT_IGNORE_SPACE\"\t\t=> true,\n    \"MYSQLI_CLIENT_NO_SCHEMA\"\t\t\t=> true,\n    \"MYSQLI_CLIENT_FOUND_ROWS\"\t\t\t=> true,\n    \"MYSQLI_STORE_RESULT\"\t\t\t\t=> true,\n    \"MYSQLI_USE_RESULT\"\t\t\t\t\t=> true,\n    \"MYSQLI_ASSOC\"\t\t\t\t\t\t=> true,\n    \"MYSQLI_NUM\"\t\t\t\t\t\t=> true,\n    \"MYSQLI_BOTH\"\t\t\t\t\t\t=> true,\n    \"MYSQLI_STMT_ATTR_UPDATE_MAX_LENGTH\"=> true,\n    \"MYSQLI_NOT_NULL_FLAG\"\t\t\t\t=> true,\n    \"MYSQLI_PRI_KEY_FLAG\"\t\t\t\t=> true,\n    \"MYSQLI_UNIQUE_KEY_FLAG\"\t\t\t=> true,\n    \"MYSQLI_MULTIPLE_KEY_FLAG\"\t\t\t=> true,\n    \"MYSQLI_BLOB_FLAG\"\t\t\t\t\t=> true,\n    \"MYSQLI_UNSIGNED_FLAG\"\t\t\t\t=> true,\n    \"MYSQLI_ZEROFILL_FLAG\"\t\t\t\t=> true,\n    \"MYSQLI_AUTO_INCREMENT_FLAG\"\t\t=> true,\n    \"MYSQLI_TIMESTAMP_FLAG\"\t\t\t\t=> true,\n    \"MYSQLI_SET_FLAG\"\t\t\t\t\t=> true,\n    \"MYSQLI_NUM_FLAG\"\t\t\t\t\t=> true,\n    \"MYSQLI_ENUM_FLAG\"\t\t\t\t\t=> true,\n    \"MYSQLI_BINARY_FLAG\"\t\t\t\t=> true,\n    \"MYSQLI_PART_KEY_FLAG\"\t\t\t\t=> true,\n    \"MYSQLI_GROUP_FLAG\" \t\t\t\t=> true,\n    \"MYSQLI_SERVER_QUERY_NO_GOOD_INDEX_USED\"=> true,\n    \"MYSQLI_SERVER_QUERY_NO_INDEX_USED\"\t=> true,\n    \"MYSQLI_IS_MARIADB\"                 => true,\n    \"MYSQLI_TYPE_DECIMAL\"\t\t\t\t=> true,\n    \"MYSQLI_TYPE_TINY\"\t\t\t\t\t=> true,\n    \"MYSQLI_TYPE_SHORT\"\t\t\t\t\t=> true,\n    \"MYSQLI_TYPE_LONG\"\t\t\t\t\t=> true,\n    \"MYSQLI_TYPE_FLOAT\"\t\t\t\t\t=> true,\n    \"MYSQLI_TYPE_DOUBLE\"\t\t\t\t=> true,\n    \"MYSQLI_TYPE_NULL\"\t\t\t\t\t=> true,\n    \"MYSQLI_TYPE_TIMESTAMP\"\t\t\t\t=> true,\n    \"MYSQLI_TYPE_LONGLONG\"\t\t\t\t=> true,\n    \"MYSQLI_TYPE_INT24\"\t\t\t\t\t=> true,\n    \"MYSQLI_TYPE_DATE\"\t\t\t\t\t=> true,\n    \"MYSQLI_TYPE_TIME\"\t\t\t\t\t=> true,\n    \"MYSQLI_TYPE_DATETIME\"\t\t\t\t=> true,\n    \"MYSQLI_TYPE_YEAR\"\t\t\t\t\t=> true,\n    \"MYSQLI_TYPE_NEWDATE\"\t\t\t\t=> true,\n    \"MYSQLI_TYPE_ENUM\"\t\t\t\t\t=> true,\n    \"MYSQLI_TYPE_SET\"\t\t\t\t\t=> true,\n    \"MYSQLI_TYPE_TINY_BLOB\"\t\t\t\t=> true,\n    \"MYSQLI_TYPE_MEDIUM_BLOB\"\t\t\t=> true,\n    \"MYSQLI_TYPE_LONG_BLOB\"\t\t\t\t=> true,\n    \"MYSQLI_TYPE_BLOB\"\t\t\t\t\t=> true,\n    \"MYSQLI_TYPE_VAR_STRING\"\t\t\t=> true,\n    \"MYSQLI_TYPE_STRING\"\t\t\t\t=> true,\n    \"MYSQLI_TYPE_CHAR\"\t\t\t\t\t=> true,\n    \"MYSQLI_TYPE_INTERVAL\"\t\t\t\t=> true,\n    \"MYSQLI_TYPE_GEOMETRY\"\t\t\t\t=> true,\n    \"MYSQLI_NO_DATA\"\t\t\t\t\t=> true,\n    \"MYSQLI_REPORT_INDEX\"\t\t\t\t=> true,\n    \"MYSQLI_REPORT_STRICT\"\t\t\t\t=> true,\n    \"MYSQLI_REPORT_ALL\"\t\t\t\t\t=> true,\n    \"MYSQLI_REPORT_ERROR\"\t\t\t\t=> true,\n    \"MYSQLI_REPORT_OFF\"\t\t\t\t\t=> true,\n    \"MYSQLI_SET_CHARSET_NAME\"\t\t\t=> true,\n    \"MYSQLI_SET_CHARSET_DIR\"\t\t\t=> true,\n    \"MYSQLI_REFRESH_GRANT\"\t\t\t\t=> true,\n    \"MYSQLI_REFRESH_LOG\"\t\t\t\t=> true,\n    \"MYSQLI_REFRESH_TABLES\"\t\t\t\t=> true,\n    \"MYSQLI_REFRESH_HOSTS\"\t\t\t\t=> true,\n    \"MYSQLI_REFRESH_STATUS\"\t\t\t\t=> true,\n    \"MYSQLI_REFRESH_THREADS\"\t\t\t=> true,\n    \"MYSQLI_REFRESH_REPLICA\"\t\t\t=> true,\n    \"MYSQLI_REFRESH_SLAVE\"\t\t\t\t=> true,\n    \"MYSQLI_REFRESH_MASTER\"\t\t\t\t=> true,\n    \"MYSQLI_DEBUG_TRACE_ENABLED\"\t\t=> true,\n    \"MYSQLI_TRANS_START_WITH_CONSISTENT_SNAPSHOT\" => true,\n    \"MYSQLI_TRANS_START_READ_WRITE\"\t\t=> true,\n    \"MYSQLI_TRANS_START_READ_ONLY\"\t\t=> true,\n    \"MYSQLI_TRANS_COR_AND_CHAIN\"\t\t=> true,\n    \"MYSQLI_TRANS_COR_AND_NO_CHAIN\"\t\t=> true,\n    \"MYSQLI_TRANS_COR_RELEASE\"\t\t\t=> true,\n    \"MYSQLI_TRANS_COR_NO_RELEASE\"\t\t=> true,\n);\n/* depends on the build - experimental */\nif ($IS_MYSQLND) {\n    $expected_constants['MYSQLI_OPT_INT_AND_FLOAT_NATIVE'] = true;\n}\nif ($IS_MYSQLND) {\n    $expected_constants['MYSQLI_STORE_RESULT_COPY_DATA'] = true;\n}\nif ($IS_MYSQLND) {\n    $expected_constants['MYSQLI_REFRESH_BACKUP_LOG'] = true;\n}\nif ($IS_MYSQLND) {\n    $version = 50007 + 1;\n    $expected_constants['MYSQLI_OPT_NET_CMD_BUFFER_SIZE'] = true;\n    $expected_constants['MYSQLI_OPT_NET_READ_BUFFER_SIZE'] = true;\n    $expected_constants['MYSQLI_ASYNC'] = true;\n    $expected_constants['MYSQLI_SERVER_PS_OUT_PARAMS'] = true;\n} else {\n    $version = mysqli_get_client_version();\n}\nif (($version > 51122 && $version < 60000) || ($version > 60003) || $IS_MYSQLND) {\n    $expected_constants['MYSQLI_ON_UPDATE_NOW_FLAG'] = true;\n}\n/* First introduced in MySQL 6.0, backported to MySQL 5.5 */\nif ($version >= 50500 || $IS_MYSQLND) {\n    $expected_constants['MYSQLI_SERVER_QUERY_WAS_SLOW'] = true;\n}\n$expected_constants['MYSQLI_CLIENT_SSL_VERIFY_SERVER_CERT'] = true;\nif ($IS_MYSQLND) {\n    $expected_constants['MYSQLI_CLIENT_SSL_DONT_VERIFY_SERVER_CERT'] = true;\n}\n/* First introduced in MySQL 6.0, backported to MySQL 5.5 */\nif ($version >= 50606 || $IS_MYSQLND) {\n    $expected_constants['MYSQLI_SERVER_PUBLIC_KEY'] = true;\n}\n$expected_constants = array_merge($expected_constants, array(\n    \"MYSQLI_TYPE_NEWDECIMAL\"\t=> true,\n    \"MYSQLI_TYPE_BIT\"\t\t\t=> true,\n));\n$expected_constants['MYSQLI_NO_DEFAULT_VALUE_FLAG'] = true;\n$expected_constants = array_merge($expected_constants, array(\n    \"MYSQLI_STMT_ATTR_CURSOR_TYPE\"\t\t=> true,\n    \"MYSQLI_CURSOR_TYPE_NO_CURSOR\"\t\t=> true,\n    \"MYSQLI_CURSOR_TYPE_READ_ONLY\"\t\t=> true,\n    \"MYSQLI_CURSOR_TYPE_FOR_UPDATE\"\t\t=> true,\n    \"MYSQLI_CURSOR_TYPE_SCROLLABLE\"\t\t=> true,\n));\n$expected_constants = array_merge($expected_constants, array(\n    \"MYSQLI_STMT_ATTR_PREFETCH_ROWS\"\t=> true,\n));\nif ($version < 80000 || $version >= 100000 || $IS_MYSQLND) {\n    $expected_constants['MYSQLI_OPT_SSL_VERIFY_SERVER_CERT'] = true;\n}\n/* pretty dump test, but that is the best way to mimic mysql.c */\n$expected_constants[\"MYSQLI_DATA_TRUNCATED\"] = true;\nif ($IS_MYSQLND || (!$IS_MYSQLND && ($version > 50610))) {\n    /* could be that MySQL/libmysql 5.6.9 had the flag already but it was no stable release */\n    $expected_constants[\"MYSQLI_OPT_CAN_HANDLE_EXPIRED_PASSWORDS\"] = true;\n    $expected_constants[\"MYSQLI_CLIENT_CAN_HANDLE_EXPIRED_PASSWORDS\"] = true;\n}\nif ($IS_MYSQLND) {\n    $expected_constants[\"MYSQLI_TYPE_JSON\"]\t= true;\n}\nif (($version > 80021 && $constants['mysqli']['MYSQLI_IS_MARIADB']) || $IS_MYSQLND) {\n    $expected_constants['MYSQLI_OPT_LOAD_DATA_LOCAL_DIR'] = true;\n}\n$unexpected_constants = array();\nforeach ($constants as $group => $consts) {\n    foreach ($consts as $name => $value) {\n        if (stristr($name, 'mysqli')) {\n            $name = strtoupper($name);\n            if (isset($expected_constants[$name])) {\n                unset($expected_constants[$name]);\n            } else {\n                $unexpected_constants[$name] = $name;\n            }\n        }\n    }\n}\nif (!empty($unexpected_constants)) {\n    printf(\"Dumping list of unexpected constants\\n\");\n    var_dump($unexpected_constants);\n}\nif (!empty($expected_constants)) {\n    printf(\"Dumping list of missing constants\\n\");\n    var_dump($expected_constants);\n}\n?>")).toMatchSnapshot();
  });
});
