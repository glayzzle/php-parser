// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_stmt_multires.phpt
  it("Multiple result set with PS", function () {
    expect(parser.parseCode("<?php\n    require_once(\"connect.inc\");\n    require('table.inc');\n    $stmt = mysqli_stmt_init($link);\n    if (!$link->query('DROP PROCEDURE IF EXISTS p123')) {\n        printf(\"[001] [%d] %s\\n\", $link->error, $link->errno);\n    }\n    if (!$link->query(\"CREATE PROCEDURE p123() BEGIN SELECT id+12, CONCAT_WS('-',label,'ahoi') FROM test ORDER BY id LIMIT 1; SELECT id + 42, CONCAT_WS('---',label, label) FROM test ORDER BY id LIMIT 1; END\")) {\n        printf(\"[002] [%d] %s\\n\", $link->error, $link->errno);\n    }\n    if (!($stmt = $link->prepare(\"CALL p123\"))) {\n        printf(\"[003] [%d] %s\\n\", $stmt->error, $stmt->errno);\n    }\n    if (!$stmt->execute()) {\n        printf(\"[005] [%d] %s\\n\", $stmt->error, $stmt->errno);\n    }\n    $c_id = NULL;\n    $c_label = NULL;\n    if (!$stmt->bind_result($c_id, $c_label)) {\n        printf(\"[004] [%d] %s\\n\", $stmt->error, $stmt->errno);\n    }\n    var_dump(\"pre:\",$c_id, $c_label);\n    if (!$stmt->fetch()) {\n        printf(\"[006] [%d] %s\\n\", $stmt->error, $stmt->errno);\n    }\n    var_dump(\"post:\",$c_id, $c_label);\n    if ($stmt->fetch()) {\n        printf(\"[007] Shouldn't have fetched anything\\n\");\n        var_dump($c_id, $c_label);\n    }\n    if ($stmt->fetch()) {\n        printf(\"[008] No more rows expected\\n\");\n    }\n    if (!$stmt->more_results()) {\n        printf(\"[009] Expected more results\\n\");\n    } else {\n        var_dump(\"[009] next_result:\", $stmt->next_result());\n    }\n    if (!$stmt->bind_result($c_id, $c_label)) {\n        printf(\"[010] [%d] %s\\n\", $stmt->error, $stmt->errno);\n    }\n    var_dump(\"pre:\",$c_id, $c_label);\n    if (!$stmt->fetch()) {\n        printf(\"[011] [%d] %s\\n\", $stmt->error, $stmt->errno);\n    }\n    var_dump(\"post:\",$c_id, $c_label);\n    if ($stmt->fetch()) {\n        printf(\"[012] No more rows expected\\n\");\n    }\n    if (!$stmt->more_results()) {\n        printf(\"[013] Expected more results\\n\");\n    } else {\n        var_dump(\"[013] next_result:\", $stmt->next_result());\n    }\n    if ($stmt->more_results()) {\n        printf(\"[014] No more results expected\\n\");\n    } else {\n        printf(\"[014] No result, as expected\\n\");\n    }\n    $stmt->close();\n    $link->close();\n    echo \"done\";\n?>")).toMatchSnapshot();
  });
});
