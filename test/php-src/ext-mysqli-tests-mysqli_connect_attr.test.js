// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_connect_attr.phpt
  it("mysqli check the session_connect_attrs table for connection attributes", function () {
    expect(parser.parseCode("<?php\n    require_once(\"connect.inc\");\n    $tmp    = NULL;\n    $link   = NULL;\n    $res    = NULL;\n    if (!$link = mysqli_connect($host, $user, $passwd, $db, $port, $socket))\n        printf(\"[001] Cannot connect to the server using host=%s, user=%s, passwd=***, dbname=%s, port=%s, socket=%s\\n\",$host, $user, $db, $port, $socket);\n    //in case $host is empty, do not test for _server_host field\n    if (isset($host) && trim($host) != '') {\n        if (!$res = mysqli_query($link, \"select * from performance_schema.session_connect_attrs where ATTR_NAME='_server_host' and processlist_id = connection_id()\")) {\n            printf(\"[002] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        } else {\n            $tmp = mysqli_fetch_assoc($res);\n            if (!$tmp || !isset($tmp['ATTR_NAME'])) {\n                echo \"[003] _server_host missing\\n\";\n            } elseif ($tmp['ATTR_VALUE'] !== $host) {\n                printf(\"[004] _server_host value mismatch\\n\") ;\n            }\n            mysqli_free_result($res);\n        }\n    }\n    if (!$res = mysqli_query($link, \"select * from performance_schema.session_connect_attrs where ATTR_NAME='_client_name' and processlist_id = connection_id()\")) {\n        printf(\"[005] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    } else {\n        $tmp = mysqli_fetch_assoc($res);\n        if (!$tmp || !isset($tmp['ATTR_NAME'])) {\n            echo \"[006] _client_name missing\\n\";\n        } elseif ($tmp['ATTR_VALUE'] !== \"mysqlnd\") {\n            printf(\"[007] _client_name value mismatch\\n\") ;\n        }\n        mysqli_free_result($res);\n    }\n    printf(\"done!\");\n?>")).toMatchSnapshot();
  });
});
