// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_poll.phpt
  it("int mysqli_poll() simple", function () {
    expect(parser.parseCode("<?php\n    require_once('connect.inc');\n    function get_connection() {\n        global $host, $user, $passwd, $db, $port, $socket;\n        if (!$link = my_mysqli_connect($host, $user, $passwd, $db, $port, $socket))\n            printf(\"[001] [%d] %s\\n\", mysqli_connect_errno(), mysqli_connect_error());\n        return $link;\n    }\n    if (!$link = get_connection())\n        printf(\"[001] [%d] %s\\n\", mysqli_connect_errno(), mysqli_connect_error());\n    $read = $error = $reject = array($link);\n    if (0 !== ($tmp = (mysqli_poll($read, $error, $reject, 0, 1))))\n        printf(\"[009] Expecting int/0 got %s/%s\\n\", gettype($tmp), var_export($tmp, true));\n    $read = $error = $reject = array($link);\n    try {\n        mysqli_poll($read, $error, $reject, -1, 1);\n    } catch (\\ValueError $e) {\n        echo $e->getMessage() . \\PHP_EOL;\n    }\n    try {\n        mysqli_poll($read, $error, $reject, 0, -1);\n    } catch (\\ValueError $e) {\n        echo $e->getMessage() . \\PHP_EOL;\n    }\n    $link->close();\n    $read[0] = get_connection();\n    try {\n        mysqli_poll($read, $error, $reject, 0, 1);\n    } catch (\\Error $e) {\n        echo $e->getMessage() . \\PHP_EOL;\n    }\n    function poll_async($offset, $link, $links, $errors, $reject, $exp_ready, $use_oo_syntax) {\n        if ($exp_ready !== ($tmp = mysqli_poll($links, $errors, $reject, 0, 1000)))\n            printf(\"[%03d + 1] There should be %d links ready to read from, %d ready\\n\",\n                $exp_ready, $tmp);\n        foreach ($links as $mysqli) {\n            if ($use_oo_syntax) {\n                $res = $mysqli->reap_async_query();\n            } else {\n                $res = mysqli_reap_async_query($mysqli);\n            }\n            if (is_object($res)) {\n                printf(\"[%03d + 2] Can fetch resultset although no query has been run!\\n\", $offset);\n            } else if (mysqli_errno($mysqli) > 0) {\n                printf(\"[%03d + 3] Error indicated through links array: %d/%s\",\n                    $offset, mysqli_errno($mysqli), mysqli_error($mysqli));\n            } else {\n                printf(\"[%03d + 4] Cannot fetch and no error set - non resultset query (no SELECT)!\\n\", $offset);\n            }\n        }\n        foreach ($errors as $mysqli)\n            printf(\"[%03d + 5] Error on %d: %d/%s\\n\",\n                $offset, mysqli_thread_id($mysqli), mysqli_errno($mysqli), mysqli_error($mysqli));\n        foreach ($reject as $mysqli)\n            printf(\"[%03d + 6] Rejecting thread %d: %d/%s\\n\",\n                $offset, mysqli_thread_id($mysqli), mysqli_errno($mysqli), mysqli_error($mysqli));\n    }\n    // Connections on which no query has been send - 1\n    $link = get_connection();\n    $links = array($link);\n    $errors = array($link);\n    $reject = array($link);\n    poll_async(12, $link, $links, $errors, $reject, 0, false);\n    mysqli_close($link);\n    $link = get_connection();\n    $links = array($link);\n    $errors = array($link);\n    $reject = array($link);\n    poll_async(13, $link, $links, $errors, $reject, 0, true);\n    mysqli_close($link);\n    // Connections on which no query has been send - 2\n    // Difference: pass $links twice\n    $link = get_connection();\n    $links = array($link, $link);\n    $errors = array($link, $link);\n    $reject = array();\n    poll_async(14, $link, $links, $errors, $reject, 0, false);\n    // Connections on which no query has been send - 3\n    // Difference: pass two connections\n    $link = get_connection();\n    $links = array($link, get_connection());\n    $errors = array($link, $link);\n    $reject = array();\n    poll_async(15, $link, $links, $errors, $reject, 0, false);\n    // Reference mess...\n    $link = get_connection();\n    $links = array($link);\n    $errors = array($link);\n    $ref_errors =& $errors;\n    $reject = array();\n    poll_async(16, $link, $links, $ref_errors, $reject, 0, false);\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
