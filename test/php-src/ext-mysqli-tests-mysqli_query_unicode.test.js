// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_query_unicode.phpt
  it("mysqli_query() - unicode (cyrillic)", function () {
    expect(parser.parseCode("<?php\n    include_once(\"connect.inc\");\n    require_once('table.inc');\n    if (TRUE !== ($tmp = @mysqli_query($link, \"set names utf8\")))\n        printf(\"[002.5] Expecting TRUE, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (false !== ($tmp = mysqli_query($link, 'това не е ескюел')))\n        printf(\"[004] Expecting boolean/false, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (false !== ($tmp = mysqli_query($link, \"SELECT 'това е ескюел, но със обратна наклонена и g'\\g\")))\n        printf(\"[005] Expecting boolean/false, got %s/%s\\n\", gettype($tmp), $tmp);\n    if ((0 === mysqli_errno($link)) || ('' == mysqli_error($link)))\n        printf(\"[006] mysqli_errno()/mysqli_error should return some error\\n\");\n    if (!$res = mysqli_query($link, \"SELECT 'това ескюел, но с точка и запетая' AS правилен ; \"))\n        printf(\"[007] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    var_dump(mysqli_fetch_assoc($res));\n    mysqli_free_result($res);\n    if (false !== ($res = mysqli_query($link, \"SELECT 'това ескюел, но с точка и запетая' AS правилен ; SHOW VARIABLES\")))\n        printf(\"[008] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (mysqli_get_server_version($link) > 50000) {\n        // let's try to play with stored procedures\n        mysqli_query($link, 'DROP PROCEDURE IF EXISTS процедурка');\n        if (mysqli_query($link, 'CREATE PROCEDURE процедурка(OUT версия VARCHAR(25)) BEGIN SELECT VERSION() INTO версия; END;')) {\n            $res = mysqli_query($link, 'CALL процедурка(@version)');\n            $res = mysqli_query($link, 'SELECT @version AS п_версия');\n            $tmp = mysqli_fetch_assoc($res);\n            if (!is_array($tmp) || empty($tmp) || !isset($tmp['п_версия']) || ('' == $tmp['п_версия'])) {\n                printf(\"[008a] Expecting array [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n                var_dump($tmp);\n            }\n            mysqli_free_result($res);\n        } else {\n            printf(\"[009] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        }\n        mysqli_query($link, 'DROP FUNCTION IF EXISTS функцийка');\n        if (mysqli_query($link, 'CREATE FUNCTION функцийка( параметър_версия VARCHAR(25)) RETURNS VARCHAR(25) DETERMINISTIC RETURN параметър_версия;')) {\n            $res = mysqli_query($link, 'SELECT функцийка(VERSION()) AS ф_версия');\n            $tmp = mysqli_fetch_assoc($res);\n            if (!is_array($tmp) || empty($tmp) || !isset($tmp['ф_версия']) || ('' == $tmp['ф_версия'])) {\n                printf(\"[009a] Expecting array [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n                var_dump($tmp);\n            }\n            mysqli_free_result($res);\n        } else {\n            printf(\"[010] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        }\n    }\n    mysqli_close($link);\n    try {\n        mysqli_query($link, \"SELECT id FROM test\");\n    } catch (Error $exception) {\n        echo $exception->getMessage() . \"\\n\";\n    }\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
