// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/oci8/tests/bug51291_1.phpt
  it("Bug #51291 (oci_error() doesn't report last error when called two times)", function () {
    expect(parser.parseCode("<?php\nrequire(__DIR__.'/connect.inc');\necho \"Test 1 - Parse\\n\";\n$s = @oci_parse($c, \"select ' from dual\");\nif (!$s) {\n    var_dump(oci_error($c));\n    echo \"2nd call\\n\";\n    var_dump(oci_error($c));\n}\necho \"\\nTest 2 - Parse\\n\";\n$s = @oci_parse($c, \"select ' from dual\");\nif (!$s) {\n    var_dump(oci_error(), oci_error($c));\n    echo \"2nd call\\n\";\n    var_dump(oci_error(), oci_error($c));\n}\necho \"\\nTest 3 - Execute\\n\";\n$s = @oci_parse($c, 'select doesnotexist from dual');\n$r = @oci_execute($s, OCI_DEFAULT);\nif (!$r) {\n    var_dump(oci_error($s));\n    echo \"2nd call\\n\";\n    var_dump(oci_error($s));\n}\necho \"\\nTest 4 - Execute - consecutive oci_error calls of different kinds\\n\";\n$s = @oci_parse($c, 'select doesnotexist from dual');\n$r = @oci_execute($s, OCI_DEFAULT);\nif (!$r) {\n    var_dump(oci_error(), oci_error($c), oci_error($s));\n    echo \"2nd call\\n\";\n    var_dump(oci_error(), oci_error($c), oci_error($s));\n}\necho \"\\nTest 5 - Execute - after oci_rollback\\n\";\n$s = @oci_parse($c, 'select doesnotexist from dual');\n$r = @oci_execute($s, OCI_DEFAULT);\nif (!$r) {\n    var_dump(oci_error(), oci_error($c), oci_error($s));\n    $r = oci_rollback($c);\n    echo \"Rollback status is \";\n    if (is_null($r)) echo \"null\";\n    else if ($r === false) echo \"false\";\n    else if ($r === true) echo \"true\";\n    else echo $r;\n    echo \"\\n\";\n    echo \"2nd call after oci_rollback\\n\";\n    var_dump(oci_error(), oci_error($c), oci_error($s));\n}\necho \"\\nTest 6 - Execute - after successful 2nd query with new handle\\n\";\n$s = @oci_parse($c, 'select doesnotexist from dual');\n$r = @oci_execute($s, OCI_DEFAULT);\nif (!$r) {\n    var_dump(oci_error(), oci_error($c), oci_error($s));\n    $s2 = oci_parse($c, 'select 1 from dual');\n    $r = oci_execute($s2, OCI_DEFAULT);\n    echo \"Execute status is \";\n    if (is_null($r)) echo \"null\";\n    else if ($r === false) echo \"false\";\n    else if ($r === true) echo \"true\";\n    else echo $r;\n    echo \"\\n\";\n    echo \"2nd call after successful execute\\n\";\n    var_dump(oci_error(), oci_error($c), oci_error($s), oci_error($s2));\n}\necho \"\\nTest 7 - Execute - after successful 2nd query with same handle\\n\";\n$s = @oci_parse($c, 'select doesnotexist from dual');\n$r = @oci_execute($s, OCI_DEFAULT);\nif (!$r) {\n    var_dump(oci_error(), oci_error($c), oci_error($s));\n    $s = oci_parse($c, 'select 1 from dual');\n    $r = oci_execute($s, OCI_DEFAULT);\n    echo \"Execute status is \";\n    if (is_null($r)) echo \"null\";\n    else if ($r === false) echo \"false\";\n    else if ($r === true) echo \"true\";\n    else echo $r;\n    echo \"\\n\";\n    echo \"2nd call after successful execute\\n\";\n    var_dump(oci_error(), oci_error($c), oci_error($s));\n}\necho \"\\nTest 8 - Execute - after unsuccessful 2nd query with new handle\\n\";\n$s = @oci_parse($c, 'select doesnotexist from dual');\n$r = @oci_execute($s, OCI_DEFAULT);\nif (!$r) {\n    var_dump(oci_error(), oci_error($c), oci_error($s));\n    $s2 = oci_parse($c, 'select reallynothere from dual');\n    $r = oci_execute($s2, OCI_DEFAULT);\n    echo \"Execute status is \";\n    if (is_null($r)) echo \"null\";\n    else if ($r === false) echo \"false\";\n    else if ($r === true) echo \"true\";\n    else echo $r;\n    echo \"\\n\";\n    echo \"2nd call after unsuccessful execute\\n\";\n    var_dump(oci_error(), oci_error($c), oci_error($s), oci_error($s2));\n}\necho \"\\nTest 9 - Execute - after unsuccessful 2nd query with same handle\\n\";\n$s = @oci_parse($c, 'select doesnotexist from dual');\n$r = @oci_execute($s, OCI_DEFAULT);\nif (!$r) {\n    var_dump(oci_error(), oci_error($c), oci_error($s));\n    $s = oci_parse($c, 'select reallynothere from dual');\n    $r = oci_execute($s, OCI_DEFAULT);\n    echo \"Execute status is \";\n    if (is_null($r)) echo \"null\";\n    else if ($r === false) echo \"false\";\n    else if ($r === true) echo \"true\";\n    else echo $r;\n    echo \"\\n\";\n    echo \"2nd call after unsuccessful execute\\n\";\n    var_dump(oci_error(), oci_error($c), oci_error($s));\n}\n?>")).toMatchSnapshot();
  });
});
