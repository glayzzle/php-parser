// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_stmt_bind_param_call_user_func.phpt
  it("mysqli_stmt_bind_param used with call_user_func_array() (see also bug #43568)", function () {
    expect(parser.parseCode("<?php\n    require('connect.inc');\n    require('table.inc');\n    if (!$stmt = mysqli_stmt_init($link))\n        printf(\"[001] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!mysqli_stmt_prepare($stmt, 'SELECT id, label FROM test WHERE id = ?'))\n        printf(\"[002] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $id = 1;\n    if (!mysqli_stmt_bind_param($stmt, 'i', $id) ||\n        !mysqli_stmt_execute($stmt))\n        printf(\"[003] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $id = $label = null;\n    if (!mysqli_stmt_bind_result($stmt, $id, $label) ||\n        (true !== mysqli_stmt_fetch($stmt)))\n        printf(\"[004] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    print \"Regular, procedural, using variables\\n\";\n    var_dump($id);\n    var_dump($label);\n    mysqli_stmt_close($stmt);\n    if (!$stmt = mysqli_stmt_init($link))\n        printf(\"[005] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!mysqli_stmt_prepare($stmt, 'SELECT id, label FROM test WHERE id = ?'))\n        printf(\"[006] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $types = 'i';\n    $id = 1;\n    $params = array(\n        0 => &$stmt,\n        1 => &$types,\n        2 => &$id\n    );\n    if (!call_user_func_array('mysqli_stmt_bind_param', $params))\n        printf(\"[007] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    if (!mysqli_stmt_execute($stmt))\n        printf(\"[008] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $id = $label = null;\n    if (!mysqli_stmt_bind_result($stmt, $id, $label) ||\n        (true !== mysqli_stmt_fetch($stmt)))\n        printf(\"[009] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    print \"Call user func, procedural, using references for everything\\n\";\n    var_dump($id);\n    var_dump($label);\n    mysqli_stmt_close($stmt);\n    if (!$stmt = mysqli_stmt_init($link))\n        printf(\"[010] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!mysqli_stmt_prepare($stmt, 'SELECT id, label FROM test WHERE id = ?'))\n        printf(\"[011] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $types = 'i';\n    $id = 1;\n    $params = array(\n        0 => &$types,\n        1 => &$id\n    );\n    if (!call_user_func_array(array($stmt, 'bind_param'), $params))\n        printf(\"[012] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    if (!mysqli_stmt_execute($stmt))\n        printf(\"[013] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $id = $label = null;\n    if (!mysqli_stmt_bind_result($stmt, $id, $label) ||\n        (true !== mysqli_stmt_fetch($stmt)))\n        printf(\"[014] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    print \"Call user func, object oriented, using references for everything\\n\";\n    var_dump($id);\n    var_dump($label);\n    mysqli_stmt_close($stmt);\n    if (!$stmt = mysqli_stmt_init($link))\n        printf(\"[015] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!mysqli_stmt_prepare($stmt, 'SELECT id, label FROM test WHERE id = ?'))\n        printf(\"[016] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $types = 'i';\n    $id = 1;\n    $params = array(\n        0 => $types,\n        1 => &$id\n    );\n    if (!call_user_func_array(array($stmt, 'bind_param'), $params))\n        printf(\"[017] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    if (!mysqli_stmt_execute($stmt))\n        printf(\"[018] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $id = $label = null;\n    if (!mysqli_stmt_bind_result($stmt, $id, $label) ||\n        (true !== mysqli_stmt_fetch($stmt)))\n        printf(\"[019] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    print \"Call user func, object oriented, using variable for types. using references for bound parameter\\n\";\n    var_dump($id);\n    var_dump($label);\n    mysqli_stmt_close($stmt);\n    if (!$stmt = mysqli_stmt_init($link))\n        printf(\"[020] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!mysqli_stmt_prepare($stmt, 'SELECT id, label FROM test WHERE id = ?'))\n        printf(\"[021] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $id = 1;\n    $params = array(\n        0 => 'i',\n        1 => &$id\n    );\n    if (!call_user_func_array(array($stmt, 'bind_param'), $params))\n        printf(\"[022] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    if (!mysqli_stmt_execute($stmt))\n        printf(\"[023] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $id = $label = null;\n    if (!mysqli_stmt_bind_result($stmt, $id, $label) ||\n        (true !== mysqli_stmt_fetch($stmt)))\n        printf(\"[024] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    print \"Call user func, object oriented, using constant for types. using references for bound parameter\\n\";\n    var_dump($id);\n    var_dump($label);\n    mysqli_stmt_close($stmt);\n    if (!$stmt = mysqli_stmt_init($link))\n        printf(\"[025] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!mysqli_stmt_prepare($stmt, 'SELECT id, label FROM test WHERE id = ?'))\n        printf(\"[026] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $types = 'i';\n    $id = 1;\n    $params = array(\n        0 => &$stmt,\n        1 => $types,\n        2 => &$id\n    );\n    if (!call_user_func_array('mysqli_stmt_bind_param', $params))\n        printf(\"[027] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    if (!mysqli_stmt_execute($stmt))\n        printf(\"[028] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $id = $label = null;\n    if (!mysqli_stmt_bind_result($stmt, $id, $label) ||\n        (true !== mysqli_stmt_fetch($stmt)))\n        printf(\"[029] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    print \"Call user func, procedural, using references for everything but using variable for types\\n\";\n    var_dump($id);\n    var_dump($label);\n    mysqli_stmt_close($stmt);\n    if (!$stmt = mysqli_stmt_init($link))\n        printf(\"[025] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!mysqli_stmt_prepare($stmt, 'SELECT id, label FROM test WHERE id = ?'))\n        printf(\"[026] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $types = 'i';\n    $id = 1;\n    $params = array(\n        0 => $stmt,\n        1 => $types,\n        2 => &$id\n    );\n    if (!call_user_func_array('mysqli_stmt_bind_param', $params))\n        printf(\"[027] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    if (!mysqli_stmt_execute($stmt))\n        printf(\"[028] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $id = $label = null;\n    if (!mysqli_stmt_bind_result($stmt, $id, $label) ||\n        (true !== mysqli_stmt_fetch($stmt)))\n        printf(\"[029] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    print \"Call user func, procedural, using references for bound parameter, using variables for resource and types\\n\";\n    var_dump($id);\n    var_dump($label);\n    mysqli_stmt_close($stmt);\n    if (!$stmt = mysqli_stmt_init($link))\n        printf(\"[030] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!mysqli_stmt_prepare($stmt, 'SELECT id, label FROM test WHERE id = ?'))\n        printf(\"[031] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $types = 'i';\n    $id = 1;\n    $params = array(\n        0 => $stmt,\n        1 => $types,\n        2 => &$id\n    );\n    if (!call_user_func_array('mysqli_stmt_bind_param', $params))\n        printf(\"[032] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    if (!mysqli_stmt_execute($stmt))\n        printf(\"[033] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $id = $label = null;\n    if (!mysqli_stmt_bind_result($stmt, $id, $label) ||\n        (true !== mysqli_stmt_fetch($stmt)))\n        printf(\"[034] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    print \"Call user func, procedural, using references for bound parameter, using variables for resource and types\\n\";\n    var_dump($id);\n    var_dump($label);\n    mysqli_stmt_close($stmt);\n    if (!$stmt = mysqli_stmt_init($link))\n        printf(\"[035] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!mysqli_stmt_prepare($stmt, 'SELECT id, label FROM test WHERE id = ?'))\n        printf(\"[036] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $id = 1;\n    $params = array(\n        0 => $stmt,\n        1 => 'i',\n        2 => &$id\n    );\n    if (!call_user_func_array('mysqli_stmt_bind_param', $params))\n        printf(\"[037] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    if (!mysqli_stmt_execute($stmt))\n        printf(\"[038] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $id = $label = null;\n    if (!mysqli_stmt_bind_result($stmt, $id, $label) ||\n        (true !== mysqli_stmt_fetch($stmt)))\n        printf(\"[039] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    print \"Call user func, procedural, using references for bound parameter, using variable for resource, using constant for types\\n\";\n    var_dump($id);\n    var_dump($label);\n    mysqli_stmt_close($stmt);\n    if (!$stmt = mysqli_stmt_init($link))\n        printf(\"[040] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!mysqli_stmt_prepare($stmt, 'SELECT id, label FROM test WHERE id = ?'))\n        printf(\"[041] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $id = 1;\n    if (!call_user_func_array('mysqli_stmt_bind_param', array($stmt, 'i', &$id)))\n        printf(\"[042] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    if (!mysqli_stmt_execute($stmt))\n        printf(\"[043] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $id = $label = null;\n    if (!mysqli_stmt_bind_result($stmt, $id, $label) ||\n        (true !== mysqli_stmt_fetch($stmt)))\n        printf(\"[044] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    print \"Call user func, procedural, using references for bound parameter, using variable for resource, using constant for types, array\\n\";\n    var_dump($id);\n    var_dump($label);\n    //\n    // Any of those shall fail - see also bugs.php.net/43568\n    //\n    mysqli_stmt_close($stmt);\n    if (!$stmt = mysqli_stmt_init($link))\n        printf(\"[045] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!mysqli_stmt_prepare($stmt, 'SELECT id, label FROM test WHERE id = ?'))\n        printf(\"[046] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $id = 1;\n    $params = array(\n        0 => 'i',\n        1 => &$id\n    );\n    if (!call_user_func_array(array($stmt, 'bind_param'), $params))\n        printf(\"[047] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    if (!mysqli_stmt_execute($stmt))\n        printf(\"[048] [%d] (Message might vary with MySQL Server version, e.g. No data supplied for parameters in prepared statement)\\n\", mysqli_stmt_errno($stmt));\n    mysqli_stmt_close($stmt);\n    if (!$stmt = mysqli_stmt_init($link))\n        printf(\"[049] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!mysqli_stmt_prepare($stmt, 'SELECT id, label FROM test WHERE id = ?'))\n        printf(\"[050] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $types = 'i';\n    $id = 1;\n    $params = array(\n        0 => $stmt,\n        1 => 'i',\n        2 => &$id\n    );\n    if (!call_user_func_array('mysqli_stmt_bind_param', $params))\n        printf(\"[051] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    if (!mysqli_stmt_execute($stmt))\n        printf(\"[052] [%d] (Message might vary with MySQL Server version, e.g. No data supplied for parameters in prepared statement)\\n\", mysqli_stmt_errno($stmt));\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
