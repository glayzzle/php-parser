// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_stmt_get_result_non_select.phpt
  it("mysqli_stmt_get_result() - SHOW, DESCRIBE, EXPLAIN", function () {
    expect(parser.parseCode("<?php\n    /*\n    NOTE: no datatype tests here! This is done by\n    mysqli_stmt_bind_result.phpt already. Restrict\n    this test case to the basics.\n    */\n    require('table.inc');\n    if (!$stmt = mysqli_stmt_init($link))\n        printf(\"[001] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (mysqli_query($link, 'PREPARE mystmt FROM \"SHOW ENGINES\"')) {\n        mysqli_query($link, 'DEALLOCATE PREPARE mystmt');\n        if (!$stmt->prepare('SHOW ENGINES') ||\n            !$stmt->execute())\n            printf(\"[002] [%d] %s\\n\", $stmt->errno, $stmt->error);\n        if (!$res = $stmt->get_result())\n            printf(\"[003] [%d] %s\\n\", $stmt->errno, $stmt->error);\n        $engines = mysqli_fetch_all($res, MYSQLI_NUM);\n        if\t(empty($engines)) {\n            printf(\"[004] It is very unlikely that SHOW ENGINES returns no data, check manually\\n\");\n        } else {\n            $found = false;\n            foreach ($engines as $engine) {\n                if (stristr($engine[0], 'MyISAM')) {\n                    $found = true;\n                    break;\n                }\n            }\n            if (!$found)\n                printf(\"[005] It is very unlikely that SHOW ENGINES does not show MyISAM, check manually\\n\");\n        }\n        mysqli_free_result($res);\n    }\n    if (mysqli_query($link, 'PREPARE mystmt FROM \"DESCRIBE test id\"')) {\n        mysqli_query($link, 'DEALLOCATE PREPARE mystmt');\n        if (!$stmt->prepare('DESCRIBE test id') ||\n            !$stmt->execute())\n            printf(\"[006] [%d] %s\\n\", $stmt->errno, $stmt->error);\n        if (!$res = $stmt->get_result())\n            printf(\"[007] [%d] %s\\n\", $stmt->errno, $stmt->error);\n        $description = mysqli_fetch_assoc($res);\n        if ($description['Field'] != 'id') {\n            printf(\"[008] Returned data seems wrong, [%d] %s\\n\",\n                mysqli_errno($link), mysqli_error($link));\n            var_dump($description);\n        }\n        mysqli_free_result($res);\n    }\n    if (mysqli_query($link, 'PREPARE mystmt FROM \"EXPLAIN SELECT id FROM test\"')) {\n        mysqli_query($link, 'DEALLOCATE PREPARE mystmt');\n        if (!$stmt->prepare('EXPLAIN SELECT id FROM test') ||\n            !$stmt->execute())\n            printf(\"[009] [%d] %s\\n\", $stmt->errno, $stmt->error);\n        if (!$res = $stmt->get_result())\n            printf(\"[010] [%d] %s\\n\", $stmt->errno, $stmt->error);\n        $tmp = mysqli_fetch_assoc($res);\n        if (empty($tmp))\n            printf(\"[011] Empty EXPLAIN result set seems wrong, check manually, [%d] %s\\n\",\n                mysqli_errno($link), mysqli_error($link));\n        mysqli_free_result($res);\n    }\n    mysqli_close($link);\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
