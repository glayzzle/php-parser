// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_select_db.phpt
  it("mysqli_select_db()", function () {
    expect(parser.parseCode("<?php\n    require_once(\"connect.inc\");\n    require_once(\"table.inc\");\n    if (!$link = my_mysqli_connect($host, $user, $passwd, $db, $port, $socket))\n        printf(\"[003] Cannot connect to the server using host=%s, user=%s, passwd=***, dbname=%s, port=%s, socket=%s\\n\",\n            $host, $user, $db, $port, $socket);\n    /* does not make too much sense, unless we have access to at least one more database than $db */\n    if (!mysqli_select_db($link, $db))\n        printf(\"[005] Cannot select DB %s, [%d] %s\\n\", $db, mysqli_errno($link), mysqli_error($link));\n    if (!$res = mysqli_query($link, \"SELECT DATABASE() AS dbname\"))\n        printf(\"[006] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!$row = mysqli_fetch_assoc($res))\n        printf(\"[007] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if ($row['dbname'] !== (string)$db)\n        printf(\"[008] Expecting database '%s', found '%s'\\n\", $db, $row['dbname']);\n    mysqli_free_result($res);\n    if (mysqli_select_db($link, 'mysql')) {\n        // Yippie, a second database to play with - that's great because mysqli_select_db\n        // ($db) was done by mysqli__connect() already and the previous test\n        // was quite useless\n        if (!$res = mysqli_query($link, \"SELECT DATABASE() AS dbname\"))\n            printf(\"[009] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        if (!$row = mysqli_fetch_assoc($res))\n            printf(\"[010] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        if (strtolower($row['dbname']) !== 'mysql')\n            printf(\"[011] Expecting database 'mysql', found '%s'\\n\", $row['dbname']);\n        mysqli_free_result($res);\n    }\n    if (!$link->select_db($db))\n        printf(\"[012] Failed to set '%s' as current DB; [%d] %s\\n\", $link->errno, $link->error);\n    if (!$res = mysqli_query($link, \"SELECT DATABASE() AS dbname\"))\n        printf(\"[013] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!$row = mysqli_fetch_assoc($res))\n        printf(\"[014] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    $current_db = $row['dbname'];\n    mysqli_report(MYSQLI_REPORT_OFF);\n    mysqli_select_db($link, 'I can not imagine that this database exists');\n    mysqli_report(MYSQLI_REPORT_ERROR);\n    ob_start();\n    mysqli_select_db($link, 'I can not imagine that this database exists');\n    $output = ob_get_contents();\n    ob_end_clean();\n    if (!stristr($output, \"1049\") && !stristr($output, \"1044\") && !stristr($output, \"1045\")) {\n      /* Error: 1049 SQLSTATE: 42000 (ER_BAD_DB_ERROR) Message: Unknown database '%s'  */\n      /* Error: 1044 SQLSTATE: 42000 (ER_DBACCESS_DENIED_ERROR) Message: Access denied for user '%s'@'%s' to database '%s' */\n      /* Error: 1045 SQLSTATE: 28000 (ER_ACCESS_DENIED_ERROR) Message: Access denied for user '%s'@'%s' (using password: %s) */\n      echo $output;\n    }\n    if (!$res = mysqli_query($link, \"SELECT DATABASE() AS dbname\"))\n        printf(\"[015] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!$row = mysqli_fetch_assoc($res))\n        printf(\"[016] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (strtolower($row['dbname']) != strtolower($current_db))\n        printf(\"[017] Current DB should not change if set fails\\n\");\n    if (!$res = $link->query(\"SELECT id FROM test WHERE id = 1\"))\n        printf(\"[018] [%d] %s\\n\");\n    $row = $res->fetch_assoc();\n    $res->free();\n    mysqli_close($link);\n    try {\n        mysqli_select_db($link, $db);\n    } catch (Error $exception) {\n        echo $exception->getMessage() . \"\\n\";\n    }\n    print \"done!\\n\";\n?>")).toMatchSnapshot();
  });
});
