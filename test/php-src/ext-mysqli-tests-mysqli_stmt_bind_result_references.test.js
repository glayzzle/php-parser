// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_stmt_bind_result_references.phpt
  it("mysqli_stmt_bind_result() - playing with references", function () {
    expect(parser.parseCode("<?php\n    require('table.inc');\n    $stmt = mysqli_stmt_init($link);\n    if (!mysqli_stmt_prepare($stmt, \"SELECT id, label FROM test ORDER BY id LIMIT 1\"))\n        printf(\"[001] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    if (!mysqli_stmt_prepare($stmt, \"SELECT id, label FROM test ORDER BY id LIMIT 1\"))\n        printf(\"[001] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    print \"plain vanilla...\\n\";\n    unset($id); unset($label);\n    $id = $label = null;\n    if (true !== ($tmp = mysqli_stmt_bind_result($stmt, $id, $label)))\n        printf(\"[002] Expecting boolean/true, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (!mysqli_stmt_execute($stmt) || !mysqli_stmt_fetch($stmt) || mysqli_stmt_fetch($stmt))\n        printf(\"[003] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    var_dump($id);\n    var_dump($label);\n    print \"reference, one level...\\n\";\n    unset($id); unset($id_ref); unset($label); unset($label_ref);\n    $id = null;\n    $id_ref = &$id;\n    $label = null;\n    $label_ref = &$label;\n    if (true !== ($tmp = mysqli_stmt_bind_result($stmt, $id_ref, $label_ref)))\n        printf(\"[004] Expecting boolean/true, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (!mysqli_stmt_execute($stmt) || !mysqli_stmt_fetch($stmt) || mysqli_stmt_fetch($stmt))\n        printf(\"[005] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    var_dump($id_ref);\n    var_dump($id);\n    var_dump($label_ref);\n    var_dump($label);\n    print \"reference, two levels...\\n\";\n    unset($id); unset($id_ref); unset($id_ref_ref); unset($label); unset($label_ref); unset($label_ref_ref);\n    $id = null;\n    $id_ref = &$id;\n    $id_ref_ref = &$id_ref;\n    $label = null;\n    $label_ref = &$label;\n    $label_ref_ref = &$label_ref;\n    if (true !== ($tmp = mysqli_stmt_bind_result($stmt, $id_ref_ref, $label_ref_ref)))\n        printf(\"[006] Expecting boolean/true, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (!mysqli_stmt_execute($stmt) || !mysqli_stmt_fetch($stmt) || mysqli_stmt_fetch($stmt))\n        printf(\"[007] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    var_dump($id_ref_ref);\n    var_dump($id_ref);\n    var_dump($id);\n    var_dump($label_ref_ref);\n    var_dump($label_ref);\n    var_dump($label);\n    print \"reference, \\$GLOBALS...\\n\";\n    unset($id); unset($id_ref); unset($label); unset($label_ref);\n    $id = 100;\n    $id_ref = &$GLOBALS['id'];\n    $label = null;\n    $label_ref = &$GLOBALS['label'];\n    if (true !== ($tmp = mysqli_stmt_bind_result($stmt, $id_ref, $label_ref)))\n        printf(\"[008] Expecting boolean/true, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (!mysqli_stmt_execute($stmt) || !mysqli_stmt_fetch($stmt) || mysqli_stmt_fetch($stmt))\n        printf(\"[009] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    var_dump($id_ref);\n    var_dump($id);\n    var_dump($label_ref);\n    var_dump($label);\n    print \"reference, same target...\\n\";\n    $id = null;\n    $label = &$id;\n    if (true !== ($tmp = mysqli_stmt_bind_result($stmt, $id, $label)))\n        printf(\"[010] Expecting boolean/true, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (!mysqli_stmt_execute($stmt) || !mysqli_stmt_fetch($stmt) || mysqli_stmt_fetch($stmt))\n        printf(\"[011] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    var_dump($id);\n    var_dump($label);\n    print \"reference, simple object...\\n\";\n    unset($obj);\n    $obj = new stdClass();\n    $obj->id = null;\n    $obj->label = null;\n    if (true !== ($tmp = mysqli_stmt_bind_result($stmt, $obj->id, $obj->label)))\n        printf(\"[012] Expecting boolean/true, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (!mysqli_stmt_execute($stmt) || !mysqli_stmt_fetch($stmt) || mysqli_stmt_fetch($stmt))\n        printf(\"[013] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    var_dump($obj->id);\n    var_dump($obj->label);\n    print \"reference, simple object w reference...\\n\";\n    unset($id); unset($label); unset($obj);\n    $obj = new stdClass();\n    $obj->id = null;\n    $obj->label = null;\n    $id = &$obj->id;\n    $label = &$obj->label;\n    if (true !== ($tmp = mysqli_stmt_bind_result($stmt, $id, $label)))\n        printf(\"[012] Expecting boolean/true, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (!mysqli_stmt_execute($stmt) || !mysqli_stmt_fetch($stmt) || mysqli_stmt_fetch($stmt))\n        printf(\"[013] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    var_dump($obj->id);\n    var_dump($obj->label);\n    print \"reference, simple object w reference, change after bind...\\n\";\n    unset($id); unset($label); unset($obj);\n    $obj = new stdClass();\n    $obj->id = null;\n    $obj->label = null;\n    $id = &$obj->id;\n    $label = &$obj->label;\n    if (true !== ($tmp = mysqli_stmt_bind_result($stmt, $id, $label)))\n        printf(\"[012] Expecting boolean/true, got %s/%s\\n\", gettype($tmp), $tmp);\n    $label = &$obj->id;\n    $id = null;\n    if (!mysqli_stmt_execute($stmt) || !mysqli_stmt_fetch($stmt) || mysqli_stmt_fetch($stmt))\n        printf(\"[013] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    var_dump($obj->id);\n    var_dump($id);\n    var_dump($obj->label);\n    var_dump($label);\n    print \"reference, one level, change after bind...\\n\";\n    unset($id); unset($label); unset($id_ref); unset($label_ref);\n    $id = null;\n    $id_ref = &$id;\n    $label = null;\n    $label_ref = &$label;\n    if (true !== ($tmp = mysqli_stmt_bind_result($stmt, $id_ref, $label_ref)))\n        printf(\"[014] Expecting boolean/true, got %s/%s\\n\", gettype($tmp), $tmp);\n    $id_ref = 1;\n    $label_ref = 1;\n    if (!mysqli_stmt_execute($stmt) || !mysqli_stmt_fetch($stmt) || mysqli_stmt_fetch($stmt))\n        printf(\"[015] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    var_dump($id_ref);\n    var_dump($id);\n    var_dump($label_ref);\n    var_dump($label);\n    print \"reference, circle...\\n\";\n    unset($id); unset($label_a); unset($label_b);\n    $id = null;\n    $label_a = &$label_b;\n    $label_b = &$label_a;\n    if (true !== ($tmp = mysqli_stmt_bind_result($stmt, $id, $label_a)))\n        printf(\"[016] Expecting boolean/true, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (!mysqli_stmt_execute($stmt) || !mysqli_stmt_fetch($stmt) || mysqli_stmt_fetch($stmt))\n        printf(\"[017] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    var_dump($id);\n    var_dump($label_a);\n    var_dump($label_b);\n    print \"reference, object, forward declaration...\\n\";\n    unset($bar); unset($id); unset($label_ref);\n    class foo {\n        public $foo;\n        public function __construct() {\n            $this->foo = &$this->bar;\n        }\n    }\n    class bar extends foo {\n        public $bar = null;\n    }\n    $bar = new bar();\n    $id = null;\n    $label_ref = &$bar->bar;\n    if (true !== ($tmp = mysqli_stmt_bind_result($stmt, $id, $label_ref)))\n        printf(\"[018] Expecting boolean/true, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (!mysqli_stmt_execute($stmt) || !mysqli_stmt_fetch($stmt) || mysqli_stmt_fetch($stmt))\n        printf(\"[019] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    var_dump($id);\n    var_dump($bar);\n    var_dump($label_ref);\n    print \"references, object, private...\\n\";\n    unset($bar); unset($id); unset($label);\n    class mega_bar extends bar {\n        private $id;\n        public $id_ref;\n        public function __construct() {\n            parent::__construct();\n            $this->id_ref = &$this->id;\n        }\n    }\n    $bar = new mega_bar();\n    $id = &$bar->id_ref;\n    $label = &$bar->foo;\n    if (true !== ($tmp = mysqli_stmt_bind_result($stmt, $id, $label)))\n        printf(\"[020] Expecting boolean/true, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (!mysqli_stmt_execute($stmt) || !mysqli_stmt_fetch($stmt) || mysqli_stmt_fetch($stmt))\n        printf(\"[021] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    var_dump($id);\n    var_dump($label);\n    var_dump($bar);\n    mysqli_stmt_close($stmt);\n    mysqli_close($link);\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
