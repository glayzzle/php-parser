// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/date/tests/bug73858.phpt
  it("Bug #73858: diff() of two relative/described DateTimes is wrong", function () {
    expect(parser.parseCode("<?php\n/*\nIn the \"verbose setup method\" I'm trying setup the DateTime object myself\nto see if it's the format string which is parsed in correctly or if it's the DateTime\nobject which is breaking stuff. From the testing it appears DateTime is broken somehow.\n*/\n$ss = 'february first day of last month midnight';\n$es = 'february first day of this month midnight - 1 second';\n$s = new DateTime($ss);\n$e = new DateTime($es);\n$d= $e->diff($s);\nvar_dump($d->days); // 0 ... but should be 30\n$s = (new DateTime(\"now\"))->setTimestamp(strtotime($ss)); // verbose setup method\n$e = (new DateTime(\"now\"))->setTimestamp(strtotime($es)); // verbose setup method\n$d = $e->diff($s);\nvar_dump($d->days); // 30 ... and should be 30\n/*\nNext we will try mix/match the code to see what happens, surprisingly it seems that the end date ($e)\nis the important one, if it uses the verbose method it returns the correct values.\n*/\n$s = (new DateTime(\"now\"))->setTimestamp(strtotime($ss)); // verbose setup method\n$e = new DateTime($es);\n$d= $e->diff($s);\nvar_dump($d->days); // 0 ... but should be 30\n$s = new DateTime($ss);\n$e = (new DateTime(\"now\"))->setTimestamp(strtotime($es)); // verbose setup method\n$d= $e->diff($s);\nvar_dump($d->days); // 30 ... and should be 30\n/*\nThis test just proves that the $e date is important BUT NOT because it's the one we call the diff() method\non, that's just coincidental that seems to imply that the \"- 1 second\" in the date string is the problem.\n*/\n$s = new DateTime($ss);\n$e = (new DateTime(\"now\"))->setTimestamp(strtotime($es)); // verbose setup method\n$d= $s->diff($e);\nvar_dump($d->days); // 30 ... and should be 30\n/*\n[Workaround]\nThis final test seems to prove that the input string is important and that the \"- 1 second\" has a negative knock-on\neffect on the results of the diff. By modifying the datetime with ->modify everything works as expected ...\nit just means you have to be careful of how we work with DateTimes .\n*/\n$s = new DateTime($ss);\n$e = new DateTime('february first day of this month midnight');\n$e->modify('- 1 second');\nvar_dump($e->diff($s)->days); // 30 ... and should be 30\n?>")).toMatchSnapshot();
  });
});
