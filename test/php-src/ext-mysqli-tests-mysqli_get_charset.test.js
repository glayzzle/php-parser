// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_get_charset.phpt
  it("mysqli_get_charset()", function () {
    expect(parser.parseCode("<?php\n    require_once(\"connect.inc\");\n    require('table.inc');\n    if (!$res = mysqli_query($link, 'SELECT version() AS server_version'))\n        printf(\"[004] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    $tmp = mysqli_fetch_assoc($res);\n    mysqli_free_result($res);\n    $version = explode('.', $tmp['server_version']);\n    if (empty($version))\n        printf(\"[005] Cannot determine server version, need MySQL Server 4.1+ for the test!\\n\");\n    if ($version[0] <= 4 && $version[1] < 1)\n        printf(\"[006] Need MySQL Server 4.1+ for the test!\\n\");\n    if (!$res = mysqli_query($link, 'SELECT @@character_set_connection AS charset, @@collation_connection AS collation'))\n        printf(\"[007] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    $tmp = mysqli_fetch_assoc($res);\n    mysqli_free_result($res);\n    if (!($character_set_connection = $tmp['charset']) || !($collation_connection = $tmp['collation']))\n        printf(\"[008] Cannot determine current character set and collation\\n\");\n    if (!$res = mysqli_query($link, $sql = sprintf(\"SHOW CHARACTER SET LIKE '%s'\", $character_set_connection)))\n        printf(\"[009] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    $tmp = mysqli_fetch_assoc($res);\n    if (empty($tmp))\n        printf(\"[010] Cannot fetch Maxlen and/or Comment, test will fail: $sql\\n\");\n    $maxlen = (isset($tmp['Maxlen'])) ? $tmp['Maxlen'] : '';\n    $comment = (isset($tmp['Description'])) ? $tmp['Description'] : '';\n    if (!$res = mysqli_query($link, sprintf(\"SHOW COLLATION LIKE '%s'\", $collation_connection)))\n        printf(\"[011] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    $tmp = mysqli_fetch_assoc($res);\n    mysqli_free_result($res);\n    if (!($id = $tmp['Id']))\n        printf(\"[012] Cannot fetch Id/Number, test will fail\\n\");\n    if (!$res = mysqli_query($link, sprintf(\"SHOW VARIABLES LIKE 'character_sets_dir'\")))\n        printf(\"[013] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    $tmp = mysqli_fetch_assoc($res);\n    mysqli_free_result($res);\n    if (!($character_sets_dir = $tmp['Value']))\n        printf(\"[014] Cannot fetch character_sets_dir, test will fail\\n\");\n    if (!is_object($charset = mysqli_get_charset($link)))\n        printf(\"[015] Expecting object/std_class, got %s/%s\\n\", gettype($charset), $charset);\n    if (!isset($charset->charset) ||\n        !in_array(gettype($charset->charset), array(\"string\", \"unicode\")) ||\n        ($character_set_connection !== $charset->charset))\n        printf(\"[016] Expecting string/%s, got %s/%s\\n\", $character_set_connection, gettype($charset->charset), $charset->charset);\n    if (!isset($charset->collation) ||\n        !in_array(gettype($charset->collation), array(\"string\", \"unicode\")) ||\n        ($collation_connection !== $charset->collation))\n        printf(\"[017] Expecting string/%s, got %s/%s\\n\", $collation_connection, gettype($charset->collation), $charset->collation);\n    if (!isset($charset->dir) ||\n        !is_string($charset->dir))\n        printf(\"[019] Expecting string - ideally %s*, got %s/%s\\n\", $character_sets_dir, gettype($charset->dir), $charset->dir);\n    if (!isset($charset->min_length) ||\n        !(is_int($charset->min_length)) ||\n        ($charset->min_length < 0) ||\n        ($charset->min_length > $charset->max_length))\n        printf(\"[020] Expecting int between 0 ... %d, got %s/%s\\n\", $charset->max_length,\n            gettype($charset->min_length), $charset->min_length);\n    if (!isset($charset->number) ||\n        !is_int($charset->number) ||\n        ($charset->number !== (int)$id))\n        printf(\"[021] Expecting int/%d, got %s/%s\\n\", $id, gettype($charset->number), $charset->number);\n    if (!isset($charset->state) ||\n        !is_int($charset->state))\n        printf(\"[022] Expecting int/any, got %s/%s\\n\", gettype($charset->state), $charset->state);\n    mysqli_close($link);\n    try {\n        mysqli_get_charset($link);\n    } catch (Error $exception) {\n        echo $exception->getMessage() . \"\\n\";\n    }\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
