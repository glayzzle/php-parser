// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_connect.phpt
  it("mysqli_connect()", function () {
    expect(parser.parseCode("<?php\n    require_once(\"connect.inc\");\n    $tmp    = NULL;\n    $link   = NULL;\n    /* we need to check, if the server allows anonymous login (empty user) */\n    $tmp = @mysqli_connect('localhost');\n    $anon_allow = (gettype($tmp) == \"object\");\n    $exptype = ($anon_allow) ? \"mysqli_object\" : \"false\";\n    $tmp = @mysqli_connect($link);\n    if (($anon_allow && gettype($tmp) != \"object\") || (!$anon_allow && $tmp != false)) {\n        printf(\"[002] Expecting %s, got %s/%s\\n\", $exptype, gettype($tmp), $tmp);\n    }\n    $tmp = @mysqli_connect($link, $link);\n    if (($anon_allow && gettype($tmp) != \"object\") || (!$anon_allow && $tmp != false)) {\n        printf(\"[003] Expecting %s, got %s/%s\\n\", $exptype, gettype($tmp), $tmp);\n    }\n    $tmp = @mysqli_connect($link, $link, $link);\n    if (($anon_allow && gettype($tmp) != \"object\") || (!$anon_allow && $tmp != false)) {\n        printf(\"[004] Expecting %s, got %s/%s\\n\", $exptype, gettype($tmp), $tmp);\n    }\n    $tmp = @mysqli_connect($link, $link, $link, $link);\n    if (($anon_allow && gettype($tmp) != \"object\") || (!$anon_allow && $tmp != false)) {\n        printf(\"[005] Expecting %s, got %s/%s\\n\", $exptype, gettype($tmp), $tmp);\n    }\n    $tmp = @mysqli_connect($link, $link, $link, $link, $link);\n    if (($anon_allow && gettype($tmp) != \"object\") || (!$anon_allow && $tmp != false)) {\n        printf(\"[006] Expecting %s, got %s/%s\\n\", $exptype, gettype($tmp), $tmp);\n    }\n    $tmp = @mysqli_connect($link, $link, $link, $link, $link, $link);\n    if (($anon_allow && gettype($tmp) != \"object\") || (!$anon_allow && $tmp != false)) {\n        printf(\"[007] Expecting %s, got %s/%s\\n\", $exptype, gettype($tmp), $tmp);\n    }\n    if (!$link = mysqli_connect($host, $user, $passwd, $db, $port, $socket))\n        printf(\"[008] Cannot connect to the server using host=%s, user=%s, passwd=***, dbname=%s, port=%s, socket=%s\\n\",\n            $host, $user, $db, $port, $socket);\n    mysqli_close($link);\n    if ($link = mysqli_connect($host, $user . 'unknown_really', $passwd . 'non_empty', $db, $port, $socket))\n        printf(\"[009] Can connect to the server using host=%s, user=%s, passwd=***non_empty, dbname=%s, port=%s, socket=%s\\n\",\n            $host, $user . 'unknown_really', $db, $port, $socket);\n    if (false !== $link)\n        printf(\"[010] Expecting boolean/false, got %s/%s\\n\", gettype($link), $link);\n    // Run the following tests without an anoynmous MySQL user and use a password for the test user!\n    ini_set('mysqli.default_socket', $socket);\n    if (!is_object($link = mysqli_connect($host, $user, $passwd, $db, $port))) {\n        printf(\"[011] Usage of mysqli.default_socket failed\\n\") ;\n    } else {\n        if (!$res = mysqli_query($link, \"SELECT 'mysqli.default_socket' AS 'testing'\"))\n            printf(\"[012] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        var_dump(mysqli_fetch_assoc($res));\n        mysqli_free_result($res);\n        mysqli_close($link);\n    }\n    ini_set('mysqli.default_port', $port);\n    if (!is_object($link = mysqli_connect($host, $user, $passwd, $db))) {\n        printf(\"[013] Usage of mysqli.default_port failed\\n\") ;\n    } else {\n        if (!$res = mysqli_query($link, \"SELECT 'mysqli.default_port' AS 'testing'\"))\n            printf(\"[014] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        var_dump(mysqli_fetch_assoc($res));\n        mysqli_free_result($res);\n        mysqli_close($link);\n    }\n    ini_set('mysqli.default_pw', $passwd);\n    if (!is_object($link = mysqli_connect($host, $user))) {\n        printf(\"[015] Usage of mysqli.default_pw failed\\n\") ;\n    } else {\n        if (!$res = mysqli_query($link, \"SELECT 'mysqli.default_pw' AS 'testing'\"))\n            printf(\"[016] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        var_dump(mysqli_fetch_assoc($res));\n        mysqli_free_result($res);\n        mysqli_close($link);\n    }\n    ini_set('mysqli.default_user', $user);\n    if (!is_object($link = mysqli_connect($host))) {\n        printf(\"[017] Usage of mysqli.default_user failed\\n\") ;\n    } else {\n        if (!$res = mysqli_query($link, \"SELECT 'mysqli.default_user' AS 'testing'\"))\n            printf(\"[018] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        var_dump(mysqli_fetch_array($res, MYSQLI_BOTH));\n        mysqli_free_result($res);\n        mysqli_close($link);\n    }\n    ini_set('mysqli.default_host', $host);\n    if (!is_object($link = mysqli_connect())) {\n        printf(\"[019] Usage of mysqli.default_host failed\\n\") ;\n    } else {\n        if (!$res = mysqli_query($link, \"SELECT 'mysqli.default_host' AS 'testing'\"))\n            printf(\"[020] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        var_dump(mysqli_fetch_array($res, MYSQLI_NUM));\n        mysqli_free_result($res);\n        mysqli_close($link);\n    }\n    if ($IS_MYSQLND) {\n        ini_set('mysqli.default_host', 'p:' . $host);\n            if (!is_object($link = mysqli_connect())) {\n                printf(\"[021] Usage of mysqli.default_host (persistent) failed\\n\") ;\n        } else {\n            if (!$res = mysqli_query($link, \"SELECT 'mysqli.default_host (persistent)' AS 'testing'\"))\n                printf(\"[022] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n            $tmp = mysqli_fetch_assoc($res);\n            if ($tmp['testing'] !== 'mysqli.default_host (persistent)') {\n                printf(\"[023] Result looks strange - check manually, [%d] %s\\n\",\n                    mysqli_errno($link), mysqli_error($link));\n                var_dump($tmp);\n            }\n            mysqli_free_result($res);\n            mysqli_close($link);\n        }\n        ini_set('mysqli.default_host', 'p:');\n        if (is_object($link = @mysqli_connect())) {\n            printf(\"[024] Usage of mysqli.default_host=p: did not fail\\n\") ;\n            mysqli_close($link);\n        }\n    }\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
