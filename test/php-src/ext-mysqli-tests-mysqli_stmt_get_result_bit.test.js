// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_stmt_get_result_bit.phpt
  it("Fetching BIT column values using the PS API", function () {
    expect(parser.parseCode("<?php\n    require('connect.inc');\n    function dec32bin($dec, $bits) {\n        $maxval = pow(2, $bits);\n        $bin = '';\n        for ($bitval = $maxval; $bitval >= 1; $bitval = $bitval / 2) {\n            if (($dec / $bitval) >= 1) {\n                $bin .= '1';\n                $dec -= $bitval;\n            } else {\n                $bin .= '0';\n            }\n        }\n        return $bin;\n    }\n    if (!$link = my_mysqli_connect($host, $user, $passwd, $db, $port, $socket))\n        printf(\"[001] Cannot connect to the server using host=%s, user=%s, passwd=***, dbname=%s, port=%s, socket=%s\\n\",\n            $host, $user, $db, $port, $socket);\n    for ($bits = 1; $bits <= 46; $bits++) {\n        if (1 == $bits)\n            $max_value = 1;\n        else\n            $max_value = pow(2, $bits) - 1;\n        if (!mysqli_query($link, \"DROP TABLE IF EXISTS test\") ||\n            !mysqli_query($link, $sql = sprintf('CREATE TABLE test(id BIGINT UNSIGNED, bit_value BIT(%d) NOT NULL, bit_null BIT(%d) DEFAULT NULL) ENGINE=\"%s\"', $bits, $bits, $engine)))\n            printf(\"[002 - %d] [%d] %s\\n\",$bits, mysqli_errno($link), mysqli_error($link));\n        if (!$stmt = mysqli_stmt_init($link))\n            printf(\"[003 - %d] [%d] %s\\n\", $bits, mysqli_errno($link), mysqli_error($link));\n        $tests = 0;\n        $rand_max = mt_getrandmax();\n        while ($tests < 10) {\n            $tests++;\n            if (1 == $tests)\n                $value = 0;\n            else if (2 == $tests)\n                $value = $max_value;\n            else {\n                if ($max_value > $rand_max) {\n                    $max_loops = floor($max_value/$rand_max);\n                    $num_loops = mt_rand(1, $max_loops);\n                    $value = 0;\n                    for ($i = 0; $i < $num_loops; $i++)\n                        $value += mt_rand(0, $rand_max);\n                } else {\n                    $value = mt_rand(0, $max_value);\n                }\n            }\n            $bin = ($bits < 32) ? decbin($value) : dec32bin($value, $bits);\n            $sql = sprintf(\"INSERT INTO test(id, bit_value) VALUES (%s, b'%s')\", $value, $bin);\n            for ($i = 0; ($i < strlen($bin)) && ($bin[$i] == '0'); $i++)\n                ;\n            $bin2 = substr($bin, $i, strlen($bin));\n            if (!mysqli_stmt_prepare($stmt, $sql) ||\n                    !mysqli_stmt_execute($stmt))\n                printf(\"[004 - %d] [%d] %s\\n\", $bits, mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n            $sql = sprintf(\"SELECT bin(bit_value) AS _bin, id, bit_value, bit_null FROM test WHERE id = %s\", $value);\n            if (!mysqli_stmt_prepare($stmt, $sql) ||\n                    !mysqli_stmt_execute($stmt))\n                printf(\"[005 - %d] [%d] %s\\n\", $bits, mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n            if (!$res = mysqli_stmt_get_result($stmt))\n                printf(\"[006 - %d] [%d] %s\\n\", $bits, mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n            if (!$row = mysqli_fetch_assoc($res))\n                printf(\"[007 - %d] [%d] %s\\n\", $bits, mysqli_errno($link), mysqli_error($link));\n            mysqli_free_result($res);\n            if (($value != $row['id']) || (($bin != $row['_bin']) && ($bin2 != $row['_bin']))) {\n                debug_zval_dump($row);\n                printf(\"[008 - %d] Insert of %s in BIT(%d) column might have failed. id = %s, bin = %s (%s/%s)\\n\",\n                    $bits, $value, $bits, $row['id'], $row['_bin'], $bin, $bin2);\n                break;\n            }\n            if ($value != $row['bit_value']) {\n                debug_zval_dump($row);\n                printf(\"%10s %64s\\n%10s %64s\\n\", '_bin', $row['_bin'], 'insert', $bin);\n                printf(\"[009 - %d] Expecting %s got %s\\n\", $bits, $value, $row['bit_value']);\n                break;\n            }\n            if (null !== $row['bit_null']) {\n                debug_zval_dump($row);\n                printf(\"[010 - %d] Expecting null got %s/%s\\n\", $bits, gettype($row['bit_value']), $row['bit_value']);\n                break;\n            }\n        }\n        mysqli_stmt_close($stmt);\n    }\n    mysqli_close($link);\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
