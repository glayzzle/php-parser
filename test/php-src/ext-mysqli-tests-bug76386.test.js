// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/bug76386.phpt
  it("Prepared Statement formatter truncates fractional seconds from date/time column (bug #76386)", function () {
    expect(parser.parseCode("<?php\nrequire_once('connect.inc');\n// test part 1 - TIMESTAMP(n)\n$link = new mysqli($host, $user, $passwd, $db, $port, $socket);\n$link->query('DROP TABLE IF EXISTS ts_test;');\n$link->query(\n    'CREATE TABLE ts_test (id bigint unsigned auto_increment primary key, ' .\n    'ts timestamp default current_timestamp(), ts2 timestamp(2) default ' .\n    'current_timestamp(2), ts2b timestamp(2) default \"2018-01-01 03:04:05.06\", ' .\n    'ts4 timestamp(4) default current_timestamp(4), ts4b timestamp(4) default ' .\n    '\"2018-01-01 03:04:05.0070\", ts6 timestamp(6) default current_timestamp(6), ts6b ' .\n    'timestamp(6) default \"2018-01-01 03:04:05.008000\") character set utf8 collate ' .\n    'utf8_general_ci;'\n);\n$link->query(\n    'INSERT INTO ts_test (ts, ts2, ts4, ts6) VALUES (\"2018-01-01 11:22:33\", ' .\n    '\"2018-02-02 11:22:33.77\", \"2018-03-03 11:22:33.8888\", ' .\n    '\"2018-04-04 11:22:33.999999\");'\n);\n$stmt = $link->prepare('SELECT * FROM ts_test;'); // must be statement\nif ($stmt) {\n    $stmt->execute();\n    $tsid = $ts = $ts2 = $ts2b = $ts4 = $ts4b = $ts6 = $ts6b = null;\n    $stmt->bind_result($tsid, $ts, $ts2, $ts2b, $ts4, $ts4b, $ts6, $ts6b);\n    $stmt->fetch();\n    var_dump($ts, $ts2, $ts2b, $ts4, $ts4b, $ts6, $ts6b);\n    $stmt->free_result();\n} else {\n    echo('[FIRST][FAIL] mysqli::prepare returned false: ' . $link->error . PHP_EOL);\n}\n$link->close();\n// test part 2 - TIME(n)\n$link = new mysqli($host, $user, $passwd, $db, $port, $socket);\n$link->query('DROP TABLE IF EXISTS t_test;');\n$link->query(\n    'CREATE TABLE t_test (id bigint unsigned auto_increment primary key, ' .\n    't time default \"11:00:00\", t2 time(2) default \"11:00:00.22\", t4 ' .\n    'time(4) default \"11:00:00.4444\", t6 time(6) default \"11:00:00.006054\") ' .\n    'character set utf8 collate utf8_general_ci;'\n);\n$link->query(\n    'INSERT INTO t_test (t, t2, t4, t6) VALUES (\"21:22:33\", \"21:22:33.44\", ' .\n    '\"21:22:33.5555\", \"21:22:33.676767\");'\n);\n$link->query('INSERT INTO t_test VALUES ();');\n$stmt = $link->prepare('SELECT * FROM t_test;');\nif ($stmt) {\n    $stmt->execute();\n    $tid = $t = $t2 = $t3 = $t4 = null;\n    $stmt->bind_result($tid, $t, $t2, $t4, $t6);\n    while ($stmt->fetch()) {\n        var_dump($t, $t2, $t4, $t6);\n    }\n    $stmt->free_result();\n} else {\n    echo('[SECOND][FAIL] mysqli::prepare returned false: ' . $link->error . PHP_EOL);\n}\n$link->close();\n?>")).toMatchSnapshot();
  });
});
