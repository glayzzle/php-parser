// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_multi_query.phpt
  it("mysqli_multi_query()", function () {
    expect(parser.parseCode("<?php\n    require_once(\"connect.inc\");\n    require('table.inc');\n    if (false !== ($tmp = mysqli_multi_query($link, \"\")))\n        printf(\"[003] Expecting boolean/false, got %s/%s\\n\", gettype($tmp), $tmp);\n    if (!mysqli_multi_query($link, \"SELECT 1 AS a; SELECT 1 AS a, 2 AS b; SELECT id FROM test ORDER BY id LIMIT 3\"))\n        printf(\"[005] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    $i = 0;\n    do {\n        $res = mysqli_store_result($link);\n        while ($row = mysqli_fetch_array($res))\n            ;\n        mysqli_free_result($res);\n        $i++;\n    } while (mysqli_next_result($link));\n    printf(\"[006] %d\\n\", $i);\n    if (!mysqli_multi_query($link, \"ALTER TABLE test MODIFY id INT AUTO_INCREMENT; INSERT INTO test(label) VALUES ('a'); SELECT id, label FROM test ORDER BY id\"))\n        printf(\"[007] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    $i = 0;\n    while (mysqli_next_result($link) && ($res = mysqli_store_result($link))) {\n        while ($row = mysqli_fetch_array($res))\n            ;\n        mysqli_free_result($res);\n        printf(\"%d/%d\\n\", $i, mysqli_insert_id($link));\n        $i++;\n    }\n    printf(\"[008] %d\\n\", $i);\n    if (!mysqli_multi_query($link, \"SELECT id, label FROM test\"))\n        printf(\"[009] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    $i = 0;\n    while (mysqli_next_result($link) && ($res = mysqli_store_result($link))) {\n        while ($row = mysqli_fetch_array($res))\n            $i++;\n        mysqli_free_result($res);\n    }\n    printf(\"[010] %d\\n\", $i);\n    if (!mysqli_multi_query($link, \"SELECT 1 AS num, 'a' AS somechar; SELECT 2 AS num, 'a' AS somechar; SELECT 3 AS num, 'a' AS somechar\"))\n        printf(\"[011] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    $res_num = 1;\n    do {\n        if (!$res = mysqli_store_result($link)) {\n            printf(\"[012 - %d] [%d] %s\\n\", $res_num, mysqli_errno($link), mysqli_error($link));\n            continue;\n        }\n        $num_rows = 0;\n        while ($row = mysqli_fetch_array($res)) {\n            $num_rows++;\n            if ($row['num'] != $res_num)\n                printf(\"[013 - %d] Expecting %s got %s\\n\", $res_num, $res_num, $row['num']);\n            if ($row['somechar'] != \"a\")\n                printf(\"[014 - %d] Expecting a got %s\\n\", $res_num, $row['somechar']);\n            if (1 == $num_rows) {\n                /* simple metadata check */\n                if (!($lengths = mysqli_fetch_lengths($res)))\n                    printf(\"[015 - %d] [%d] %s\\n\", $res_num, mysqli_errno($link), mysqli_error($link));\n                if (count($lengths) != 2)\n                    printf(\"[016 - %d] Expecting 2 column lengths got %d [%d] %s\\n\", $res_num, count($lengths));\n                foreach ($lengths as $k => $length)\n                    if ($length <= 0)\n                        printf(\"[017 - %d] Strange column lengths for column %d, got %d expecting any > 0\\n\",\n                            $res_num, $k, $length);\n                }\n        }\n        if ($num_rows != 1)\n            printf(\"[018 - %d] Expecting 1 row, got %d rows\\n\", $num_rows);\n        $res_num++;\n        mysqli_free_result($res);\n    } while (mysqli_next_result($link));\n    if ($res_num != 4)\n        printf(\"[015] Expecting 3 result sets got %d result set[s]\\n\", $res_num);\n    mysqli_close($link);\n    try {\n        mysqli_multi_query($link, \"SELECT id, label FROM test\");\n    } catch (Error $exception) {\n        echo $exception->getMessage() . \"\\n\";\n    }\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
