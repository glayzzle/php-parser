// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_get_client_stats_ps.phpt
  it("mysqli_get_client_stats() - PS", function () {
    expect(parser.parseCode("<?php\n    require_once('connect.inc');\n    require_once('table.inc');\n    $stats = mysqli_get_client_stats();\n    printf(\"BEGINNING: rows_fetched_from_client_ps_unbuffered = %d\\n\",\t$stats['rows_fetched_from_client_ps_unbuffered']);\n    printf(\"BEGINNING: rows_fetched_from_client_ps_buffered = %d\\n\",\t$stats['rows_fetched_from_client_ps_buffered']);\n    printf(\"BEGINNING: rows_fetched_from_client_ps_cursor = %d\\n\",\t$stats['rows_fetched_from_client_ps_cursor']);\n    if (!$stmt = mysqli_stmt_init($link))\n        printf(\"[001] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    $id = null;\n    if (!mysqli_stmt_prepare($stmt, 'SELECT id FROM test') ||\n            !mysqli_stmt_execute($stmt) ||\n            !mysqli_stmt_store_result($stmt) ||\n            !mysqli_stmt_bind_result($stmt, $id))\n        printf(\"[002] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $num_rows = 0;\n    while (mysqli_stmt_fetch($stmt))\n        $num_rows++;\n    mysqli_stmt_free_result($stmt);\n    $after = mysqli_get_client_stats();\n    if ($after['rows_fetched_from_client_ps_unbuffered'] != $stats['rows_fetched_from_client_ps_unbuffered'])\n        printf(\"[003] Unbuffered rows got increased after buffered PS, expecting %d got %d.\\n\",\n            $stats['rows_fetched_from_client_ps_unbuffered'],\n            $after['rows_fetched_from_client_ps_unbuffered']);\n    $stats['rows_fetched_from_client_ps_buffered'] += $num_rows;\n    if ($after['rows_fetched_from_client_ps_buffered'] != $stats['rows_fetched_from_client_ps_buffered'] )\n        printf(\"[005] Buffered rows should be %d got %d.\\n\",\n            $stats['rows_fetched_from_client_ps_buffered'],\n            $after['rows_fetched_from_client_ps_buffered']);\n    $stats = $after;\n    printf(\"BUFFERED: rows_fetched_from_client_ps_unbuffered = %d\\n\",\t$stats['rows_fetched_from_client_ps_unbuffered']);\n    printf(\"BUFFERED: rows_fetched_from_client_ps_buffered = %d\\n\",\t$stats['rows_fetched_from_client_ps_buffered']);\n    printf(\"BUFFERED: rows_fetched_from_client_ps_cursor = %d\\n\",\t$stats['rows_fetched_from_client_ps_cursor']);\n    $id = null;\n    if (!mysqli_stmt_prepare($stmt, 'SELECT id FROM test') ||\n            !mysqli_stmt_execute($stmt) ||\n            !mysqli_stmt_bind_result($stmt, $id))\n        printf(\"[006] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $num_rows = 0;\n    while (mysqli_stmt_fetch($stmt))\n        $num_rows++;\n    $after = mysqli_get_client_stats();\n    $stats['rows_fetched_from_client_ps_unbuffered'] += $num_rows;\n    if ($after['rows_fetched_from_client_ps_unbuffered'] != $stats['rows_fetched_from_client_ps_unbuffered'])\n        printf(\"[007] Unbuffered rows should be %d got %d.\\n\",\n            $stats['rows_fetched_from_client_ps_unbuffered'],\n            $after['rows_fetched_from_client_ps_unbuffered']);\n    if ($after['rows_fetched_from_client_ps_buffered'] != $stats['rows_fetched_from_client_ps_buffered'] )\n        printf(\"[005] Buffered rows should be unchanged, expecting %d got %d.\\n\",\n            $stats['rows_fetched_from_client_ps_buffered'],\n            $after['rows_fetched_from_client_ps_buffered']);\n    mysqli_stmt_free_result($stmt);\n    mysqli_stmt_close($stmt);\n    $stats = $after;\n    printf(\"UNBUFFERED: rows_fetched_from_client_ps_unbuffered = %d\\n\",\t$stats['rows_fetched_from_client_ps_unbuffered']);\n    printf(\"UNBUFFERED: rows_fetched_from_client_ps_buffered = %d\\n\",\t$stats['rows_fetched_from_client_ps_buffered']);\n    printf(\"UNBUFFERED: rows_fetched_from_client_ps_cursor = %d\\n\",\t$stats['rows_fetched_from_client_ps_cursor']);\n    mysqli_close($link);\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
