// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_stmt_num_rows.phpt
  it("mysqli_stmt_num_rows()", function () {
    expect(parser.parseCode("<?php\n    require_once(\"connect.inc\");\n    require('table.inc');\n    if (!$stmt = mysqli_stmt_init($link))\n        printf(\"[003] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    function func_test_mysqli_stmt_num_rows($stmt, $query, $expected, $offset) {\n        if (!mysqli_stmt_prepare($stmt, $query)) {\n            printf(\"[%03d] [%d] %s\\n\", $offset, mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n            return false;\n        }\n        if (!mysqli_stmt_execute($stmt)) {\n            printf(\"[%03d] [%d] %s\\n\", $offset + 1, mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n            return false;\n        }\n        if (!mysqli_stmt_store_result($stmt)) {\n            printf(\"[%03d] [%d] %s\\n\", $offset + 2, mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n            return false;\n        }\n        if ($expected !== ($tmp = mysqli_stmt_num_rows($stmt)))\n            printf(\"[%03d] Expecting %s/%d, got %s/%d\\n\", $offset + 3,\n                gettype($expected), $expected,\n                gettype($tmp), $tmp);\n        mysqli_stmt_free_result($stmt);\n        return true;\n    }\n    func_test_mysqli_stmt_num_rows($stmt, \"SELECT 1 AS a\", 1, 10);\n    func_test_mysqli_stmt_num_rows($stmt, \"SHOW VARIABLES LIKE '%nixnutz%'\", 0, 20);\n    // Note: for statements that return no result set mysqli_num_rows() differs from mysqli_stmt_num_rows() slightly\n    // mysqli_num_rows() failed to fetch the result set and the PHP parameter check makes it return NULL\n    // mysqli_stmt_numrows() has a valid resource to work on and it will return int/0 instead. No bug, but\n    // slightly different behaviour... - if you really check the data types and don't rely on casting like 98% of all PHP\n    // users do.\n    func_test_mysqli_stmt_num_rows($stmt, \"INSERT INTO test(id, label) VALUES (100, 'z')\", 0, 30);\n    if ($res = mysqli_query($link, 'SELECT COUNT(id) AS num FROM test')) {\n        $row = mysqli_fetch_assoc($res);\n        mysqli_free_result($res);\n        func_test_mysqli_stmt_num_rows($stmt, \"SELECT id, label FROM test\", (int)$row['num'], 40);\n    } else {\n        printf(\"[050] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    }\n    print \"run_tests.php don't fool me with your 'ungreedy' expression '.+?'!\\n\";\n    if (!mysqli_stmt_prepare($stmt, 'SELECT id FROM test'))\n        printf(\"[051] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    if (mysqli_stmt_execute($stmt)) {\n        $i = 0;\n        do {\n            if (0 !== ($tmp = mysqli_stmt_num_rows($stmt)))\n                printf(\"[53 - %03d] Expecting int/0, got %s/%s\\n\", $i, gettype($tmp), $tmp);\n            $i++;\n        } while (mysqli_stmt_fetch($stmt));\n        /* NOTE to users\n        Behaviour with libmysql is UNDEFINED, see http://news.php.net/php.internals/55210\n        Because it is undefined it is allowed to the mysqlnd DEVELOPER to implement\n        any behaviour they like, including the one checked for in this test.\n        What the test does is cover an implementation detail of the mysqlnd library.\n        This implementation detail may, at any time, change without prior notice.\n        On the contrary, the mysqlnd way is a reasonable one and, maybe, one fine\n        day, after Klingons visited earh, becomes the official one. Meanwhile do\n        not rely on it.\n        */\n        if ($IS_MYSQLND && (7 !== ($tmp = mysqli_stmt_num_rows($stmt))))\n            printf(\"[54] Expecting int/7, got %s/%s\\n\", gettype($tmp), $tmp);\n    } else {\n        printf(\"[055] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    }\n    mysqli_stmt_close($stmt);\n    try {\n        mysqli_stmt_num_rows($stmt);\n    } catch (Error $exception) {\n        echo $exception->getMessage() . \"\\n\";\n    }\n    mysqli_close($link);\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
