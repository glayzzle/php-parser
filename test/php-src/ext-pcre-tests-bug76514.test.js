// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/pcre/tests/bug76514.phpt
  it("Bug #76514 Regression in preg_match makes it fail with PREG_JIT_STACKLIMIT_ERROR", function () {
    expect(parser.parseCode("<?php\n$str = '{\n    \"config\": {\n        \"cache-files-ttl\": 0,\n        \"discard-changes\": true\n    },\n    \"minimum-stability\": \"stable\",\n    \"prefer-stable\": false,\n    \"provide\": {\n        \"heroku-sys/cedar\": \"14.2016.03.22\"\n    },\n    \"repositories\": [\n        {\n            \"packagist.org\": false\n        },\n        {\n            \"type\": \"package\",\n            \"package\": [\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"anthonymartin/geo-location\",\n                    \"version\": \"v1.0.0\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.3.0\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"aws/aws-sdk-php\",\n                    \"version\": \"3.9.4\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.5\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"cloudinary/cloudinary_php\",\n                    \"version\": \"dev-master\",\n                    \"require\": {\n                        \"heroku-sys/ext-curl\": \"*\",\n                        \"heroku-sys/ext-json\": \"*\",\n                        \"heroku-sys/php\": \">=5.3.0\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"doctrine/annotations\",\n                    \"version\": \"v1.2.7\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.3.2\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"doctrine/cache\",\n                    \"version\": \"v1.6.0\",\n                    \"require\": {\n                        \"heroku-sys/php\": \"~5.5|~7.0\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"doctrine/collections\",\n                    \"version\": \"v1.3.0\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.3.2\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"doctrine/common\",\n                    \"version\": \"v2.6.1\",\n                    \"require\": {\n                        \"heroku-sys/php\": \"~5.5|~7.0\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"doctrine/inflector\",\n                    \"version\": \"v1.1.0\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.3.2\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"doctrine/lexer\",\n                    \"version\": \"v1.0.1\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.3.2\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"geoip/geoip\",\n                    \"version\": \"v1.16\",\n                    \"require\": [],\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": {\n                        \"heroku-sys/ext-geoip\": \"*\"\n                    }\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"giggsey/libphonenumber-for-php\",\n                    \"version\": \"7.2.5\",\n                    \"require\": {\n                        \"heroku-sys/ext-mbstring\": \"*\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"guzzlehttp/guzzle\",\n                    \"version\": \"5.3.0\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.4.0\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"guzzlehttp/promises\",\n                    \"version\": \"1.0.3\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.5.0\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"guzzlehttp/psr7\",\n                    \"version\": \"1.2.3\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.4.0\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"guzzlehttp/ringphp\",\n                    \"version\": \"1.1.0\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.4.0\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"guzzlehttp/streams\",\n                    \"version\": \"3.0.0\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.4.0\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"hipchat/hipchat-php\",\n                    \"version\": \"v1.4\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.3.0\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"kriswallsmith/buzz\",\n                    \"version\": \"v0.15\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.3.0\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"league/csv\",\n                    \"version\": \"8.0.0\",\n                    \"require\": {\n                        \"heroku-sys/ext-mbstring\": \"*\",\n                        \"heroku-sys/php\": \">=5.5.0\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"league/fractal\",\n                    \"version\": \"0.13.0\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.4\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"mashape/unirest-php\",\n                    \"version\": \"1.2.1\",\n                    \"require\": {\n                        \"heroku-sys/ext-curl\": \"*\",\n                        \"heroku-sys/ext-json\": \"*\",\n                        \"heroku-sys/php\": \">=5.3.0\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"mtdowling/jmespath.php\",\n                    \"version\": \"2.3.0\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.4.0\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"palex/phpstructureddata\",\n                    \"version\": \"v2.0.1\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.3.0\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"psr/http-message\",\n                    \"version\": \"1.0\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.3.0\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"react/promise\",\n                    \"version\": \"v2.2.1\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.4.0\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"rollbar/rollbar\",\n                    \"version\": \"v0.15.0\",\n                    \"require\": {\n                        \"heroku-sys/ext-curl\": \"*\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"ronanguilloux/isocodes\",\n                    \"version\": \"1.2.0\",\n                    \"require\": {\n                        \"heroku-sys/ext-bcmath\": \"*\",\n                        \"heroku-sys/php\": \">=5.4.0\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"sendgrid/sendgrid\",\n                    \"version\": \"2.1.1\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.3\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"sendgrid/smtpapi\",\n                    \"version\": \"0.0.1\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.3\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"symfony/css-selector\",\n                    \"version\": \"v2.8.2\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.3.9\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"symfony/http-foundation\",\n                    \"version\": \"v2.8.2\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.3.9\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"symfony/polyfill-php54\",\n                    \"version\": \"v1.1.0\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.3.3\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"symfony/polyfill-php55\",\n                    \"version\": \"v1.1.0\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.3.3\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"thepixeldeveloper/sitemap\",\n                    \"version\": \"3.0.0\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.3.0\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"tijsverkoyen/css-to-inline-styles\",\n                    \"version\": \"1.5.5\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.3.0\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"yiisoft/yii\",\n                    \"version\": \"1.1.17\",\n                    \"require\": {\n                        \"heroku-sys/php\": \">=5.1.0\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                },\n                {\n                    \"type\": \"metapackage\",\n                    \"name\": \"composer.json/composer.lock\",\n                    \"version\": \"dev-597511d6d51b96e4a8afeba2c79982e5\",\n                    \"require\": {\n                        \"heroku-sys/php\": \"~5.6.0\",\n                        \"heroku-sys/ext-newrelic\": \"*\",\n                        \"heroku-sys/ext-gd\": \"*\",\n                        \"heroku-sys/ext-redis\": \"*\"\n                    },\n                    \"replace\": [],\n                    \"provide\": [],\n                    \"conflict\": []\n                }\n            ]\n        }\n    ],\n    \"require\": {\n        \"composer.json/composer.lock\": \"dev-597511d6d51b96e4a8afeba2c79982e5\",\n        \"anthonymartin/geo-location\": \"v1.0.0\",\n        \"aws/aws-sdk-php\": \"3.9.4\",\n        \"cloudinary/cloudinary_php\": \"dev-master\",\n        \"doctrine/annotations\": \"v1.2.7\",\n        \"doctrine/cache\": \"v1.6.0\",\n        \"doctrine/collections\": \"v1.3.0\",\n        \"doctrine/common\": \"v2.6.1\",\n        \"doctrine/inflector\": \"v1.1.0\",\n        \"doctrine/lexer\": \"v1.0.1\",\n        \"geoip/geoip\": \"v1.16\",\n        \"giggsey/libphonenumber-for-php\": \"7.2.5\",\n        \"guzzlehttp/guzzle\": \"5.3.0\",\n        \"guzzlehttp/promises\": \"1.0.3\",\n        \"guzzlehttp/psr7\": \"1.2.3\",\n        \"guzzlehttp/ringphp\": \"1.1.0\",\n        \"guzzlehttp/streams\": \"3.0.0\",\n        \"hipchat/hipchat-php\": \"v1.4\",\n        \"kriswallsmith/buzz\": \"v0.15\",\n        \"league/csv\": \"8.0.0\",\n        \"league/fractal\": \"0.13.0\",\n        \"mashape/unirest-php\": \"1.2.1\",\n        \"mtdowling/jmespath.php\": \"2.3.0\",\n        \"palex/phpstructureddata\": \"v2.0.1\",\n        \"psr/http-message\": \"1.0\",\n        \"react/promise\": \"v2.2.1\",\n        \"rollbar/rollbar\": \"v0.15.0\",\n        \"ronanguilloux/isocodes\": \"1.2.0\",\n        \"sendgrid/sendgrid\": \"2.1.1\",\n        \"sendgrid/smtpapi\": \"0.0.1\",\n        \"symfony/css-selector\": \"v2.8.2\",\n        \"symfony/http-foundation\": \"v2.8.2\",\n        \"symfony/polyfill-php54\": \"v1.1.0\",\n        \"symfony/polyfill-php55\": \"v1.1.0\",\n        \"thepixeldeveloper/sitemap\": \"3.0.0\",\n        \"tijsverkoyen/css-to-inline-styles\": \"1.5.5\",\n        \"yiisoft/yii\": \"1.1.17\",\n        \"heroku-sys/apache\": \"^2.4.10\",\n        \"heroku-sys/nginx\": \"~1.8.0\"\n    }\n}';\n$res = preg_match('{(?(DEFINE)\n       (?<number>   -? (?= [1-9]|0(?!\\d) ) \\d+ (\\.\\d+)? ([eE] [+-]? \\d+)? )\n       (?<boolean>   true | false | null )\n       (?<string>    \" ([^\"\\\\\\\\]* | \\\\\\\\ [\"\\\\\\\\bfnrt\\/] | \\\\\\\\ u [0-9a-f]{4} )* \" )\n       (?<array>     \\[  (?:  (?&json) \\s* (?: , (?&json) \\s* )*  )?  \\s* \\] )\n       (?<pair>      \\s* (?&string) \\s* : (?&json) \\s* )\n       (?<object>    \\{  (?:  (?&pair)  (?: , (?&pair)  )*  )?  \\s* \\} )\n       (?<json>   \\s* (?: (?&number) | (?&boolean) | (?&string) | (?&array) | (?&object) ) )\n    )\n^(?P<start>\\s*\\{\\s*(?:(?&string)\\s*:\\s*(?&json)\\s*,\\s*)*?)\n(?P<property>'.preg_quote('\"require\"').'\\s*:\\s*)(?P<value>(?&json))(?P<end>.*)}sx', $str, $match);\nvar_dump($res, $match['value'] ?? null, preg_last_error() == PREG_JIT_STACKLIMIT_ERROR);\n?>")).toMatchSnapshot();
  });
});
