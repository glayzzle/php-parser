// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_reconnect.phpt
  it("Trying implicit reconnect after wait_timeout and KILL using mysqli_ping()", function () {
    expect(parser.parseCode("<?php\n    require_once(\"connect.inc\");\n    require_once(\"table.inc\");\n    if (!$link2 = my_mysqli_connect($host, $user, $passwd, $db, $port, $socket))\n        printf(\"[001] Cannot create second database connection, [%d] %s\\n\",\n            mysqli_connect_errno(), mysqli_connect_error());\n    $thread_id_timeout = mysqli_thread_id($link);\n    $thread_id_control = mysqli_thread_id($link2);\n    if (!$res = mysqli_query($link2, \"SHOW FULL PROCESSLIST\"))\n        printf(\"[002] Cannot get full processlist, [%d] %s\\n\",\n            mysqli_errno($link2), mysqli_error($link));\n    $running_threads = array();\n    while ($row = mysqli_fetch_assoc($res))\n        $running_threads[$row['Id']] = $row;\n    mysqli_free_result($res);\n    if (!isset($running_threads[$thread_id_timeout]) ||\n            !isset($running_threads[$thread_id_control]))\n        printf(\"[003] Processlist is borked, [%d] %s\\n\",\n            mysqli_errno($link2), mysqli_error($link));\n    if (!mysqli_query($link, \"SET SESSION wait_timeout = 2\"))\n        printf(\"[004] Cannot set wait_timeout, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!$res = mysqli_query($link, \"SHOW VARIABLES LIKE 'wait_timeout'\"))\n        printf(\"[005] Cannot check if wait_timeout has been set, [%d] %s\\n\",\n            mysqli_errno($link), mysqli_error($link));\n    if (!$row = mysqli_fetch_assoc($res))\n        printf(\"[006] Cannot get wait_timeout, [%d] %s\\n\",\n            mysqli_errno($link), mysqli_error($link));\n    mysqli_free_result($res);\n    if ($row['Value'] != 2)\n        printf(\"[007] Failed setting the wait_timeout, test will not work, [%d] %s\\n\",\n            mysqli_errno($link), mysqli_error($link));\n    // after 2+ seconds the server should kill the connection\n    sleep(3);\n    if (!$res = mysqli_query($link2, \"SHOW FULL PROCESSLIST\"))\n        printf(\"[008] Cannot get full processlist, [%d] %s\\n\",\n            mysqli_errno($link2), mysqli_error($link));\n    $running_threads = array();\n    while ($row = mysqli_fetch_assoc($res))\n        $running_threads[$row['Id']] = $row;\n    mysqli_free_result($res);\n    if (isset($running_threads[$thread_id_timeout]))\n        printf(\"[009] Server should have killed the timeout connection, [%d] %s\\n\",\n            mysqli_errno($link2), mysqli_error($link));\n    if (true !== mysqli_ping($link))\n        printf(\"[010] Reconnect should have happened\");\n    if (!$res = mysqli_query($link, \"SELECT DATABASE() as _dbname\"))\n        printf(\"[011] Cannot get database name, [%d] %s\\n\",\n            mysqli_errno($link), mysqli_error($link));\n    if (!$row = mysqli_fetch_assoc($res))\n        printf(\"[012] Cannot get database name, [%d] %s\\n\",\n            mysqli_errno($link), mysqli_error($link));\n    mysqli_free_result($res);\n    if ($row['_dbname'] != $db)\n        printf(\"[013] Connection should has been made to DB/Schema '%s', expecting '%s', [%d] %s\\n\",\n            $row['_dbname'], $db, mysqli_errno($link), mysqli_error($link));\n    // ... and now we try KILL\n    $thread_id_timeout = mysqli_thread_id($link);\n    if (!mysqli_query($link2, sprintf('KILL %d', $thread_id_timeout)))\n        printf(\"[014] Cannot KILL timeout connection, [%d] %s\\n\", mysqli_errno($link2), mysqli_error($link2));\n    // Give the server a second to really kill the other thread...\n    sleep(1);\n    if (!$res = mysqli_query($link2, \"SHOW FULL PROCESSLIST\"))\n        printf(\"[015] Cannot get full processlist, [%d] %s\\n\",\n            mysqli_errno($link2), mysqli_error($link));\n    $running_threads = array();\n    while ($row = mysqli_fetch_assoc($res))\n        $running_threads[$row['Id']] = $row;\n    mysqli_free_result($res);\n    if (isset($running_threads[$thread_id_timeout]) ||\n            !isset($running_threads[$thread_id_control]))\n        printf(\"[016] Processlist is borked, [%d] %s\\n\",\n            mysqli_errno($link2), mysqli_error($link));\n    if (true !== ($tmp = mysqli_ping($link)))\n        printf(\"[017] Expecting boolean/true got %s/%s\\n\", gettype($tmp), $tmp);\n    if (!$res = mysqli_query($link, \"SELECT DATABASE() as _dbname\"))\n        printf(\"[018] Cannot get database name, [%d] %s\\n\",\n            mysqli_errno($link), mysqli_error($link));\n    if (!$row = mysqli_fetch_assoc($res))\n        printf(\"[019] Cannot get database name, [%d] %s\\n\",\n            mysqli_errno($link), mysqli_error($link));\n    mysqli_free_result($res);\n    if ($row['_dbname'] != $db)\n        printf(\"[020] Connection should has been made to DB/Schema '%s', expecting '%s', [%d] %s\\n\",\n            $row['_dbname'], $db, mysqli_errno($link), mysqli_error($link));\n    mysqli_close($link);\n    mysqli_close($link2);\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
