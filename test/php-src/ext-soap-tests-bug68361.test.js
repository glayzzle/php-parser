// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/soap/tests/bug68361.phpt
  it("Bug #68361 Segmentation fault on SoapClient::__getTypes", function () {
    expect(parser.parseCode("<?php\n$xml = <<<XML\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<definitions name=\"TestServer\" targetNamespace=\"http://foo.bar/testserver\" xmlns:tns=\"http://foo.bar/testserver\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:soap=\"http://schemas.xmlsoap.org/wsdl/soap/\" xmlns:soapenc=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns=\"http://schemas.xmlsoap.org/wsdl/\" xmlns:ns=\"http://foo.bar/testserver/types\">\n  <types>\n    <xsd:schema targetNamespace=\"http://foo.bar/testserver/types\" xmlns=\"http://foo.bar/testserver/types\">\n      <xsd:complexType name=\"ArrayOfEmployeeReturn\">\n        <xsd:complexContent>\n          <xsd:restriction base=\"soapenc:Array\">\n            <xsd:attribute ref=\"soapenc:arrayType\" arrayType=\"ns:Employee[]\"/>\n          </xsd:restriction>\n        </xsd:complexContent>\n      </xsd:complexType>\n      <xsd:complexType name=\"Employee\">\n        <xsd:sequence>\n          <xsd:element name=\"id\" type=\"xsd:int\"/>\n          <xsd:element name=\"department\" type=\"xsd:string\"/>\n          <xsd:element name=\"name\" type=\"xsd:string\"/>\n          <xsd:element name=\"age\" type=\"xsd:int\"/>\n        </xsd:sequence>\n      </xsd:complexType>\n      <xsd:element name=\"Employee\" nillable=\"true\" type=\"ns:Employee\"/>\n      <xsd:complexType name=\"User\">\n        <xsd:sequence>\n          <xsd:element name=\"name\" type=\"xsd:string\"/>\n          <xsd:element name=\"age\" type=\"xsd:int\"/>\n        </xsd:sequence>\n      </xsd:complexType>\n      <xsd:element name=\"User\" nillable=\"true\" type=\"ns:User\"/>\n    </xsd:schema>\n  </types>\n  <message name=\"getEmployeeRequest\">\n    <part name=\"name\" type=\"xsd:name\"/>\n  </message>\n  <message name=\"getEmployeeResponse\">\n    <part name=\"employeeReturn\" type=\"ns:ArrayOfEmployeeReturn\"/>\n  </message>\n  <message name=\"getUserRequest\">\n    <part name=\"id\" type=\"xsd:id\"/>\n  </message>\n  <message name=\"getUserResponse\">\n    <part name=\"userReturn\" element=\"ns:User\"/>\n  </message>\n  <portType name=\"TestServerPortType\">\n    <operation name=\"getEmployee\">\n      <input message=\"tns:getEmployeeRequest\"/>\n      <output message=\"tns:getEmployeeResponse\"/>\n    </operation>\n    <operation name=\"getUser\">\n      <input message=\"tns:getUserRequest\"/>\n      <output message=\"tns:getUserResponse\"/>\n    </operation>\n  </portType>\n  <binding name=\"TestServerBinding\" type=\"tns:TestServerPortType\">\n    <soap:binding style=\"rpc\" transport=\"http://schemas.xmlsoap.org/soap/http\"/>\n    <operation name=\"getEmployee\">\n      <soap:operation soapAction=\"http://foo.bar/testserver/#getEmployee\"/>\n      <input>\n        <soap:body use=\"literal\" namespace=\"http://foo.bar/testserver\"/>\n      </input>\n      <output>\n        <soap:body use=\"literal\" namespace=\"http://foo.bar/testserver\"/>\n      </output>\n    </operation>\n    <operation name=\"getUser\">\n      <soap:operation soapAction=\"http://foo.bar/testserver/#getUser\"/>\n      <input>\n        <soap:body use=\"literal\" namespace=\"http://foo.bar/testserver\"/>\n      </input>\n      <output>\n        <soap:body use=\"literal\" namespace=\"http://foo.bar/testserver\"/>\n      </output>\n    </operation>\n  </binding>\n  <service name=\"TestServerService\">\n    <port name=\"TestServerPort\" binding=\"tns:TestServerBinding\">\n      <soap:address location=\"http://localhost/wsdl-creator/TestClass.php\"/>\n    </port>\n  </service>\n</definitions>\nXML;\nfile_put_contents(__DIR__ . \"/bug68361.xml\", $xml);\n$client = new SoapClient(__DIR__ . \"/bug68361.xml\");\n$res = $client->__getTypes(); // Segmentation fault here\nprint_r($res);\n?>")).toMatchSnapshot();
  });
});
