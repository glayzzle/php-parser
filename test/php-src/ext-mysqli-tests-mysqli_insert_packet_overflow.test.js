// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_insert_packet_overflow.phpt
  it("INSERT and packet overflow", function () {
    expect(parser.parseCode("<?php\n    require('connect.inc');\n    if (!$link = my_mysqli_connect($host, $user, $passwd, $db, $port, $socket))\n        printf(\"[001] [%d] %s\\n\", mysqli_connect_errno(), mysqli_connect_error());\n    if (!$res = mysqli_query($link, \"SHOW GLOBAL VARIABLES LIKE 'max_allowed_packet'\"))\n        printf(\"[002] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!$row = mysqli_fetch_assoc($res))\n        printf(\"[003] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    mysqli_free_result($res);\n    if (0 === ($org_max_allowed_packet = (int)$row['Value']))\n        printf(\"[004] Cannot determine max_allowed_packet size and/or bogus max_allowed_packet setting used.\\n\");\n    $max_len = pow(2, 24);\n    if ($org_max_allowed_packet < $max_len) {\n        if (!mysqli_query($link, \"SET GLOBAL max_allowed_packet = \" . ($max_len + 100))) {\n            if (1227 == mysqli_errno($link)) {\n                /* [1227] Access denied; you need the SUPER privilege for this operation */\n                print \"done!\";\n                exit(0);\n            } else {\n                printf(\"[005] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n            }\n        }\n    }\n    mysqli_close($link);\n    if (!$link = my_mysqli_connect($host, $user, $passwd, $db, $port, $socket))\n        printf(\"[006] [%d] %s\\n\", mysqli_connect_errno(), mysqli_connect_error());\n    if (!mysqli_query($link, \"SET NAMES 'latin1'\"))\n        printf(\"[007] [%d] %s\\n\", mysqli_connect_errno(), mysqli_connect_error());\n    if (!$res = mysqli_query($link, \"SHOW GLOBAL VARIABLES LIKE 'max_allowed_packet'\"))\n        printf(\"[008] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!$row = mysqli_fetch_assoc($res))\n        printf(\"[009] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    mysqli_free_result($res);\n    if (0 === ($max_allowed_packet = (int)$row['Value']))\n        printf(\"[010] Cannot determine max_allowed_packet size and/or bogus max_allowed_packet setting used.\\n\");\n    $max_len = pow(2, 24);\n    if ($max_allowed_packet < $max_len) {\n        printf(\"[011] Failed to change max_allowed_packet\");\n    }\n    $table_name = 'test__mysqli_insert_packet_overflow';\n    if (!mysqli_query($link, \"DROP TABLE IF EXISTS {$table_name}\")) {\n        printf(\"[012] Failed to drop old test table: [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    }\n    if (!mysqli_query($link, \"CREATE TABLE {$table_name}(col_blob LONGBLOB) ENGINE=\" . $engine))\n        printf(\"[013] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    $query_prefix = \"INSERT INTO {$table_name}(col_blob) VALUES ('\";\n    $query_postfix = \"')\";\n    $query_len = strlen($query_prefix) + strlen($query_postfix);\n    $com_query_len = 2;\n    $blob = str_repeat('a', $max_len - $com_query_len - $query_len);\n    $query = sprintf(\"%s%s%s\", $query_prefix, $blob, $query_postfix);\n    if (!mysqli_query($link, $query))\n        printf(\"[014] max_allowed_packet = %d, strlen(query) = %d, [%d] %s\\n\", $max_allowed_packet, strlen($query), mysqli_errno($link), mysqli_error($link));\n    if (!$res = mysqli_query($link, \"SELECT col_blob FROM {$table_name}\"))\n        printf(\"[015] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!$row = mysqli_fetch_assoc($res)) {\n        printf(\"[016] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    } else {\n        if ($row['col_blob'] != $blob) {\n            printf(\"[017] Blob seems wrong, dumping data\\n\");\n            var_dump(strlen($row['col_blob']));\n            var_dump(strlen($blob));\n        }\n        mysqli_free_result($res);\n    }\n    if (!mysqli_query($link, \"SET GLOBAL max_allowed_packet = \" . $org_max_allowed_packet))\n        if (1227 != mysqli_errno($link))\n            printf(\"[018] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    mysqli_close($link);\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
