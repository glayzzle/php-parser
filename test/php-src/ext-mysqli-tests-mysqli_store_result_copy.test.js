// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_store_result_copy.phpt
  it("mysqli_store_result()", function () {
    expect(parser.parseCode("<?php\n    require_once(\"connect.inc\");\n    $tmp    = NULL;\n    $link   = NULL;\n    require('table.inc');\n    if (!$res = mysqli_real_query($link, \"SELECT id, label FROM test ORDER BY id\"))\n        printf(\"[003] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!is_object($res = mysqli_store_result($link, MYSQLI_STORE_RESULT_COPY_DATA)))\n        printf(\"[004] Expecting object, got %s/%s. [%d] %s\\n\",\n            gettype($res), $res, mysqli_errno($link), mysqli_error($link));\n    if (true !== ($tmp = mysqli_data_seek($res, 2)))\n        printf(\"[005] Expecting boolean/true, got %s/%s. [%d] %s\\n\",\n            gettype($tmp), $tmp, mysqli_errno($link), mysqli_error($link));\n    var_dump($res->fetch_assoc());\n    if (true !== ($tmp = mysqli_data_seek($res, 0)))\n        printf(\"[006] Expecting boolean/true, got %s/%s. [%d] %s\\n\",\n            gettype($tmp), $tmp, mysqli_errno($link), mysqli_error($link));\n    while ($row = $res->fetch_assoc()) {\n        printf(\"id = %d, label = %s\\n\", $row['id'], $row['label']);\n    }\n    mysqli_free_result($res);\n    mysqli_close($link);\n    if (!$link = my_mysqli_connect($host, $user, $passwd, $db, $port, $socket)) {\n        printf(\"[007] Cannot connect to the server using host=%s, user=%s, passwd=***, dbname=%s, port=%s, socket=%s\\n\",\n            $host, $user, $db, $port, $socket);\n    }\n    if (!$res = mysqli_real_query($link, \"SELECT id, label FROM test ORDER BY id\"))\n        printf(\"[008] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!is_object($res = mysqli_store_result($link, MYSQLI_STORE_RESULT_COPY_DATA)))\n        printf(\"[009] Expecting object, got %s/%s. [%d] %s\\n\",\n            gettype($res), $res, mysqli_errno($link), mysqli_error($link));\n    $no_result = 0;\n    for ($i = 0; $i < 1000; $i++) {\n        $idx = mt_rand(-100, 100);\n        try {\n            if (true === @mysqli_data_seek($res, $idx)) {\n                $row = $res->fetch_assoc();\n                if (!isset($row['id']) || !isset($row['label'])) {\n                    printf(\"[010] Brute force seek %d returned %d\\n\", $idx, var_export($row, true));\n                }\n            } else {\n                $no_result++;\n            }\n        } catch (\\ValueError $e) {\n            $no_result++;\n        }\n    }\n    printf(\"No result: %d\\n\", $no_result);\n    /* implicit free, implicit store */\n    /* meta and fetch lengths code */\n    if (!$res = mysqli_query($link, \"SELECT CONCAT(id, id) AS _c, label FROM test ORDER BY id DESC LIMIT 2\"))\n        printf(\"[011] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    printf(\"Default\\n\");\n    var_dump(mysqli_fetch_lengths($res));\n    $fields = $res->fetch_fields();\n    while ($row = $res->fetch_assoc()) {\n        var_dump(mysqli_fetch_lengths($res));\n    }\n    var_dump(mysqli_fetch_lengths($res));\n    if (!$res = mysqli_real_query($link, \"SELECT CONCAT(id, id) AS _c, label FROM test ORDER BY id DESC LIMIT 2\"))\n        printf(\"[012] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!is_object($res = mysqli_store_result($link, MYSQLI_STORE_RESULT_COPY_DATA)))\n        printf(\"[013] Expecting object, got %s/%s. [%d] %s\\n\",\n            gettype($res), $res, mysqli_errno($link), mysqli_error($link));\n    printf(\"Copy\\n\");\n    var_dump(mysqli_fetch_lengths($res));\n    $fields_copy = $res->fetch_fields();\n    while ($row = $res->fetch_assoc()) {\n        var_dump(mysqli_fetch_lengths($res));\n    }\n    var_dump(mysqli_fetch_lengths($res));\n    /* There's no need for in-depth testing here. If you want in-depth switch mysqlnd\n    globally to copy mode and run all the tests */\n    foreach ($fields as $k => $field_info) {\n        if ($fields_copy[$k] != $field_info) {\n            printf(\"[014] Metadata seems to differ, dumping\\n\");\n            var_dump($field_info);\n            var_dump($fields_copy[$k]);\n        }\n    }\n    /* fetch all */\n    if (!$res = mysqli_real_query($link, \"SELECT id, label FROM test ORDER BY id DESC LIMIT 2\"))\n        printf(\"[015] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!is_object($res = mysqli_store_result($link, MYSQLI_STORE_RESULT_COPY_DATA)))\n        printf(\"[016] Expecting object, got %s/%s. [%d] %s\\n\",\n            gettype($res), $res, mysqli_errno($link), mysqli_error($link));\n    foreach (mysqli_fetch_all($res, MYSQLI_ASSOC) as $row) {\n        printf(\"id = %d label = %s\\n\", $row['id'], $row['label']);\n    }\n    if (!$res = mysqli_real_query($link, \"SELECT id, label FROM test ORDER BY id DESC LIMIT 2\"))\n        printf(\"[017] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!is_object($res = mysqli_store_result($link, MYSQLI_STORE_RESULT_COPY_DATA)))\n        printf(\"[018] Expecting object, got %s/%s. [%d] %s\\n\",\n            gettype($res), $res, mysqli_errno($link), mysqli_error($link));\n    /* provoke out of sync */\n    if (!mysqli_real_query($link, \"SELECT id, label FROM test ORDER BY id DESC LIMIT 2\"))\n        printf(\"[019] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    var_dump($res->fetch_assoc());\n    if (!$res = mysqli_real_query($link, \"SELECT id, label FROM test ORDER BY id ASC LIMIT 2\"))\n        printf(\"[020] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!is_object($res = mysqli_store_result($link, MYSQLI_STORE_RESULT_COPY_DATA)))\n        printf(\"[021] Expecting object, got %s/%s. [%d] %s\\n\",\n            gettype($res), $res, mysqli_errno($link), mysqli_error($link));\n    /* user conn killed, res associated with conn, fetch from res */\n    unset($link);\n    var_dump($res->fetch_assoc());\n    if (!$link = my_mysqli_connect($host, $user, $passwd, $db, $port, $socket)) {\n        printf(\"[022] Cannot connect to the server using host=%s, user=%s, passwd=***, dbname=%s, port=%s, socket=%s\\n\",\n            $host, $user, $db, $port, $socket);\n    }\n    if (!$res = mysqli_real_query($link, \"INSERT INTO test(id, label) VALUES (100, 'z')\"))\n        printf(\"[023] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    mysqli_store_result($link, MYSQLI_STORE_RESULT_COPY_DATA);\n    if (mysqli_get_server_version($link) > 50000) {\n        // let's try to play with stored procedures\n        mysqli_real_query($link, 'DROP PROCEDURE IF EXISTS p');\n        if (mysqli_real_query($link, 'CREATE PROCEDURE p(OUT ver_param VARCHAR(25)) READS SQL DATA BEGIN SELECT id FROM test WHERE id >= 100 ORDER BY id; SELECT id + 1, label FROM test WHERE id > 0 AND id < 3 ORDER BY id; SELECT VERSION() INTO ver_param;\nEND;')) {\n            mysqli_multi_query($link, \"CALL p(@version)\");\n            do {\n                if ($res = $link->store_result(MYSQLI_STORE_RESULT_COPY_DATA)) {\n                    printf(\"---\\n\");\n                    var_dump($res->fetch_all());\n                    $res->free();\n                } else {\n                    if ($link->errno) {\n                        echo \"Store failed: (\" . $link->errno . \") \" . $link->error;\n                    }\n                }\n            } while ($link->more_results() && $link->next_result());\n            mysqli_real_query($link, 'SELECT @version AS p_version');\n            $res = mysqli_store_result($link, MYSQLI_STORE_RESULT_COPY_DATA);\n            $tmp = mysqli_fetch_assoc($res);\n            if (!is_array($tmp) || empty($tmp) || !isset($tmp['p_version']) || ('' == $tmp['p_version'])) {\n                printf(\"[024] Expecting array [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n                var_dump($tmp);\n            }\n            mysqli_free_result($res);\n        } else {\n                printf(\"[025] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        }\n    }\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
