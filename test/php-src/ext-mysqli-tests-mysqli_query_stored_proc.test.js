// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_query_stored_proc.phpt
  it("mysqli_query() - Stored Procedures", function () {
    expect(parser.parseCode("<?php\n    require_once('connect.inc');\n    require_once('table.inc');\n    if (!mysqli_query($link, 'DROP PROCEDURE IF EXISTS p'))\n        printf(\"[001] [%d] %s.\\n\", mysqli_errno($link), mysqli_error($link));\n    if (mysqli_query($link, 'CREATE PROCEDURE p() READS SQL DATA BEGIN SELECT id, label FROM test ORDER BY id ASC;\nEND;')) {\n        /* stored proc which returns one result set */\n        if (mysqli_multi_query($link, 'CALL p()')) {\n            do {\n                if ($res = mysqli_use_result($link)) {\n                    // skip results, don't fetch all from server\n                    var_dump(mysqli_fetch_assoc($res));\n                    mysqli_free_result($res);\n                }\n            } while (mysqli_more_results($link) && mysqli_next_result($link));\n        } else {\n            printf(\"[003] Cannot call SP, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        }\n        if (mysqli_multi_query($link, 'CALL p()')) {\n            do {\n                if ($res = mysqli_store_result($link)) {\n                    // fetch all results from server, but skip on client side\n                    var_dump(mysqli_fetch_assoc($res));\n                    mysqli_free_result($res);\n                }\n            } while (mysqli_more_results($link) && mysqli_next_result($link));\n        } else {\n            printf(\"[004] Cannot call SP, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        }\n        if (mysqli_multi_query($link, 'CALL p()')) {\n            do {\n                if ($res = mysqli_store_result($link)) {\n                    // fetch all results from server, but skip on client side\n                    var_dump(mysqli_fetch_assoc($res));\n                    while (mysqli_fetch_assoc($res))\n                        ;\n                    mysqli_free_result($res);\n                }\n            } while (mysqli_more_results($link) && mysqli_next_result($link));\n        } else {\n            printf(\"[005] Cannot call SP, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        }\n    } else {\n        printf(\"[002] Cannot create SP, [%d] %s.\\n\", mysqli_errno($link), mysqli_error($link));\n    }\n    if (!mysqli_query($link, 'DROP PROCEDURE IF EXISTS p'))\n        printf(\"[006] [%d] %s.\\n\", mysqli_errno($link), mysqli_error($link));\n    if (mysqli_query($link, 'CREATE PROCEDURE p() READS SQL DATA BEGIN SELECT id, label FROM test ORDER BY id ASC; SELECT id FROM test ORDER BY id ASC; END;')) {\n        /* stored proc which returns two result sets */\n        if (mysqli_multi_query($link, 'CALL p()')) {\n            do {\n                if ($res = mysqli_store_result($link)) {\n                    // fetch all results from server, but skip on client side\n                    var_dump(mysqli_fetch_assoc($res));\n                    mysqli_free_result($res);\n                }\n            } while (mysqli_more_results($link) && mysqli_next_result($link));\n        } else {\n            printf(\"[008] Cannot call SP, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        }\n    } else {\n        printf(\"[007] Cannot create SP, [%d] %s.\\n\", mysqli_errno($link), mysqli_error($link));\n    }\n    if (!mysqli_query($link, 'DROP PROCEDURE IF EXISTS p'))\n        printf(\"[009] [%d] %s.\\n\", mysqli_errno($link), mysqli_error($link));\n    if (mysqli_real_query($link, 'CREATE PROCEDURE p(OUT ver_param VARCHAR(25)) BEGIN SELECT VERSION() INTO ver_param; END;')) {\n        /* no result set, just output parameter */\n        if (!mysqli_query($link, 'CALL p(@version)'))\n            printf(\"[011] Cannot call SP, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        if (!mysqli_query($link, \"SET @version = 'unknown'\"))\n            printf(\"[012] Cannot reset user variable, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        if (!mysqli_query($link, 'CALL p(@version)'))\n            printf(\"[013] Cannot call SP, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        if (!$res = mysqli_query($link, 'SELECT @version as _vers'))\n            printf(\"[014] Cannot fetch user variable, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        if (!$row = mysqli_fetch_assoc($res) ||\n                $row['_vers'] == 'unknown')\n            printf(\"[015] Results seem wrong, got %s, [%d] %s\\n\",\n                $row['_vers'],\n                mysqli_errno($link), mysqli_error($link));\n        mysqli_free_result($res);\n    } else {\n        printf(\"[010] Cannot create SP, [%d] %s.\\n\", mysqli_errno($link), mysqli_error($link));\n    }\n    if (!mysqli_query($link, 'DROP PROCEDURE IF EXISTS p'))\n        printf(\"[016] [%d] %s.\\n\", mysqli_errno($link), mysqli_error($link));\n    if (mysqli_real_query($link, 'CREATE PROCEDURE p(IN ver_in VARCHAR(25), OUT ver_out VARCHAR(25)) BEGIN SELECT ver_in INTO ver_out; END;')) {\n        /* no result set, one input, one output parameter */\n        if (!mysqli_query($link, \"CALL p('myversion', @version)\"))\n            printf(\"[018] Cannot call SP, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        if (!mysqli_query($link, \"SET @version = 'unknown'\"))\n            printf(\"[019] Cannot reset user variable, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        if (!mysqli_query($link, \"CALL p('myversion', @version)\"))\n            printf(\"[020] Cannot call SP, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        if (!$res = mysqli_query($link, 'SELECT @version as _vers'))\n            printf(\"[021] Cannot fetch user variable, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        if (!$row = mysqli_fetch_assoc($res) ||\n                $row['_vers'] == 'myversion')\n            printf(\"[022] Results seem wrong, got %s, [%d] %s\\n\",\n                $row['_vers'],\n                mysqli_errno($link), mysqli_error($link));\n        mysqli_free_result($res);\n    } else {\n        printf(\"[017] Cannot create SP, [%d] %s.\\n\", mysqli_errno($link), mysqli_error($link));\n    }\n    mysqli_close($link);\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
