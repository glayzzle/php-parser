// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_get_client_stats.phpt
  it("mysqli_get_client_stats()", function () {
    expect(parser.parseCode("<?php\n    /*\n    TODO\n    no_index_used - difficult to simulate because server/engine dependent\n    bad_index_used - difficult to simulate because server/engine dependent\n    flushed_normal_sets\n    flushed_ps_sets\n    explicit_close\n    implicit_close\n    disconnect_close\n    in_middle_of_command_close\n    explicit_free_result\n    implicit_free_result\n    explicit_stmt_close\n    implicit_stmt_close\n    */\n    function mysqli_get_client_stats_assert_eq($field, $current, $expected, &$test_counter, $desc = \"\") {\n        $test_counter++;\n        if (is_array($current) && is_array($expected)) {\n            if ($current[$field] !== $expected[$field]) {\n                printf(\"[%03d] %s Expecting %s = %s/%s, got %s/%s\\n\",\n                    $test_counter, $desc,\n                    $field, $expected[$field], gettype($expected[$field]),\n                    $current[$field], gettype($current[$field]));\n            }\n        } else if (is_array($current)) {\n            if ($current[$field] !== $expected) {\n                printf(\"[%03d] %s Expecting %s = %s/%s, got %s/%s\\n\",\n                    $test_counter, $desc,\n                    $field, $expected, gettype($expected),\n                    $current[$field], gettype($current[$field]));\n            }\n        } else {\n            if ($current !== $expected) {\n                printf(\"[%03d] %s Expecting %s = %s/%s, got %s/%s\\n\",\n                    $test_counter, $desc,\n                    $field, $expected, gettype($expected),\n                    $current, gettype($current));\n            }\n        }\n    }\n    function mysqli_get_client_stats_assert_gt($field, $current, $expected, &$test_counter, $desc = \"\") {\n        $test_counter++;\n        if (is_array($current) && is_array($expected)) {\n            if ($current[$field] <= $expected[$field]) {\n                printf(\"[%03d] %s Expecting %s > %s/%s, got %s/%s\\n\",\n                    $test_counter, $desc,\n                    $field, $expected[$field], gettype($expected[$field]),\n                    $current[$field], gettype($current[$field]));\n                }\n        } else {\n            if ($current <= $expected) {\n                printf(\"[%03d] %s Expecting %s > %s/%s, got %s/%s\\n\",\n                    $test_counter, $desc, $field,\n                    $expected, gettype($expected),\n                    $current, gettype($current));\n            }\n        }\n    }\n    require_once(\"connect.inc\");\n    if (!is_array($info = mysqli_get_client_stats()) || empty($info))\n        printf(\"[002] Expecting array/any_non_empty, got %s/%s\\n\", gettype($info), $info);\n    var_dump($info);\n    if (!$link = my_mysqli_connect($host, $user, $passwd, $db, $port, $socket)) {\n        printf(\"[003] Cannot connect to the server using host=%s, user=%s, passwd=***, dbname=%s, port=%s, socket=%s\\n\",\n            $host, $user, $db, $port, $socket);\n        exit(1);\n    }\n    if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n        printf(\"[004] Expecting array/any_non_empty, got %s/%s\\n\", gettype($new_info), $new_info);\n    if (count($info) != count($new_info)) {\n        printf(\"[005] Expecting the same number of entries in the arrays\\n\");\n        var_dump($info);\n        var_dump($new_info);\n    }\n    $test_counter = 6;\n    mysqli_get_client_stats_assert_gt('bytes_sent', $new_info, $info, $test_counter);\n    mysqli_get_client_stats_assert_gt('bytes_received', $new_info, $info, $test_counter);\n    mysqli_get_client_stats_assert_gt('packets_sent', $new_info, $info, $test_counter);\n    mysqli_get_client_stats_assert_gt('packets_received', $new_info, $info, $test_counter);\n    mysqli_get_client_stats_assert_gt('protocol_overhead_in', $new_info, $info, $test_counter);\n    mysqli_get_client_stats_assert_gt('protocol_overhead_out', $new_info, $info, $test_counter);\n    // we assume the above as tested and in the following we check only those\n    mysqli_get_client_stats_assert_eq('result_set_queries', $new_info, $info, $test_counter);\n    /* we need to skip this test in unicode - we send set names utf8 during mysql_connect */\n    mysqli_get_client_stats_assert_eq('non_result_set_queries', $new_info, $info, $test_counter);\n    mysqli_get_client_stats_assert_eq('buffered_sets', $new_info, $info, $test_counter);\n    mysqli_get_client_stats_assert_eq('unbuffered_sets', $new_info, $info, $test_counter);\n    mysqli_get_client_stats_assert_eq('ps_buffered_sets', $new_info, $info, $test_counter);\n    mysqli_get_client_stats_assert_eq('ps_unbuffered_sets', $new_info, $info, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_skipped_ps', $new_info, $info, $test_counter);\n    mysqli_get_client_stats_assert_eq('copy_on_write_saved', $new_info, $info, $test_counter);\n    mysqli_get_client_stats_assert_eq('copy_on_write_performed', $new_info, $info, $test_counter);\n    mysqli_get_client_stats_assert_eq('command_buffer_too_small', $new_info, $info, $test_counter);\n    // This is not a mistake that I use string(1) \"1\" here! Andrey did not go for int to avoid any\n    // issues for very large numbers and 32 vs. 64bit systems\n    mysqli_get_client_stats_assert_eq('connect_success', $new_info, \"1\", $test_counter);\n    mysqli_get_client_stats_assert_eq('connect_failure', $new_info, $info, $test_counter);\n    mysqli_get_client_stats_assert_eq('connection_reused', $new_info, $info, $test_counter);\n    // No data fetched so far\n    mysqli_get_client_stats_assert_eq('bytes_received_real_data_normal', $new_info, \"0\", $test_counter);\n    mysqli_get_client_stats_assert_eq('bytes_received_real_data_ps', $new_info, \"0\", $test_counter);\n    require('table.inc');\n    if (!is_array($info = mysqli_get_client_stats()) || empty($info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($info), $info);\n    // fetch stats\n    $expected = $info;\n    // buffered normal\n    print \"Testing buffered normal...\\n\";\n    if (!$res = mysqli_query($link, 'SELECT COUNT(*) AS _num FROM test', MYSQLI_STORE_RESULT))\n        printf(\"[%03d] SELECT COUNT() FROM test failed, [%d] %s\\n\",\n            ++$test_counter, mysqli_errno($link), mysqli_error($link));\n    $expected['rows_fetched_from_server_normal'] = (string)($expected['rows_fetched_from_server_normal'] + 1);\n    $expected['buffered_sets'] = (string)($expected['buffered_sets'] + 1);\n    $expected['result_set_queries'] = (string)($expected['result_set_queries'] + 1);\n    $expected['rows_buffered_from_client_normal'] = (string)($expected['rows_buffered_from_client_normal'] + 1);\n    if (!is_array($info = mysqli_get_client_stats()) || empty($info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($info), $info);\n    mysqli_get_client_stats_assert_gt('bytes_sent', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_gt('bytes_received', $info, $expected, $test_counter);\n    // real_data_* get incremented after mysqli_*fetch*()\n    mysqli_get_client_stats_assert_eq('bytes_received_real_data_normal', $info, \"0\", $test_counter);\n    mysqli_get_client_stats_assert_eq('bytes_received_real_data_ps', $info, \"0\", $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_server_normal', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_client_normal_buffered', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('buffered_sets', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('result_set_queries', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_buffered_from_client_normal', $info, $expected, $test_counter);\n    /* no change to rows_fetched_from_client_normal_buffered! */\n    if (!$row = mysqli_fetch_assoc($res))\n        printf(\"[%03d] fetch_assoc - SELECT COUNT() FROM test failed, [%d] %s\\n\",\n            ++$test_counter, mysqli_errno($link), mysqli_error($link));\n    $expected['rows_fetched_from_client_normal_buffered'] = (string)($expected['rows_fetched_from_client_normal_buffered'] + 1);\n    if (!is_array($info = mysqli_get_client_stats()) || empty($info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($info), $info);\n    // fetch will increment\n    mysqli_get_client_stats_assert_gt('bytes_received_real_data_normal', $info, $expected, $test_counter);\n    $expected['bytes_received_real_data_normal'] = $info['bytes_received_real_data_normal'];\n    mysqli_get_client_stats_assert_eq('bytes_received_real_data_ps', $info, \"0\", $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_server_normal', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_client_normal_buffered', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_buffered_from_client_normal', $info, $expected, $test_counter);\n    $num_rows = $row['_num'];\n    mysqli_free_result($res);\n    print \"Testing buffered normal... - SELECT id, label FROM test\\n\";\n    if (!$res = mysqli_query($link, 'SELECT id, label FROM test', MYSQLI_STORE_RESULT))\n        printf(\"[%03d] SELECT id, label FROM test failed, [%d] %s\\n\",\n            ++$test_counter, mysqli_errno($link), mysqli_error($link));\n    assert(mysqli_num_rows($res) == $num_rows);\n    if (!is_array($info = mysqli_get_client_stats()) || empty($info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($info), $info);\n    $expected['rows_fetched_from_server_normal'] = (string)($expected['rows_fetched_from_server_normal'] + $num_rows);\n    $expected['rows_buffered_from_client_normal'] = (string)($expected['rows_buffered_from_client_normal'] + $num_rows);\n    $expected['buffered_sets'] = (string)($expected['buffered_sets'] + 1);\n    $expected['result_set_queries'] = (string)($expected['result_set_queries'] + 1);\n    mysqli_get_client_stats_assert_eq('bytes_received_real_data_normal', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_server_normal', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_client_normal_buffered', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('buffered_sets', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('result_set_queries', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_buffered_from_client_normal', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_buffered_from_client_normal', $info, $expected, $test_counter);\n    /* fetching none, but stats should not be affected - current implementation */\n    mysqli_free_result($res);\n    if (!is_array($info = mysqli_get_client_stats()) || empty($info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($info), $info);\n    mysqli_get_client_stats_assert_eq('bytes_received_real_data_normal', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_server_normal', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_client_normal_buffered', $info, $expected, $test_counter);\n    print \"Testing unbuffered normal...\\n\";\n    if (!$res = mysqli_query($link, 'SELECT id, label FROM test', MYSQLI_USE_RESULT))\n        printf(\"[%03d] SELECT id, label FROM test failed, [%d] %s\\n\",\n            ++$test_counter, mysqli_errno($link), mysqli_error($link));\n    if (!is_array($info = mysqli_get_client_stats()) || empty($info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($info), $info);\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_server_normal', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_client_normal_unbuffered', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('bytes_received_real_data_normal', $info, $expected, $test_counter);\n    while ($row = mysqli_fetch_assoc($res))\n        ;\n    mysqli_free_result($res);\n    $expected['rows_fetched_from_server_normal'] = (string)($expected['rows_fetched_from_server_normal'] + $num_rows);\n    $expected['rows_fetched_from_client_normal_unbuffered'] = (string)($expected['rows_fetched_from_client_normal_unbuffered'] + $num_rows);\n    $expected['unbuffered_sets'] = (string)($expected['unbuffered_sets'] + 1);\n    $expected['result_set_queries'] = (string)($expected['result_set_queries'] + 1);\n    if (!is_array($info = mysqli_get_client_stats()) || empty($info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($info), $info);\n    mysqli_get_client_stats_assert_gt('bytes_received_real_data_normal', $info, $expected, $test_counter);\n    $expected['bytes_received_real_data_normal'] = $info['bytes_received_real_data_normal'];\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_server_normal', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_client_normal_unbuffered', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('unbuffered_sets', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('result_set_queries', $info, $expected, $test_counter);\n    print \"Testing unbuffered normal... - SELECT id, label FROM test, not all fetched\\n\";\n    if (!$res = mysqli_query($link, 'SELECT id, label FROM test', MYSQLI_USE_RESULT))\n        printf(\"[%03d] SELECT id, label FROM test failed, [%d] %s\\n\",\n            ++$test_counter, mysqli_errno($link), mysqli_error($link));\n    for ($i = 0; $i < $num_rows - 1; $i++)\n        $row = mysqli_fetch_assoc($res);\n    $expected['rows_fetched_from_server_normal'] = (string)($expected['rows_fetched_from_server_normal'] + $num_rows - 1);\n    $expected['rows_fetched_from_client_normal_unbuffered'] = (string)($expected['rows_fetched_from_client_normal_unbuffered'] + $num_rows - 1);\n    $expected['unbuffered_sets'] = (string)($expected['unbuffered_sets'] + 1);\n    $expected['result_set_queries'] = (string)($expected['result_set_queries'] + 1);\n    if (!is_array($info = mysqli_get_client_stats()) || empty($info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($info), $info);\n    mysqli_get_client_stats_assert_gt('bytes_received_real_data_normal', $info, $expected, $test_counter);\n    $expected['bytes_received_real_data_normal'] = $info['bytes_received_real_data_normal'];\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_server_normal', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_client_normal_unbuffered', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('unbuffered_sets', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('result_set_queries', $info, $expected, $test_counter);\n    print \"Testing if implicit fetching and cleaning happens...\\n\";\n    mysqli_free_result($res);\n    /* last row has been implicitly cleaned from the wire by freeing the result set */\n    $expected['rows_fetched_from_server_normal'] = (string)($expected['rows_fetched_from_server_normal'] + 1);\n    $expected['rows_fetched_from_client_normal_unbuffered'] = (string)($expected['rows_fetched_from_client_normal_unbuffered'] + 1);\n    $expected['rows_skipped_normal'] = (string)($info['rows_skipped_normal'] + 1);\n    $expected['flushed_normal_sets'] = (string)($expected['flushed_normal_sets'] + 1);\n    if (!is_array($info = mysqli_get_client_stats()) || empty($info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($info), $info);\n    mysqli_get_client_stats_assert_eq('bytes_received_real_data_normal', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_server_normal', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_client_normal_unbuffered', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_skipped_normal', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('flushed_normal_sets', $info, $expected, $test_counter);\n    print \"Testing buffered Prepared Statements...\\n\";\n    if (!$stmt = mysqli_stmt_init($link))\n        printf(\"[%03d] stmt_init() failed, [%d] %s\\n\",\n            ++$test_counter, mysqli_errno($link), mysqli_error($link));\n    if (!mysqli_stmt_prepare($stmt, 'SELECT id, label FROM test') ||\n            !mysqli_stmt_execute($stmt))\n        printf(\"[%03d] prepare/execute failed, [%d] %s\\n\",\n            ++$test_counter, mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    /* by default PS is unbuffered - no change */\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_server_ps', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_client_ps_buffered', $info, $expected, $test_counter);\n    if (!mysqli_stmt_store_result($stmt))\n        printf(\"[%03d] store_result failed, [%d] %s\\n\",\n            ++$test_counter, mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    mysqli_stmt_free_result($stmt);\n    mysqli_get_client_stats_assert_eq('bytes_received_real_data_ps', $info, \"0\", $test_counter);\n    mysqli_get_client_stats_assert_eq('bytes_received_real_data_normal', $info, $expected, $test_counter);\n    $expected['rows_fetched_from_server_ps'] = (string)($expected['rows_fetched_from_server_ps'] + $num_rows);\n    $expected['result_set_queries'] = (string)($expected['result_set_queries'] + 1);\n    $expected['ps_buffered_sets'] = (string)($expected['ps_buffered_sets'] + 1);\n    $expected['rows_buffered_from_client_ps'] = (string)($expected['rows_buffered_from_client_ps'] + $num_rows);\n    if (!is_array($info = mysqli_get_client_stats()) || empty($info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($info), $info);\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_server_ps', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_client_ps_buffered', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('result_set_queries', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('ps_buffered_sets', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_buffered_from_client_ps', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('bytes_received_real_data_ps', $info, \"0\", $test_counter);\n    print \"Testing buffered Prepared Statements... - fetching all\\n\";\n    if (!mysqli_stmt_prepare($stmt, 'SELECT id, label FROM test') ||\n            !mysqli_stmt_execute($stmt))\n        printf(\"[%03d] prepare/execute failed, [%d] %s\\n\",\n            ++$test_counter, mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $id = $label = null;\n    if (!mysqli_stmt_bind_result($stmt, $id, $label))\n        printf(\"[%03d] bind_result failed, [%d] %s\\n\",\n            ++$test_counter, mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    if (!mysqli_stmt_store_result($stmt))\n        printf(\"[%03d] store_result failed, [%d] %s\\n\",\n            ++$test_counter, mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    while (mysqli_stmt_fetch($stmt))\n        ;\n    $expected['rows_fetched_from_server_ps'] = (string)($expected['rows_fetched_from_server_ps'] + $num_rows);\n    $expected['rows_fetched_from_client_ps_buffered'] = (string)($expected['rows_fetched_from_client_ps_buffered'] + $num_rows);\n    $expected['result_set_queries'] = (string)($expected['result_set_queries'] + 1);\n    $expected['ps_buffered_sets'] = (string)($expected['ps_buffered_sets'] + 1);\n    $expected['rows_buffered_from_client_ps'] = (string)($expected['rows_buffered_from_client_ps'] + $num_rows);\n    if (!is_array($info = mysqli_get_client_stats()) || empty($info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($info), $info);\n    mysqli_get_client_stats_assert_gt('bytes_received_real_data_ps', $info, $expected, $test_counter);\n    $expected['bytes_received_real_data_ps'] = $info['bytes_received_real_data_ps'];\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_server_ps', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_client_ps_buffered', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('result_set_queries', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('ps_buffered_sets', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_buffered_from_client_ps', $info, $expected, $test_counter);\n    mysqli_stmt_free_result($stmt);\n    print \"Testing buffered Prepared Statements... - fetching all but one\\n\";\n    if (!mysqli_stmt_prepare($stmt, 'SELECT id, label FROM test') ||\n            !mysqli_stmt_execute($stmt))\n        printf(\"[%03d] prepare/execute failed, [%d] %s\\n\",\n            ++$test_counter, mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $id = $label = null;\n    if (!mysqli_stmt_bind_result($stmt, $id, $label))\n        printf(\"[%03d] bind_result failed, [%d] %s\\n\",\n            ++$test_counter, mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    if (!mysqli_stmt_store_result($stmt))\n        printf(\"[%03d] store_result failed, [%d] %s\\n\",\n            ++$test_counter, mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    for ($i = 0; $i < $num_rows - 1; $i++)\n        mysqli_stmt_fetch($stmt);\n    $expected['rows_fetched_from_server_ps'] = (string)($expected['rows_fetched_from_server_ps'] + $num_rows);\n    $expected['rows_fetched_from_client_ps_buffered'] = (string)($expected['rows_fetched_from_client_ps_buffered'] + $num_rows - 1);\n    $expected['result_set_queries'] = (string)($expected['result_set_queries'] + 1);\n    $expected['ps_buffered_sets'] = (string)($expected['ps_buffered_sets'] + 1);\n    $expected['rows_buffered_from_client_ps'] = (string)($expected['rows_buffered_from_client_ps'] + $num_rows);\n    if (!is_array($info = mysqli_get_client_stats()) || empty($info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($info), $info);\n    mysqli_get_client_stats_assert_gt('bytes_received_real_data_ps', $info, $expected, $test_counter);\n    $expected['bytes_received_real_data_ps'] = $info['bytes_received_real_data_ps'];\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_server_ps', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_client_ps_buffered', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('result_set_queries', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('ps_buffered_sets', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_buffered_from_client_ps', $info, $expected, $test_counter);\n    $expected['rows_skipped_ps'] = $info['rows_skipped_ps'];\n    mysqli_stmt_free_result($stmt);\n    if (!is_array($info = mysqli_get_client_stats()) || empty($info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($info), $info);\n    /* buffered result set - no skipping possible! */\n    mysqli_get_client_stats_assert_eq('rows_skipped_ps', $info, $expected, $test_counter);\n    print \"Testing unbuffered Prepared Statements... - fetching all\\n\";\n    if (!mysqli_stmt_prepare($stmt, 'SELECT id, label FROM test') ||\n            !mysqli_stmt_execute($stmt))\n        printf(\"[%03d] prepare/execute failed, [%d] %s\\n\",\n            ++$test_counter, mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $id = $label = null;\n    if (!mysqli_stmt_bind_result($stmt, $id, $label))\n        printf(\"[%03d] bind_result failed, [%d] %s\\n\",\n            ++$test_counter, mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $i = 0;\n    while (mysqli_stmt_fetch($stmt))\n        $i++;\n    assert($num_rows = $i);\n    $expected['rows_fetched_from_server_ps'] = (string)($expected['rows_fetched_from_server_ps'] + $num_rows);\n    $expected['rows_fetched_from_client_ps_unbuffered'] = (string)($expected['rows_fetched_from_client_ps_unbuffered'] + $num_rows);\n    $expected['result_set_queries'] = (string)($expected['result_set_queries'] + 1);\n    $expected['ps_unbuffered_sets'] = (string)($expected['ps_unbuffered_sets'] + 1);\n    if (!is_array($info = mysqli_get_client_stats()) || empty($info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($info), $info);\n    mysqli_get_client_stats_assert_gt('bytes_received_real_data_ps', $info, $expected, $test_counter);\n    $expected['bytes_received_real_data_ps'] = $info['bytes_received_real_data_ps'];\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_server_ps', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_client_ps_unbuffered', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('result_set_queries', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('ps_unbuffered_sets', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_buffered_from_client_ps', $info, $expected, $test_counter);\n    mysqli_stmt_free_result($stmt);\n    print \"Testing unbuffered Prepared Statements... - fetching all but one\\n\";\n    if (!mysqli_stmt_prepare($stmt, 'SELECT id, label FROM test') ||\n            !mysqli_stmt_execute($stmt))\n        printf(\"[%03d] prepare/execute failed, [%d] %s\\n\",\n            ++$test_counter, mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    $id = $label = null;\n    if (!mysqli_stmt_bind_result($stmt, $id, $label))\n        printf(\"[%03d] bind_result failed, [%d] %s\\n\",\n            ++$test_counter, mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    for ($i = 0; $i < $num_rows - 1; $i++)\n        mysqli_stmt_fetch($stmt);\n    $expected['rows_fetched_from_server_ps'] = (string)($expected['rows_fetched_from_server_ps'] + $num_rows - 1);\n    $expected['rows_fetched_from_client_ps_unbuffered'] = (string)($expected['rows_fetched_from_client_ps_unbuffered'] + $num_rows - 1);\n    $expected['result_set_queries'] = (string)($expected['result_set_queries'] + 1);\n    $expected['ps_unbuffered_sets'] = (string)($expected['ps_unbuffered_sets'] + 1);\n    if (!is_array($info = mysqli_get_client_stats()) || empty($info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($info), $info);\n    mysqli_get_client_stats_assert_gt('bytes_received_real_data_ps', $info, $expected, $test_counter);\n    $expected['bytes_received_real_data_ps'] = $info['bytes_received_real_data_ps'];\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_server_ps', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_client_ps_unbuffered', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('result_set_queries', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('ps_unbuffered_sets', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_buffered_from_client_ps', $info, $expected, $test_counter);\n    mysqli_stmt_free_result($stmt);\n    $expected['rows_skipped_ps'] = (string)($expected['rows_skipped_ps'] + 1);\n    $expected['flushed_ps_sets'] = (string)($expected['flushed_ps_sets'] + 1);\n    $expected['rows_fetched_from_server_ps'] = (string)($expected['rows_fetched_from_server_ps'] + 1);\n    if (!is_array($info = mysqli_get_client_stats()) || empty($info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($info), $info);\n    mysqli_get_client_stats_assert_eq('bytes_received_real_data_ps', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_skipped_ps', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('flushed_ps_sets', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('rows_fetched_from_server_ps', $info, $expected, $test_counter);\n    /*\n    print \"Checking for normal buffered side effects...\\n\";\n    foreach ($info as $k => $v)\n        if ($info[$k] != $expected[$k])\n            printf(\"$k - $v != %s\\n\", $expected[$k]);\n    */\n    print \"... done with fetch statistics\\n\";\n    if (!is_array($info = mysqli_get_client_stats()) || empty($info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($info), $info);\n    mysqli_get_client_stats_assert_eq('bytes_received_real_data_normal', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('bytes_received_real_data_ps', $info, $expected, $test_counter);\n    //\n    // result_set_queries statistics\n    //\n    if (!is_array($info = mysqli_get_client_stats()) || empty($info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($info), $info);\n    if (!$res = mysqli_query($link, \"SELECT id, label FROM test\"))\n        printf(\"[%03d] SELECT failed, [%d] %s\\n\", ++$test_counter,\n            mysqli_errno($link), mysqli_error($link));\n    $rows = 0;\n    while ($row = mysqli_fetch_assoc($res))\n        $rows++;\n    if (0 == $rows)\n        printf(\"[%03d] Expecting at least one result, [%d] %s\\n\", ++$test_counter,\n            mysqli_errno($link), mysqli_error($link));\n    mysqli_free_result($res);\n    if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($new_info), $new_info);\n    mysqli_get_client_stats_assert_eq('result_set_queries', $new_info, (string)($info['result_set_queries'] + 1), $test_counter);\n    $info = $new_info;\n    mysqli_get_client_stats_assert_gt('bytes_received_real_data_normal', $info, $expected, $test_counter);\n    $expected['bytes_received_real_data_normal'] = $info['bytes_received_real_data_normal'];\n    //\n    // non_result_set_queries - DDL\n    //\n    // CREATE TABLE, DROP TABLE\n    if (!mysqli_query($link, \"DROP TABLE IF EXISTS non_result_set_queries_test\"))\n        printf(\"[%03d] DROP TABLE failed, [%d] %s\\n\", ++$test_counter,\n            mysqli_errno($link), mysqli_error($link));\n    if (!mysqli_query($link, \"CREATE TABLE non_result_set_queries_test(id INT) ENGINE = \" . $engine)) {\n        printf(\"[%03d] CREATE TABLE failed, [%d] %s\\n\", ++$test_counter,\n            mysqli_errno($link), mysqli_error($link));\n    } else {\n        if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n            printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($new_info), $new_info);\n        mysqli_get_client_stats_assert_eq('non_result_set_queries', $new_info, (string)($info['non_result_set_queries'] + 2), $test_counter, 'CREATE/DROP TABLE');\n    }\n    $info = $new_info;\n    // ALERT TABLE\n    if (!mysqli_query($link, \"ALTER TABLE non_result_set_queries_test ADD label CHAR(1)\")) {\n        printf(\"[%03d] ALTER TABLE failed, [%d] %s\\n\", ++$test_counter,\n            mysqli_errno($link), mysqli_error($link));\n    } else {\n        if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n            printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n                ++$test_counter, gettype($new_info), $new_info);\n        mysqli_get_client_stats_assert_eq('non_result_set_queries', $new_info, (string)($info['non_result_set_queries'] + 1), $test_counter, 'ALTER TABLE');\n    }\n    $info = $new_info;\n    // CREATE INDEX, DROP INDEX\n    if (!mysqli_query($link, \"CREATE INDEX idx_1 ON non_result_set_queries_test(id)\")) {\n        printf(\"[%03d] CREATE INDEX failed, [%d] %s\\n\", ++$test_counter,\n            mysqli_errno($link), mysqli_error($link));\n    } else {\n        if (!mysqli_query($link, \"DROP INDEX idx_1 ON non_result_set_queries_test\"))\n            printf(\"[%03d] DROP INDEX failed, [%d] %s\\n\", ++$test_counter,\n                mysqli_errno($link), mysqli_error($link));\n        if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n            printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n                ++$test_counter, gettype($new_info), $new_info);\n        mysqli_get_client_stats_assert_eq('non_result_set_queries', $new_info, (string)($info['non_result_set_queries'] + 2), $test_counter, 'DROP INDEX');\n    }\n    $info = $new_info;\n    // RENAME TABLE\n    if (!mysqli_query($link, \"DROP TABLE IF EXISTS client_stats_test\"))\n        printf(\"[%03d] Cleanup, DROP TABLE client_stats_test failed, [%d] %s\\n\", ++$test_counter,\n            mysqli_errno($link), mysqli_error($link));\n    if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($new_info), $new_info);\n    $info = $new_info;\n    if (!mysqli_query($link, \"RENAME TABLE non_result_set_queries_test TO client_stats_test\")) {\n        printf(\"[%03d] RENAME TABLE failed, [%d] %s\\n\", ++$test_counter,\n            mysqli_errno($link), mysqli_error($link));\n    } else {\n        if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n            printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n                ++$test_counter, gettype($new_info), $new_info);\n        mysqli_get_client_stats_assert_eq('non_result_set_queries', $new_info, (string)($info['non_result_set_queries'] + 1), $test_counter, 'RENAME TABLE');\n    }\n    $info = $new_info;\n    if (!mysqli_query($link, \"DROP TABLE IF EXISTS non_result_set_queries_test\"))\n        printf(\"[%03d] Cleanup, DROP TABLE failed, [%d] %s\\n\", ++$test_counter,\n            mysqli_errno($link), mysqli_error($link));\n    if (!mysqli_query($link, \"DROP TABLE IF EXISTS client_stats_test\"))\n        printf(\"[%03d] Cleanup, DROP TABLE failed, [%d] %s\\n\", ++$test_counter,\n            mysqli_errno($link), mysqli_error($link));\n    // Let's see if we have privileges for CREATE DATABASE\n    mysqli_query($link, \"DROP DATABASE IF EXISTS mysqli_get_client_stats\");\n    if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($new_info), $new_info);\n    $info = $new_info;\n    // CREATE, ALTER, DROP DATABASE\n    if (mysqli_query($link, \"CREATE DATABASE mysqli_get_client_stats\")) {\n        if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n            printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n                ++$test_counter, gettype($new_info), $new_info);\n        mysqli_get_client_stats_assert_eq('non_result_set_queries', $new_info, (string)($info['non_result_set_queries'] + 1), $test_counter, 'CREATE DATABASE');\n        $info = $new_info;\n        if (!mysqli_query($link, \"ALTER DATABASE DEFAULT CHARACTER SET latin1\"))\n            printf(\"[%03d] ALTER DATABASE failed, [%d] %s\\n\", ++$test_counter,\n                mysqli_errno($link), mysqli_error($link));\n        if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n            printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n                ++$test_counter, gettype($new_info), $new_info);\n        mysqli_get_client_stats_assert_eq('non_result_set_queries', $new_info, (string)($info['non_result_set_queries'] + 1), $test_counter, 'CREATE DATABASE');\n        $info = $new_info;\n        if (!mysqli_query($link, \"CREATE DATABASE mysqli_get_client_stats_\"))\n            printf(\"[%03d] CREATE DATABASE failed, [%d] %s\\n\", ++$test_counter,\n                mysqli_errno($link), mysqli_error($link));\n        if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n            printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n                ++$test_counter, gettype($new_info), $new_info);\n        $info = $new_info;\n        if (!mysqli_query($link, \"DROP DATABASE mysqli_get_client_stats_\"))\n            printf(\"[%03d] DROP DATABASE failed, [%d] %s\\n\", ++$test_counter,\n                mysqli_errno($link), mysqli_error($link));\n        if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n            printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n                ++$test_counter, gettype($new_info), $new_info);\n        mysqli_get_client_stats_assert_eq('non_result_set_queries', $new_info, (string)($info['non_result_set_queries'] + 1), $test_counter, 'DROP DATABASE');\n        $info = $new_info;\n    }\n    // CREATE SERVER, ALTER SERVER, DROP SERVER\n    // We don't really try to use federated, we just want to see if the syntax works\n    mysqli_query($link, \"DROP SERVER IF EXISTS myself\");\n    if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($new_info), $new_info);\n    $info = $new_info;\n    $sql = sprintf(\"CREATE SERVER myself FOREIGN DATA WRAPPER mysql OPTIONS (user '%s', password '%s', database '%s')\",\n        $user, $passwd, $db);\n    if (mysqli_query($link, $sql)) {\n        // server knows about it\n        if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n            printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n                ++$test_counter, gettype($new_info), $new_info);\n        mysqli_get_client_stats_assert_eq('non_result_set_queries', $new_info, (string)($info['non_result_set_queries'] + 1), $test_counter, 'CREATE SERVER');\n        $info = $new_info;\n        if (!mysqli_query($link, sprintf(\"ALTER SERVER myself OPTIONS(user '%s_')\", $user)))\n            printf(\"[%03d] ALTER SERVER failed, [%d] %s\\n\", ++$test_counter,\n                mysqli_errno($link), mysqli_error($link));\n        if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n            printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n                ++$test_counter, gettype($new_info), $new_info);\n        mysqli_get_client_stats_assert_eq('non_result_set_queries', $new_info, (string)($info['non_result_set_queries'] + 1), $test_counter, 'ALTER SERVER');\n        $info = $new_info;\n        if (!mysqli_query($link, \"DROP SERVER myself\"))\n            printf(\"[%03d] DROP SERVER failed, [%d] %s\\n\", ++$test_counter,\n                mysqli_errno($link), mysqli_error($link));\n        if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n            printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n                ++$test_counter, gettype($new_info), $new_info);\n        mysqli_get_client_stats_assert_eq('non_result_set_queries', $new_info, (string)($info['non_result_set_queries'] + 1), $test_counter, 'DROP SERVER');\n        $info = $new_info;\n    }\n    mysqli_get_client_stats_assert_eq('bytes_received_real_data_normal', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('bytes_received_real_data_ps', $info, $expected, $test_counter);\n    /*\n    We don't test the NDB ones.\n    13.1. Data Definition Statements\n    13.1.3. ALTER LOGFILE GROUP Syntax\n    13.1.4. ALTER TABLESPACE Syntax\n    13.1.9. CREATE LOGFILE GROUP Syntax\n    13.1.10. CREATE TABLESPACE Syntax\n    13.1.15. DROP LOGFILE GROUP Syntax\n    13.1.16. DROP TABLESPACE Syntax\n    */\n    //\n    // DML\n    //\n    if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n                ++$test_counter, gettype($new_info), $new_info);\n    $info = $new_info;\n    if (!mysqli_query($link, \"INSERT INTO test(id) VALUES (100)\"))\n        printf(\"[%03d] INSERT failed, [%d] %s\\n\", ++$test_counter,\n            mysqli_errno($link), mysqli_error($link));\n    if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($new_info), $new_info);\n    mysqli_get_client_stats_assert_eq('non_result_set_queries', $new_info, (string)($info['non_result_set_queries'] + 1), $test_counter, 'INSERT');\n    $info = $new_info;\n    if (!mysqli_query($link, \"UPDATE test SET label ='z' WHERE id = 100\"))\n        printf(\"[%03d] UPDATE failed, [%d] %s\\n\", ++$test_counter,\n            mysqli_errno($link), mysqli_error($link));\n    if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($new_info), $new_info);\n    mysqli_get_client_stats_assert_eq('non_result_set_queries', $new_info, (string)($info['non_result_set_queries'] + 1), $test_counter, 'UPDATE');\n    $info = $new_info;\n    if (!mysqli_query($link, \"REPLACE INTO test(id, label) VALUES (100, 'b')\"))\n        printf(\"[%03d] INSERT failed, [%d] %s\\n\", ++$test_counter,\n            mysqli_errno($link), mysqli_error($link));\n    if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($new_info), $new_info);\n    mysqli_get_client_stats_assert_eq('non_result_set_queries', $new_info, (string)($info['non_result_set_queries'] + 1), $test_counter, 'REPLACE');\n    $info = $new_info;\n    // NOTE: this will NOT update dbl_ddls counter\n    if (!$res = mysqli_query($link, \"SELECT id, label FROM test WHERE id = 100\"))\n        printf(\"[%03d] SELECT@dml failed, [%d] %s\\n\", ++$test_counter,\n            mysqli_errno($link), mysqli_error($link));\n    mysqli_free_result($res);\n    if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($new_info), $new_info);\n    mysqli_get_client_stats_assert_eq('non_result_set_queries', $new_info, $info, $test_counter, 'SELECT@dml');\n    $info = $new_info;\n    if (!mysqli_query($link, \"DELETE FROM test WHERE id = 100\"))\n        printf(\"[%03d] DELETE failed, [%d] %s\\n\", ++$test_counter,\n            mysqli_errno($link), mysqli_error($link));\n    if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($new_info), $new_info);\n    mysqli_get_client_stats_assert_eq('non_result_set_queries', $new_info, (string)($info['non_result_set_queries'] + 1), $test_counter, 'DELETE');\n    $info = $new_info;\n    if (!$res = mysqli_query($link, \"TRUNCATE TABLE test\"))\n        printf(\"[%03d] TRUNCATE failed, [%d] %s\\n\", ++$test_counter,\n            mysqli_errno($link), mysqli_error($link));\n    if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($new_info), $new_info);\n    mysqli_get_client_stats_assert_eq('non_result_set_queries', $new_info, (string)($info['non_result_set_queries'] + 1), $test_counter, 'TRUNCATE');\n    $info = $new_info;\n    $file = tempnam(sys_get_temp_dir(), 'mysqli_test');\n    if ($fp = fopen($file, 'w')) {\n        @fwrite($fp, '1;\"a\"');\n        fclose($fp);\n        chmod($file, 0644);\n        $sql = sprintf('LOAD DATA LOCAL INFILE \"%s\" INTO TABLE test', mysqli_real_escape_string($link, $file));\n        if (mysqli_query($link, $sql)) {\n            if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n                printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n                    ++$test_counter, gettype($new_info), $new_info);\n            mysqli_get_client_stats_assert_eq('non_result_set_queries', $new_info, (string)($info['non_result_set_queries'] + 1), $test_counter, 'LOAD DATA LOCAL');\n            $info = $new_info;\n        }\n        unlink($file);\n    }\n    mysqli_get_client_stats_assert_eq('bytes_received_real_data_normal', $info, $expected, $test_counter);\n    mysqli_get_client_stats_assert_eq('bytes_received_real_data_ps', $info, $expected, $test_counter);\n    /*\n    We skip those:\n    13.2. Data Manipulation Statements\n    13.2.2. DO Syntax\n    13.2.3. HANDLER Syntax\n    13.2.5. LOAD DATA INFILE Syntax\n    */\n    mysqli_query($link, \"DELETE FROM test\");\n    if (!mysqli_query($link, \"INSERT INTO test(id, label) VALUES (1, 'a'), (2, 'b')\"))\n        printf(\"[%03d] Cannot insert new records, [%d] %s\\n\", ++$test_counter,\n            mysqli_errno($link), mysqli_error($link));\n    if (!$res = mysqli_real_query($link, \"SELECT id, label FROM test ORDER BY id\"))\n        printf(\"[%03d] Cannot SELECT with mysqli_real_query(), [%d] %s\\n\", ++$test_counter,\n            mysqli_errno($link), mysqli_error($link));\n    if (!is_object($res = mysqli_use_result($link)))\n        printf(\"[%03d] mysqli_use_result() failed, [%d] %s\\n\", ++$test_counter,\n            mysqli_errno($link), mysqli_error($link));\n    while ($row = mysqli_fetch_assoc($res))\n        ;\n    mysqli_free_result($res);\n    if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($new_info), $new_info);\n    mysqli_get_client_stats_assert_eq('unbuffered_sets', $new_info, (string)($info['unbuffered_sets'] + 1), $test_counter, 'mysqli_use_result()');\n    $info = $new_info;\n    if (!$res = mysqli_real_query($link, \"SELECT id, label FROM test ORDER BY id\"))\n        printf(\"[%03d] Cannot SELECT with mysqli_real_query() II, [%d] %s\\n\", ++$test_counter,\n            mysqli_errno($link), mysqli_error($link));\n    if (!is_object($res = mysqli_store_result($link)))\n        printf(\"[%03d] mysqli_use_result() failed, [%d] %s\\n\", ++$test_counter,\n            mysqli_errno($link), mysqli_error($link));\n    while ($row = mysqli_fetch_assoc($res))\n        ;\n    mysqli_free_result($res);\n    if (!is_array($new_info = mysqli_get_client_stats()) || empty($new_info))\n        printf(\"[%03d] Expecting array/any_non_empty, got %s/%s\\n\",\n            ++$test_counter, gettype($new_info), $new_info);\n    mysqli_get_client_stats_assert_eq('buffered_sets', $new_info, (string)($info['buffered_sets'] + 1), $test_counter, 'mysqli_use_result()');\n    $info = $new_info;\n    mysqli_close($link);\n    mysqli_get_client_stats_assert_gt('bytes_received_real_data_normal', $info, $expected, $test_counter);\n    $expected['bytes_received_real_data_normal'] = $info['bytes_received_real_data_normal'];\n    mysqli_get_client_stats_assert_eq('bytes_received_real_data_ps', $info, $expected, $test_counter);\n    /*\n    no_index_used\n    bad_index_used\n    flushed_normal_sets\n    flushed_ps_sets\n    explicit_close\n    implicit_close\n    disconnect_close\n    in_middle_of_command_close\n    explicit_free_result\n    implicit_free_result\n    explicit_stmt_close\n    implicit_stmt_close\n    */\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
