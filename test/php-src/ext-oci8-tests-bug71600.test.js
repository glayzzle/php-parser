// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/oci8/tests/bug71600.phpt
  it("Bug #71600 (oci_fetch_all result in segfault when select more than 8 columns)", function () {
    expect(parser.parseCode("<?php\nrequire(__DIR__.'/connect.inc');\n// Initialize\n$stmtarray = array(\n         \"create table bug71600_tab (col1 number, col2 number, col3 number,\n                                     col4 number, col5 number, col6 number,\n                                     col7 number, col8 number, col9 number)\",\n         \"insert into bug71600_tab values(1, 2, 3, 4, 5, 6, 7, 8, 9)\",\n         \"insert into bug71600_tab values(11, 12, 13, 14, 15, 16, 17, 18, 19)\"\n);\noci8_test_sql_execute($c, $stmtarray);\n// Run test\n$sql = \"select col1,col2,col3,col4,col5,col6,col7,col8,col9 from bug71600_tab\";\necho \"Test 1\\n\";\n$stmt = oci_parse($c, $sql);\necho \"Executing SELECT statament...\\n\";\noci_execute($stmt,OCI_DEFAULT);\necho \"Fetching data by columns...\\n\";\noci_fetch_all($stmt, $result);\noci_free_statement($stmt);\n$rsRows=(count($result,1)/($rows = count($result,0)))-1;\necho \"$rsRows Records Found\\n\";\n$rsCount=0;\nwhile($rsCount < $rsRows)\n{\n  $col1   =$result['COL1'][$rsCount];\n  $col9   =$result['COL9'][$rsCount];\n  echo \"$rsCount|$col1|$col9\\n\";\n  $rsCount++;\n}\necho \"Test 2\\n\";\n$stmt = oci_parse($c, $sql);\necho \"Re-executing SELECT statament...\\n\";\noci_execute($stmt,OCI_DEFAULT);\necho \"Fetching data by rows...\\n\";\noci_fetch_all($stmt, $result, 0, -1, OCI_FETCHSTATEMENT_BY_ROW);\noci_free_statement($stmt);\n$rsRows=count($result,0);\necho \"$rsRows Records Found\\n\";\n$rsCount=0;\nwhile($rsCount < $rsRows)\n{\n  $col1 = $result[$rsCount]['COL1'];\n  $col9 = $result[$rsCount]['COL9'];\n  echo \"$rsCount|$col1|$col9\\n\";\n  $rsCount++;\n}\n// Cleanup\n$stmtarray = array(\n    \"drop table bug71600_tab\"\n);\noci8_test_sql_execute($c, $stmtarray);\n?>")).toMatchSnapshot();
  });
});
