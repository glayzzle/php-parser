// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/ldap/tests/ldap_search_sort_controls.phpt
  it("ldap_search() test with sort and VLV controls", function () {
    expect(parser.parseCode("<?php\ninclude \"connect.inc\";\n$link = ldap_connect_and_bind($host, $port, $user, $passwd, $protocol_version);\ninsert_dummy_data($link, $base);\n/* First test with only SORT control */\nvar_dump(\n    $result = ldap_search($link, $base, '(cn=*)', array('cn'), 0, 0, 0, LDAP_DEREF_NEVER,\n        [\n            [\n                'oid' => LDAP_CONTROL_SORTREQUEST,\n                'iscritical' => TRUE,\n                'value' => [\n                    ['attr' => 'cn', 'oid' => '2.5.13.3' /* caseIgnoreOrderingMatch */, 'reverse' => TRUE]\n                ]\n            ]\n        ]\n    ),\n    ldap_get_entries($link, $result),\n    ldap_parse_result($link, $result, $errcode , $matcheddn , $errmsg , $referrals, $controls),\n    $errcode,\n    $errmsg,\n    $controls\n);\n/* Then with VLV control */\nvar_dump(\n    $result = ldap_search($link, $base, '(cn=*)', array('cn'), 0, 0, 0, LDAP_DEREF_NEVER,\n        [\n            [\n                'oid' => LDAP_CONTROL_SORTREQUEST,\n                'iscritical' => TRUE,\n                'value' => [\n                    ['attr' => 'cn', 'oid' => '2.5.13.3' /* caseIgnoreOrderingMatch */, 'reverse' => TRUE]\n                ]\n            ],\n            [\n                'oid' => LDAP_CONTROL_VLVREQUEST,\n                'iscritical' => TRUE,\n                'value' => [\n                    'before'\t=> 0, // Return 0 entry before target\n                    'after'\t\t=> 1, // Return 1 entry after target\n                    'offset'\t=> 2, // Target entry is the second one\n                    'count'\t\t=> 0, // We have no idea how many entries there are\n                ]\n            ]\n        ]\n    ),\n    ldap_get_entries($link, $result),\n    ldap_parse_result($link, $result, $errcode , $matcheddn , $errmsg , $referrals, $controls),\n    array_keys($controls),\n    $controls[LDAP_CONTROL_SORTRESPONSE],\n    $controls[LDAP_CONTROL_VLVRESPONSE]['value']['target'],\n    $controls[LDAP_CONTROL_VLVRESPONSE]['value']['count'],\n    $controls[LDAP_CONTROL_VLVRESPONSE]['value']['errcode'],\n    bin2hex($controls[LDAP_CONTROL_VLVRESPONSE]['value']['context'])\n);\n?>")).toMatchSnapshot();
  });
});
