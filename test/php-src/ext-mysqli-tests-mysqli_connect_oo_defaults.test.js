// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_connect_oo_defaults.phpt
  it("new mysqli()", function () {
    expect(parser.parseCode("<?php\n    require_once(\"connect.inc\");\n    $tmp    = NULL;\n    $link   = NULL;\n    if ($socket != \"\")\n        /* mysqli.default_socket requires non-empty string */\n        ini_set('mysqli.default_socket', 'socket');\n    ini_set('mysqli.default_port', 9999);\n    ini_set('mysqli.default_pw', 'password');\n    ini_set('mysqli.default_user', 'user');\n    ini_set('mysqli.default_host', 'host');\n    mysqli_report(MYSQLI_REPORT_OFF);\n    mysqli_report(MYSQLI_REPORT_STRICT);\n    if ($socket != \"\") {\n        ini_set('mysqli.default_socket', $socket);\n        try {\n            $mysqli = mysqli_init();\n            $mysqli->real_connect($host, $user, $passwd, $db, $port);\n            if (!$res = $mysqli->query(\"SELECT 'mysqli.default_socket' AS testing\"))\n                printf(\"[001] [%d] %s\\n\", $mysqli->errno, $mysqli->error);\n            $tmp = $res->fetch_assoc();\n            $res->free_result();\n            if (!isset($tmp['testing']) || $tmp['testing'] != 'mysqli.default_socket') {\n                printf(\"[002] mysqli.default_socket not properly set?\\n\");\n                var_dump($tmp);\n            }\n            $mysqli->close();\n        } catch (mysqli_sql_exception $e) {\n            printf(\"%s\\n\", $e->getMessage());\n            printf(\"[002] Usage of mysqli.default_socket failed\\n\");\n        }\n    }\n    ini_set('mysqli.default_port', $port);\n    try {\n        $mysqli = mysqli_init();\n        $mysqli->real_connect($host, $user, $passwd, $db);\n        if (!$res = $mysqli->query(\"SELECT 'mysqli.default_port' AS testing\"))\n            printf(\"[003] [%d] %s\\n\", $mysqli->errno, $mysqli->error);\n        var_dump($res->fetch_assoc());\n        $res->free_result();\n        $mysqli->close();\n    } catch (mysqli_sql_exception $e) {\n        printf(\"%s\\n\", $e->getMessage());\n        printf(\"[004] Usage of mysqli.default_port failed\\n\");\n    }\n    ini_set('mysqli.default_pw', $passwd);\n    try {\n        $mysqli = mysqli_init();\n        $mysqli->real_connect($host, $user);\n        $mysqli->select_db($db);\n        if (!$res = $mysqli->query(\"SELECT 'mysqli.default_pw' AS testing\"))\n            printf(\"[005] [%d] %s\\n\", $mysqli->errno, $mysqli->error);\n        var_dump($res->fetch_assoc());\n        $res->free_result();\n        $mysqli->close();\n    } catch (mysqli_sql_exception $e) {\n        printf(\"%s\\n\", $e->getMessage());\n        printf(\"[006] Usage of mysqli.default_pw failed\\n\");\n    }\n    ini_set('mysqli.default_user', $user);\n    try {\n        $mysqli = mysqli_init();\n        $mysqli->real_connect($host);\n        $mysqli->select_db($db);\n        if (!$res = $mysqli->query(\"SELECT 'mysqli.default_user' AS testing\"))\n            printf(\"[007] [%d] %s\\n\", $mysqli->errno, $mysqli->error);\n        var_dump($res->fetch_assoc());\n        $res->free_result();\n        $mysqli->close();\n    } catch (mysqli_sql_exception $e) {\n        printf(\"%s\\n\", $e->getMessage());\n        printf(\"[008] Usage of mysqli.default_user failed\\n\");\n    }\n    ini_set('mysqli.default_host', $host);\n    try {\n        $mysqli = mysqli_init();\n        $mysqli->real_connect();\n        $mysqli->select_db($db);\n        if (!$res = $mysqli->query(\"SELECT 1\"))\n            printf(\"[009] [%d] %s\\n\", $mysqli->errno, $mysqli->error);\n        $res->free_result();\n        if (!$res = $mysqli->query(\"SELECT SUBSTRING_INDEX(USER(),'@',1) AS username\"))\n            printf(\"[010] [%d] %s\\n\", $mysqli->errno, $mysqli->error);\n        $tmp = $res->fetch_assoc();\n        $res->free_result();\n        if ($tmp['username'] !== $user)\n            printf(\"[011] Expecting string/%s, got %s/%s\\n\", $user, gettype($tmp['username']), $tmp['username']);\n        $mysqli->close();\n    } catch (mysqli_sql_exception $e) {\n        printf(\"%s\\n\", $e->getMessage());\n        printf(\"[012] Usage of mysqli.default_host failed\\n\");\n    }\n    try {\n        $link = mysqli_connect($host, $user, $passwd, null, ini_get('mysqli.default_port'));\n        mysqli_select_db($link, $db);\n        if (!$res = mysqli_query($link, \"SELECT 'have been set' AS all_defaults\"))\n            printf(\"[013] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        var_dump(mysqli_fetch_assoc($res));\n        mysqli_free_result($res);\n        mysqli_close($link);\n    } catch (mysqli_sql_exception $e) {\n        printf(\"%s\\n\", $e->getMessage());\n        printf(\"[014] Usage of mysqli_connect() has failed\\n\");\n    }\n    try {\n        $link = mysqli_connect($host, $user, $passwd, null);\n        mysqli_select_db($link, $db);\n        if (!$res = mysqli_query($link, \"SELECT 'have been set' AS all_defaults\"))\n            printf(\"[015] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        var_dump(mysqli_fetch_assoc($res));\n        mysqli_free_result($res);\n        mysqli_close($link);\n    } catch (mysqli_sql_exception $e) {\n        printf(\"%s\\n\", $e->getMessage());\n        printf(\"[016] Usage of mysqli_connect() has failed\\n\");\n    }\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
