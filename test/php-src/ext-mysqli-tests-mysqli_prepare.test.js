// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_prepare.phpt
  it("mysqli_prepare()", function () {
    expect(parser.parseCode("<?php\n    require_once(\"connect.inc\");\n    require('table.inc');\n    if (false !== ($tmp = @mysqli_prepare($link, false)))\n        printf(\"[003] Expecting boolean/false, got %s\\n\", gettype($tmp));\n    if (!$res = mysqli_query($link, \"SELECT id, label FROM test\", MYSQLI_USE_RESULT))\n        printf(\"[004] [%d] %s, next test will fail\\n\", mysqli_errno($link), mysqli_error($link));\n    if (false !== ($tmp = mysqli_prepare($link, 'SELECT id FROM test WHERE id > ?')))\n        printf(\"[005] Expecting boolean/false, got %s, [%d] %s\\n\", gettype($tmp), mysqli_errno($link), mysqli_error($link));\n    mysqli_free_result($res);\n    if (!is_object(($stmt = mysqli_prepare($link, 'SELECT id FROM test'))) || !mysqli_stmt_execute($stmt))\n        printf(\"[006][%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    mysqli_stmt_close($stmt);\n    if (!mysqli_query($link, \"DROP TABLE IF EXISTS test2\"))\n        printf(\"[007] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!is_object(($stmt = mysqli_prepare($link, 'CREATE TABLE test2(id INT) ENGINE =' . $engine))) || !mysqli_stmt_execute($stmt))\n        printf(\"[008] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    mysqli_stmt_close($stmt);\n    if (!is_object(($stmt = mysqli_prepare($link, 'INSERT INTO test2(id) VALUES(?)'))))\n        printf(\"[009] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    $id = 1;\n    if (!mysqli_stmt_bind_param($stmt, 'i', $id) || !mysqli_stmt_execute($stmt))\n        printf(\"[010] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    mysqli_stmt_close($stmt);\n    if (!is_object(($stmt = mysqli_prepare($link, 'REPLACE INTO test2(id) VALUES (?)'))))\n        printf(\"[011] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    $id = 2;\n    if (!mysqli_stmt_bind_param($stmt, 'i', $id) || !mysqli_stmt_execute($stmt))\n        printf(\"[012] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    mysqli_stmt_close($stmt);\n    if (!is_object(($stmt = mysqli_prepare($link, 'UPDATE test2 SET id = ? WHERE id = ?'))))\n        printf(\"[013] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    $id = 3;\n    $where = 2;\n    if (!mysqli_stmt_bind_param($stmt, 'ii', $id, $where) || !mysqli_stmt_execute($stmt))\n        printf(\"[014] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    mysqli_stmt_close($stmt);\n    if (!is_object(($stmt = mysqli_prepare($link, 'DELETE FROM test2 WHERE id = ?'))))\n        printf(\"[015] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    $where = 3;\n    if (!mysqli_stmt_bind_param($stmt, 'i', $where) || !mysqli_stmt_execute($stmt))\n        printf(\"[016] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    mysqli_stmt_close($stmt);\n    if (!is_object(($stmt = mysqli_prepare($link, 'SET @testvar = ?'))))\n        printf(\"[017] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    $testvar = 'testvar';\n    if (!mysqli_stmt_bind_param($stmt, 's', $testvar) || !mysqli_stmt_execute($stmt))\n        printf(\"[018] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    mysqli_stmt_close($stmt);\n    if (!is_object(($stmt = mysqli_prepare($link, \"DO GET_LOCK('testlock', 1)\"))))\n        printf(\"[019] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    mysqli_stmt_close($stmt);\n    if (!is_object(($stmt = mysqli_prepare($link, 'SELECT id, @testvar FROM test2'))))\n        printf(\"[020] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    $id = $testvar = null;\n    if (!mysqli_stmt_execute($stmt) || !mysqli_stmt_bind_result($stmt, $id, $testvar))\n        printf(\"[021] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    while (mysqli_stmt_fetch($stmt)) {\n        if (('testvar' !== $testvar) || (1 !== $id))\n            printf(\"[022] Expecting 'testvar'/1, got %s/%s. [%d] %s\\n\",\n                $testvar, $id, mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n    }\n    var_dump(mysqli_stmt_prepare($stmt, 'SELECT 1; SELECT 2'));\n    mysqli_stmt_close($stmt);\n    mysqli_close($link);\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
