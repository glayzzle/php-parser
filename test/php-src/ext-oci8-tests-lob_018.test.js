// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/oci8/tests/lob_018.phpt
  it("fetching the same lob several times", function () {
    expect(parser.parseCode("<?php\nrequire(__DIR__.'/connect.inc');\n// Initialization\n$stmtarray = array(\n    \"drop table lob_018_tab\",\n    \"create table lob_018_tab (mykey number, lob_1 clob)\",\n);\noci8_test_sql_execute($c, $stmtarray);\necho \"Test 1\\n\";\n$init = \"insert into lob_018_tab (mykey, lob_1) values(1, empty_clob()) returning lob_1 into :mylob\";\n$statement = oci_parse($c, $init);\n$clob = oci_new_descriptor($c, OCI_D_LOB);\noci_bind_by_name($statement, \":mylob\", $clob, -1, OCI_B_CLOB);\noci_execute($statement, OCI_DEFAULT);\n$clob->save(\"data\");\noci_commit($c);\n$init = \"insert into lob_018_tab (mykey, lob_1) values(2, empty_clob()) returning lob_1 into :mylob\";\n$statement = oci_parse($c, $init);\n$clob = oci_new_descriptor($c, OCI_D_LOB);\noci_bind_by_name($statement, \":mylob\", $clob, -1, OCI_B_CLOB);\noci_execute($statement, OCI_DEFAULT);\n$clob->save(\"long data\");\noci_commit($c);\n$query = 'select * from lob_018_tab order by mykey asc';\n$statement = oci_parse ($c, $query);\noci_execute($statement, OCI_DEFAULT);\nwhile ($row = oci_fetch_array($statement, OCI_ASSOC)) {\n    $result = $row['LOB_1']->load();\n    var_dump($result);\n}\necho \"Test 2\\n\";\n$query = 'select * from lob_018_tab order by mykey desc';\n$statement = oci_parse ($c, $query);\noci_execute($statement, OCI_DEFAULT);\nwhile ($row = oci_fetch_array($statement, OCI_ASSOC)) {\n    $result = $row['LOB_1']->load();\n    var_dump($result);\n}\necho \"Test 3 - bind with SQLT_CLOB (an alias for OCI_B_CLOB)\\n\";\n$init = \"insert into lob_018_tab (mykey, lob_1) values(3, empty_clob()) returning lob_1 into :mylob\";\n$statement = oci_parse($c, $init);\n$clob = oci_new_descriptor($c, OCI_D_LOB);\noci_bind_by_name($statement, \":mylob\", $clob, -1, SQLT_CLOB);\noci_execute($statement, OCI_DEFAULT);\n$clob->save(\"more stuff\");\noci_commit($c);\n$query = 'select * from lob_018_tab where mykey = 3';\n$statement = oci_parse ($c, $query);\noci_execute($statement, OCI_DEFAULT);\nwhile ($row = oci_fetch_array($statement, OCI_ASSOC)) {\n    $result = $row['LOB_1']->load();\n    var_dump($result);\n}\n// Cleanup\n$stmtarray = array(\n    \"drop table lob_018_tab\"\n);\noci8_test_sql_execute($c, $stmtarray);\n?>")).toMatchSnapshot();
  });
});
