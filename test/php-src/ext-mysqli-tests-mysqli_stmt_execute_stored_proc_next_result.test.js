// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_stmt_execute_stored_proc_next_result.phpt
  it("mysqli_stmt_execute() - SP, next result", function () {
    expect(parser.parseCode("<?php\n    require_once('connect.inc');\n    if (!$link = my_mysqli_connect($host, $user, $passwd, $db, $port, $socket)) {\n        printf(\"[001] Cannot connect to the server using host=%s, user=%s, passwd=***, dbname=%s, port=%s, socket=%s\\n\",\n          $host, $user, $db, $port, $socket);\n    }\n    if (!mysqli_query($link, 'DROP PROCEDURE IF EXISTS p'))\n        printf(\"[003] [%d] %s.\\n\", mysqli_errno($link), mysqli_error($link));\n    if (mysqli_real_query($link, 'CREATE PROCEDURE p(IN ver_in VARCHAR(25)) BEGIN SELECT ver_in AS _ver_out; END;')) {\n        // one result set\n        if (!$stmt = mysqli_prepare($link, 'CALL p(?)'))\n            printf(\"[005] Cannot prepare CALL, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        $version = 'myversion';\n        if (!mysqli_stmt_bind_param($stmt, 's', $version))\n            printf(\"[006] Cannot bind input parameter, [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        if (!mysqli_stmt_execute($stmt))\n            printf(\"[007] Cannot execute CALL, [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        $version = 'unknown';\n        if (!mysqli_stmt_bind_result($stmt, $version) ||\n                !mysqli_stmt_fetch($stmt))\n            printf(\"[008] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        if ($version !== \"myversion\")\n            printf(\"[009] Results seem wrong, got %s, [%d] %s\\n\",\n                $version,\n                mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        mysqli_stmt_free_result($stmt);\n        printf(\"[010] More results: %s\\n\", (mysqli_more_results($link)) ? \"yes\" : \"no\");\n        printf(\"[011] Next result: %s\\n\", (mysqli_next_result($link)) ? \"yes\" : \"no\");\n        if (!mysqli_stmt_close($stmt))\n            printf(\"[012] Cannot close statement, [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        if (!$link->query(\"SELECT 1\"))\n            printf(\"[013] [%d] %s\\n\", $link->errno, $link->error);\n    } else {\n        printf(\"[004] Cannot create SP, [%d] %s.\\n\", mysqli_errno($link), mysqli_error($link));\n    }\n    if (!mysqli_query($link, 'DROP PROCEDURE IF EXISTS p'))\n        printf(\"[014] [%d] %s.\\n\", mysqli_errno($link), mysqli_error($link));\n    if (mysqli_real_query($link, 'CREATE PROCEDURE p(IN ver_in VARCHAR(25)) BEGIN SELECT ver_in AS _ver_out; SELECT 1 AS _more; END;')) {\n        // two result sets\n        if (!$stmt = mysqli_prepare($link, 'CALL p(?)'))\n            printf(\"[015] Cannot prepare CALL, [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n        $version = 'myversion';\n        if (!mysqli_stmt_bind_param($stmt, 's', $version))\n            printf(\"[016] Cannot bind input parameter, [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        if (!mysqli_stmt_execute($stmt))\n            printf(\"[017] Cannot execute CALL, [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        $version = NULL;\n        if (!mysqli_stmt_bind_result($stmt, $version) ||\n                !mysqli_stmt_fetch($stmt))\n            printf(\"[018] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        if ($version !== \"myversion\")\n            printf(\"[019] Results seem wrong, got %s, [%d] %s\\n\",\n                $version,\n                mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        if (!mysqli_more_results($link) || !mysqli_next_result($link))\n            printf(\"[020] [%d] %s\\n\", $link->errno, $link->error);\n        $more = NULL;\n        if (!mysqli_stmt_bind_result($stmt, $more) ||\n                !mysqli_stmt_fetch($stmt))\n            printf(\"[021] [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        if ($more !== 1)\n            printf(\"[022] Results seem wrong, got %s, [%d] %s\\n\",\n                $more,\n                mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        if (!mysqli_stmt_close($stmt))\n            printf(\"[023] Cannot close statement, [%d] %s\\n\", mysqli_stmt_errno($stmt), mysqli_stmt_error($stmt));\n        if (!$link->query(\"SELECT 1\"))\n            printf(\"[024] [%d] %s\\n\", $link->errno, $link->error);\n    } else {\n        printf(\"[025] Cannot create SP, [%d] %s.\\n\", mysqli_errno($link), mysqli_error($link));\n    }\n    mysqli_close($link);\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
