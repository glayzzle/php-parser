// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_change_user_set_names.phpt
  it("mysqli_change_user() - SET NAMES", function () {
    expect(parser.parseCode("<?php\n    require_once('connect.inc');\n    if (!$link = my_mysqli_connect($host, $user, $passwd, $db, $port, $socket))\n        printf(\"[001] [%d] %s\\n\", mysqli_connect_errno(), mysqli_connect_error());\n    if (!$res = mysqli_query($link, \"SHOW CHARACTER SET LIKE 'latin%'\"))\n        printf(\"[002] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    $charsets = array();\n    while ($row = mysqli_fetch_assoc($res))\n        $charsets[$row['Charset']] = $row['Default collation'];\n    mysqli_free_result($res);\n    if (!mysqli_query($link, 'SET NAMES DEFAULT'))\n        printf(\"[003] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!$res = mysqli_query($link, 'SELECT\n        @@character_set_client AS charset_client,\n        @@character_set_connection AS charset_connection,\n        @@character_set_results AS charset_results,\n        @@collation_connection AS collation_connection,\n        @@collation_database AS collation_database,\n        @@collation_server AS collation_server'))\n        printf(\"[004] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!$defaults = mysqli_fetch_assoc($res))\n        printf(\"[005] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    mysqli_free_result($res);\n    $not_changed = $defaults;\n    foreach ($charsets as $charset => $collation) {\n        if (isset($not_changed['charset_client']) &&\n                $charset != $not_changed['charset_client'] &&\n                mysqli_query($link, sprintf(\"SET @@character_set_client = '%s'\", $charset)))\n            unset($not_changed['charset_client']);\n        if (isset($not_changed['charset_connection']) &&\n                $charset != $not_changed['charset_connection'] &&\n                mysqli_query($link, sprintf(\"SET @@character_connection = '%s'\", $charset)))\n            unset($not_changed['charset_connection']);\n        if (isset($not_changed['charset_results']) &&\n                $charset != $not_changed['charset_results'] &&\n                mysqli_query($link, sprintf(\"SET @@character_set_results = '%s'\", $charset)))\n            unset($not_changed['charset_results']);\n        if (isset($not_changed['collation_connection']) &&\n                $collation != $not_changed['collation_connection'] &&\n                mysqli_query($link, sprintf(\"SET @@collation_connection = '%s'\", $collation)))\n            unset($not_changed['collation_connection']);\n        if (isset($not_changed['collation_database']) &&\n                $collation != $not_changed['collation_database'] &&\n                mysqli_query($link, sprintf(\"SET @@collation_database = '%s'\", $collation)))\n            unset($not_changed['collation_database']);\n        if (isset($not_changed['collation_server']) &&\n                $collation != $not_changed['collation_server'] &&\n                mysqli_query($link, sprintf(\"SET @@collation_server = '%s'\", $collation)))\n            unset($not_changed['collation_server']);\n        if (empty($not_changed))\n            break;\n    }\n    if (!$res = mysqli_query($link, 'SELECT\n        @@character_set_client AS charset_client,\n        @@character_set_connection AS charset_connection,\n        @@character_set_results AS charset_results,\n        @@collation_connection AS collation_connection,\n        @@collation_database AS collation_database,\n        @@collation_server AS collation_server'))\n        printf(\"[006] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!$modified = mysqli_fetch_assoc($res))\n        printf(\"[007] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    mysqli_free_result($res);\n    if ($modified == $defaults)\n        printf(\"[008] Not all settings have been changed\\n\");\n    // LAST_INSERT_ID should be reset\n    mysqli_change_user($link, $user, $passwd, $db);\n    if (!$res = mysqli_query($link, 'SELECT\n        @@character_set_client AS charset_client,\n        @@character_set_connection AS charset_connection,\n        @@character_set_results AS charset_results,\n        @@collation_connection AS collation_connection,\n        @@collation_database AS collation_database,\n        @@collation_server AS collation_server'))\n        printf(\"[009] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    if (!$new = mysqli_fetch_assoc($res))\n        printf(\"[010] [%d] %s\\n\", mysqli_errno($link), mysqli_error($link));\n    mysqli_free_result($res);\n    if ($new == $modified) {\n        printf(\"[011] Charsets/collations have not been reset.\\n\");\n        printf(\"Got:\\n\");\n        var_dump($new);\n        printf(\"Expected:\\n\");\n        var_dump($defaults);\n    }\n    if ($new != $defaults) {\n        printf(\"[012] Charsets/collations have not been reset to their defaults.\\n\");\n        printf(\"Got:\\n\");\n        var_dump($new);\n        printf(\"Expected:\\n\");\n        var_dump($defaults);\n    }\n    if (!is_object($charset = mysqli_get_charset($link)))\n        printf(\"[013] Expecting object/std_class, got %s/%s\\n\", gettype($charset), $charset);\n    if ($charset->charset != $defaults['charset_connection'])\n        printf(\"[014] Expecting connection charset to be %s got %s\\n\",\n            $defaults['charset_connection'],\n            $charset->charset);\n    if ($charset->collation != $defaults['collation_connection'])\n        printf(\"[015] Expecting collation to be %s got %s\\n\",\n            $defaults['collation_connection'],\n            $charset->collation);\n    mysqli_close($link);\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
