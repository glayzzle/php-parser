// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/mysqli/tests/mysqli_pconn_limits.phpt
  it("Persistent connections - limits (-1, unlimited)", function () {
    expect(parser.parseCode("<?php\n    require_once(\"connect.inc\");\n    // opens a regular connection\n    require_once(\"table.inc\");\n    if (!$res = mysqli_query($link, \"SELECT 'works..' as _desc\"))\n        printf(\"[001] Cannot run query, [%d] %s\\n\",\n            mysqli_errno($link), mysqli_error($link));\n    $row = mysqli_fetch_assoc($res);\n    mysqli_free_result($res);\n    printf(\"Regular connection 1 - '%s'\\n\", $row['_desc']);\n    if (!$link2 = my_mysqli_connect($host, $user, $passwd, $db, $port, $socket))\n        printf(\"[002] Cannot open second regular connection, [%d] %s\\n\",\n            mysqli_connect_errno(), mysqli_connect_error());\n    if (!$res = mysqli_query($link2, \"SELECT 'works...' as _desc\"))\n        printf(\"[003] Cannot run query, [%d] %s\\n\",\n            mysqli_errno($link2), mysqli_error($link2));\n    $row = mysqli_fetch_assoc($res);\n    mysqli_free_result($res);\n    printf(\"Regular connection 2 - '%s'\\n\", $row['_desc']);\n    $host = 'p:' . $host;\n    if (!$plink = my_mysqli_connect($host, $user, $passwd, $db, $port, $socket))\n        printf(\"[004] Cannot create persistent connection using host=%s, user=%s, passwd=***, dbname=%s, port=%s, socket=%s, [%d] %s\\n\",\n            $host, $user, $db, $port, $socket,\n            mysqli_connect_errno(), mysqli_connect_error());\n    if (!$res = mysqli_query($plink, \"SELECT 'works...' as _desc\"))\n        printf(\"[005] Cannot run query, [%d] %s\\n\",\n            mysqli_errno($plink), mysqli_error($plink));\n    $row = mysqli_fetch_assoc($res);\n    mysqli_free_result($res);\n    printf(\"Persistent connection 1 - '%s'\\n\", $row['_desc']);\n    if (!$plink2 = my_mysqli_connect($host, $user, $passwd, $db, $port, $socket))\n        printf(\"[006] Cannot create persistent connection using host=%s, user=%s, passwd=***, dbname=%s, port=%s, socket=%s, [%d] %s\\n\",\n            $host, $user, $db, $port, $socket,\n            mysqli_connect_errno(), mysqli_connect_error());\n    if (!$res = mysqli_query($plink2, \"SELECT 'works...' as _desc\"))\n        printf(\"[007] Cannot run query, [%d] %s\\n\",\n            mysqli_errno($plink2), mysqli_error($plink2));\n    $row = mysqli_fetch_assoc($res);\n    mysqli_free_result($res);\n    printf(\"Persistent connection 2 - '%s'\\n\", $row['_desc']);\n    $plink3 = mysqli_init();\n    if (!my_mysqli_real_connect($plink3, $host, $user, $passwd, $db, $port, $socket))\n        printf(\"[008] Cannot create persistent connection using host=%s, user=%s, passwd=***, dbname=%s, port=%s, socket=%s, [%d] %s\\n\",\n            $host, $user, $db, $port, $socket,\n            mysqli_connect_errno(), mysqli_connect_error());\n    if (!$res = mysqli_query($plink3, \"SELECT 'works...' as _desc\"))\n        printf(\"[009] Cannot run query, [%d] %s\\n\",\n            mysqli_errno($plink2), mysqli_error($plink2));\n    $row = mysqli_fetch_assoc($res);\n    mysqli_free_result($res);\n    printf(\"Persistent connection 3 - '%s'\\n\", $row['_desc']);\n    mysqli_close($link);\n    mysqli_close($link2);\n    mysqli_close($plink);\n    mysqli_close($plink2);\n    mysqli_close($plink3);\n    print \"done!\";\n?>")).toMatchSnapshot();
  });
});
