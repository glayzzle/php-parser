// eslint-disable prettier/prettier
const parser = require("../main");

describe("php-src tests", function () {
  // ext/standard/tests/network/setcookie.phpt
  it("setcookie() tests", function () {
    expect(parser.parseCode("<?php\nsetcookie('name');\nsetcookie('name', '');\nsetcookie('name', 'value');\nsetcookie('name', 'space value');\nsetcookie('name', 'value', 0);\nsetcookie('name', 'value', $tsp = time() + 5);\nsetcookie('name', 'value', $tsn = time() - 6);\nsetcookie('name', 'value', $tsc = time());\nsetcookie('name', 'value', 0, '/path/');\nsetcookie('name', 'value', 0, '', 'domain.tld');\nsetcookie('name', 'value', 0, '', '', TRUE);\nsetcookie('name', 'value', 0, '', '', FALSE, TRUE);\nsetcookie('name', 'value', ['expires' => $tsp]);\nsetcookie('name', 'value', ['expires' => $tsn, 'path' => '/path/', 'domain' => 'domain.tld', 'secure' => true, 'httponly' => true, 'samesite' => 'Strict']);\n$expected = array(\n    'Set-Cookie: name=deleted; expires='.date('D, d-M-Y H:i:s', 1).' GMT; Max-Age=0',\n    'Set-Cookie: name=deleted; expires='.date('D, d-M-Y H:i:s', 1).' GMT; Max-Age=0',\n    'Set-Cookie: name=value',\n    'Set-Cookie: name=space%20value',\n    'Set-Cookie: name=value',\n    'Set-Cookie: name=value; expires='.date('D, d-M-Y H:i:s', $tsp).' GMT; Max-Age=5',\n    'Set-Cookie: name=value; expires='.date('D, d-M-Y H:i:s', $tsn).' GMT; Max-Age=0',\n    'Set-Cookie: name=value; expires='.date('D, d-M-Y H:i:s', $tsc).' GMT; Max-Age=0',\n    'Set-Cookie: name=value; path=/path/',\n    'Set-Cookie: name=value; domain=domain.tld',\n    'Set-Cookie: name=value; secure',\n    'Set-Cookie: name=value; HttpOnly',\n    'Set-Cookie: name=value; expires='.date('D, d-M-Y H:i:s', $tsp).' GMT; Max-Age=5',\n    'Set-Cookie: name=value; expires='.date('D, d-M-Y H:i:s', $tsn).' GMT; Max-Age=0; path=/path/; domain=domain.tld; secure; HttpOnly; SameSite=Strict'\n);\n$headers = headers_list();\nif (($i = count($expected)) > count($headers))\n{\n    echo \"Fewer headers are being sent than expected - aborting\";\n    return;\n}\ndo {\n    $header = current($headers);\n    if (strncmp($header, 'Set-Cookie:', 11) !== 0) {\n        continue;\n    }\n    // If the second rolls over between the time() call and the internal time determination by\n    // setcookie(), we might get Max-Age=4 instead of Max-Age=5.\n    $header = str_replace('Max-Age=4', 'Max-Age=5', $header);\n    if ($header === current($expected)) {\n        $i--;\n    } else {\n        echo \"Header mismatch:\\n\\tExpected: \"\n            .current($expected)\n            .\"\\n\\tReceived: \".current($headers).\"\\n\";\n    }\n    next($expected);\n}\nwhile (next($headers) !== FALSE);\necho ($i === 0)\n    ? 'OK'\n    : 'A total of '.$i.' errors found.';\n?>")).toMatchSnapshot();
  });
});
